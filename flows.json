[
    {
        "id": "1e197245.dfdf2e",
        "type": "tab",
        "label": "Get session (W)",
        "disabled": false,
        "info": ""
    },
    {
        "id": "81e3836.4637a8",
        "type": "tab",
        "label": "ЕКБ (W)",
        "disabled": false,
        "info": ""
    },
    {
        "id": "f3825ecf.771b3",
        "type": "tab",
        "label": "Запрос в кошелек (W)",
        "disabled": false,
        "info": ""
    },
    {
        "id": "3b71b008.50e91",
        "type": "tab",
        "label": "СХП (W)",
        "disabled": false,
        "info": ""
    },
    {
        "id": "1e3801f3.ffb9ae",
        "type": "tab",
        "label": "140003",
        "disabled": false,
        "info": ""
    },
    {
        "id": "1cc16612.5125da",
        "type": "tab",
        "label": "REDIS",
        "disabled": false,
        "info": ""
    },
    {
        "id": "3e6d7003.49c1e",
        "type": "tab",
        "label": "Полигон логик",
        "disabled": false,
        "info": ""
    },
    {
        "id": "7a3f5df8.227004",
        "type": "tab",
        "label": "Универсальный: на ЦП ",
        "disabled": false,
        "info": ""
    },
    {
        "id": "da7980eb.de052",
        "type": "tab",
        "label": "Robot TG",
        "disabled": false,
        "info": ""
    },
    {
        "id": "c1799c47.0285e",
        "type": "tab",
        "label": "Лимит после отказа",
        "disabled": false,
        "info": ""
    },
    {
        "id": "ccaa13e5.b3ad3",
        "type": "redis-config",
        "z": "",
        "host": "10.62.152.38",
        "port": "6379",
        "dbase": "0",
        "pass": "BDghEfDlTxKMl"
    },
    {
        "id": "37a72ff5.28cdf",
        "type": "telegram bot",
        "z": "",
        "botname": "",
        "usernames": "",
        "chatids": "",
        "baseapiurl": "",
        "updatemode": "polling",
        "pollinterval": "300",
        "usesocks": false,
        "sockshost": "",
        "socksport": "6667",
        "socksusername": "anonymous",
        "sockspassword": "",
        "bothost": "http://10.56.3.187",
        "localbotport": "1965",
        "publicbotport": "1965",
        "privatekey": "",
        "certificate": "",
        "useselfsignedcertificate": false,
        "verboselogging": false
    },
    {
        "id": "7ca9bc36.8062bc",
        "type": "inject",
        "z": "1e197245.dfdf2e",
        "name": "Генератор запроса",
        "topic": "",
        "payload": "{\"login\":\"\",\"password\":\"\",\"cbUrl\":\"http://10.56.3.187:1965/session\"}",
        "payloadType": "json",
        "repeat": "30",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 140,
        "y": 120,
        "wires": [
            [
                "c5c8d8b.91f2428",
                "1706dfbf.0418a"
            ]
        ]
    },
    {
        "id": "13b9f33d.e3765d",
        "type": "http request",
        "z": "1e197245.dfdf2e",
        "name": "Запрос сессии с CP.PB.UA",
        "method": "POST",
        "ret": "obj",
        "paytoqs": false,
        "url": "https://cp.privatbank.ua/api/1/json/public/193116/cf06cf57032efdfb9f77f083d1a0f89dc81fb771",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 1220,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "20e64615.649f6a",
        "type": "http in",
        "z": "1e197245.dfdf2e",
        "name": "Приемник сессии с ЦП",
        "url": "/session",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 1060,
        "y": 460,
        "wires": [
            [
                "cdeecb55.77bb78",
                "ac9fdb16.1757d8"
            ]
        ]
    },
    {
        "id": "cdeecb55.77bb78",
        "type": "change",
        "z": "1e197245.dfdf2e",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "body",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1260,
        "y": 460,
        "wires": [
            [
                "1c9a9158.d542df"
            ]
        ]
    },
    {
        "id": "1c9a9158.d542df",
        "type": "http response",
        "z": "1e197245.dfdf2e",
        "name": "Ответ",
        "statusCode": "200",
        "headers": {},
        "x": 1430,
        "y": 460,
        "wires": []
    },
    {
        "id": "c16e752b.096e88",
        "type": "function",
        "z": "f3825ecf.771b3",
        "name": "Устанавливаем Headers",
        "func": "msg.payload.sid = global.get(\"body\").SID;\nmsg.headers = {};\nmsg.headers[\"Authorization\"] = global.get(\"body\").SID;\nmsg.headers[\"Accept\"] = \"application/json\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 80,
        "wires": [
            [
                "3819c3f6.0d8e4c"
            ]
        ]
    },
    {
        "id": "5af05c5c.1f6914",
        "type": "http request",
        "z": "f3825ecf.771b3",
        "name": "Запрос в кошелек",
        "method": "GET",
        "ret": "txt",
        "paytoqs": false,
        "url": "https://stat.privatbank.ua/stat/api/purse/module/cardsforwave/byekb/{{client_id}}",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 950,
        "y": 80,
        "wires": [
            [
                "db1d9737.f80cb8"
            ]
        ]
    },
    {
        "id": "3819c3f6.0d8e4c",
        "type": "change",
        "z": "f3825ecf.771b3",
        "name": "Подставляем клиента в URL ",
        "rules": [
            {
                "t": "set",
                "p": "client_id",
                "pt": "msg",
                "to": "payload.client_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 710,
        "y": 80,
        "wires": [
            [
                "5af05c5c.1f6914"
            ]
        ]
    },
    {
        "id": "db1d9737.f80cb8",
        "type": "change",
        "z": "f3825ecf.771b3",
        "name": "Перенесем карты в body ",
        "rules": [
            {
                "t": "set",
                "p": "body.cards",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1170,
        "y": 80,
        "wires": [
            [
                "2657743e.5b1eac"
            ]
        ]
    },
    {
        "id": "14a3e065.4c4c2",
        "type": "http in",
        "z": "f3825ecf.771b3",
        "name": "API: getCardsByEkbId",
        "url": "/cardsByEkbId",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 80,
        "wires": [
            [
                "c16e752b.096e88"
            ]
        ]
    },
    {
        "id": "2657743e.5b1eac",
        "type": "http response",
        "z": "f3825ecf.771b3",
        "name": "Отдаем карты",
        "statusCode": "200",
        "headers": {},
        "x": 1380,
        "y": 80,
        "wires": []
    },
    {
        "id": "12c16dbf.f94492",
        "type": "function",
        "z": "f3825ecf.771b3",
        "name": "Устанавливаем Headers",
        "func": "msg.payload.sid = global.get(\"body\").SID;\nmsg.headers = {};\nmsg.headers[\"Authorization\"] = global.get(\"body\").SID;\nmsg.headers[\"Accept\"] = \"application/json\";\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 140,
        "wires": [
            [
                "daed1cc4.2caf1"
            ]
        ]
    },
    {
        "id": "aa2fe33e.ef5ce",
        "type": "http request",
        "z": "f3825ecf.771b3",
        "name": "Запрос в кошелек",
        "method": "GET",
        "ret": "txt",
        "url": "https://stat.privatbank.ua/stat/api/purse/module/cardsforwave/byekb/{{client_id}}",
        "tls": "",
        "x": 950,
        "y": 140,
        "wires": [
            [
                "fdbc071a.ffc558"
            ]
        ]
    },
    {
        "id": "daed1cc4.2caf1",
        "type": "change",
        "z": "f3825ecf.771b3",
        "name": "Подставляем клиента в URL ",
        "rules": [
            {
                "t": "set",
                "p": "client_id",
                "pt": "msg",
                "to": "payload.client_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 710,
        "y": 140,
        "wires": [
            [
                "aa2fe33e.ef5ce"
            ]
        ]
    },
    {
        "id": "fdbc071a.ffc558",
        "type": "change",
        "z": "f3825ecf.771b3",
        "name": "Перенесем карты в body ",
        "rules": [
            {
                "t": "set",
                "p": "body.cards",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1170,
        "y": 140,
        "wires": [
            [
                "7b49442.c3837bc"
            ]
        ]
    },
    {
        "id": "7b49442.c3837bc",
        "type": "function",
        "z": "f3825ecf.771b3",
        "name": "Функция выбора конкретных карт",
        "func": "msg.body.cards = JSON.parse(msg.body.cards);\nmsg.payload = {};\n//запуск:\n// установка текущей даты (формат: мм/гг)\nvar date = new Date();\nvar curMonth = compare(date.getMonth() + 1);\nvar curYear = date.getFullYear().toString().substr(2);\n\nif(Array.isArray(msg.body.cards)) {\n  msg.payload.prod_arr = product_from_ARR(msg.body.cards);\n  \n  if (msg.payload.prod_arr.length === 0) {\n    var prod_arr_exp = exp_product_from_ARR(msg.body.cards);\n    \n    if (prod_arr_exp.length > 0) {\n      msg.payload.exp_cards = true;\n      msg.payload.prod_arr_exp = prod_arr_exp;\n    }\n    \n  } \n  \n} else {\n msg.payload.description = msg.payload.error;\n msg.payload.err = \"Кошелек\";\n}\n\nmsg.payload.is_GOLD = getFlagGold(msg.body.cards);\n\nif (Array.isArray(msg.payload.prod_arr) && msg.payload.prod_arr.length > 1) msg.payload.prod_arr = msg.payload.prod_arr.sort(compareLimits);\n\n\n//функции:*/\nfunction compare(a){\n\treturn a<10 ? \"0\"+a : a+\"\";\n}\n\nfunction product_from_ARR(cards) {\n\n  var prod_arr = [];\n  var card = {};\n\n  for (var i=0; i<cards.length; i++) {\n  \tif (cards[i].product_type==\"KUN\" && +cards[i].currency==980 && cards[i].bank==\"PB\" && cards[i].isCard3rdFace!=\"Y\" && cards[i].contract_state==\"a\" && (cards[i].card_state==\"1\" || cards[i].card_state==\"5\") && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5) && ((cards[i].exdate.substr(0, 2) >= +curMonth && cards[i].exdate.substr(2) == +curYear)  || (cards[i].exdate.substr(2) > +curYear))) {\n        card = {\n              \"pan\":              cards[i].pan,\n              \"refcontract\":   cards[i].refcontract, \n              \"card_name\":  cards[i].card_name,\n              \"isGold\":          cards[i].isGold,\n              \"balance\":       cards[i].balance,\n              \"card_state\":   cards[i].card_state,\n              \"limit\":             cards[i].credit_limit,\n               \"remain\":        cards[i].remain,\n               \"ledgerbalance\": cards[i].ledgerbalance,\n               \"exdate\": cards[i].exdate\n    \t\t};\n        prod_arr.push(card);\n  \t}\n  }\n  \n  return prod_arr;\n}\n\nfunction exp_product_from_ARR(cards) {\n  var prod_arr = [];\n  var card = {};\n  \n  for (var i=0; i<cards.length; i++) {\n  \tif (cards[i].product_type==\"KUN\" && +cards[i].currency==980 && cards[i].bank==\"PB\" && cards[i].isCard3rdFace!=\"Y\" && cards[i].contract_state==\"a\" && (cards[i].card_state==\"1\" || cards[i].card_state==\"5\") && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5)) {\n        if ( (+curMonth - (+cards[i].exdate.substr(0, 2)) >= 6 && cards[i].exdate.substr(2) == +curYear) || (+curYear - cards[i].exdate.substr(2) > 0 && (+curMonth + (12 - (+cards[i].exdate.substr(0, 2))) >= 6)) ) {\n        \tmsg.body.isEXPIRED = true;\n        }         \n        card = {\n              \"pan\":              cards[i].pan,\n              \"refcontract\":   cards[i].refcontract, \n              \"card_name\":  cards[i].card_name,\n              \"isGold\":          cards[i].isGold,\n              \"balance\":       cards[i].balance,\n              \"card_state\":   cards[i].card_state,\n              \"limit\":             cards[i].credit_limit,\n               \"remain\":        cards[i].remain,\n               \"ledgerbalance\": cards[i].ledgerbalance,\n               \"exdate\": cards[i].exdate\n    \t\t};\n        prod_arr.push(card);\n  \t}\n  }\n  return prod_arr;\n}\n\nfunction compareLimits(a, b) {\n  var A = a.credit_limit;\n  var B = b.credit_limit;\n  \n  return +B - (+A);\n}\n\nfunction getFlagGold(cards) {\n  var prod_arr = [];\n  \n  if (!Array.isArray(cards)) return \"N\";\n  \n  var card = {};\n  \n  for (var i=0; i<cards.length; i++) {\n        if (cards[i].isGold==\"Y\" && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5) && ((cards[i].exdate.substr(0, 2) >= +curMonth && cards[i].exdate.substr(2) == +curYear)  || (cards[i].exdate.substr(2) > +curYear))) {\n        card = {\n              \"pan\":              cards[i].pan,\n              \"refcontract\":   cards[i].refcontract, \n              \"card_name\":  cards[i].card_name,\n              \"isGold\":          cards[i].isGold,\n              \"balance\":       cards[i].balance,\n              \"card_state\":   cards[i].card_state,\n              \"limit\":             cards[i].credit_limit,\n               \"remain\":        cards[i].remain,\n               \"ledgerbalance\": cards[i].ledgerbalance,\n               \"exdate\": cards[i].exdate\n    };\n        prod_arr.push(card);\n        }\n  }\n  if (prod_arr.length > 0) return \"Y\";\n  return \"N\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1440,
        "y": 140,
        "wires": [
            [
                "e3cccdfe.55735"
            ]
        ]
    },
    {
        "id": "1b64f7c3.bcce38",
        "type": "http in",
        "z": "f3825ecf.771b3",
        "name": "API: getCreditCardsByEkbId POST",
        "url": "/creditCardsByEkbId",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 140,
        "wires": [
            [
                "12c16dbf.f94492"
            ]
        ]
    },
    {
        "id": "e3cccdfe.55735",
        "type": "http response",
        "z": "f3825ecf.771b3",
        "name": "Отдаем кредитки",
        "statusCode": "200",
        "headers": {},
        "x": 1690,
        "y": 140,
        "wires": []
    },
    {
        "id": "15279b05.46cf95",
        "type": "http request",
        "z": "81e3836.4637a8",
        "name": "Обращаемся к ЕКБ",
        "method": "POST",
        "ret": "txt",
        "paytoqs": false,
        "url": "https://cis.privatbank.ua/all",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 580,
        "y": 120,
        "wires": [
            [
                "6810106f.276a2"
            ]
        ]
    },
    {
        "id": "7dee2eb.6c15fd",
        "type": "function",
        "z": "81e3836.4637a8",
        "name": "Готовим запрос",
        "func": "var phone = \"+\" + msg.payload.phone.replace(/-| |\\(|\\)|\\+|\\.|\\,/g, \"\");\nmsg.payload = {};\nmsg.payload.r = [];\nvar x = {\n    \"type\":\"INF_NEW\",\n    \"cntr\":\"UA\",\n    \"i\":{\n        \"AllPhone\": phone\n        \n    }, \n    \"t\":{\n        \"returnContact\":\"Y\", \n        \"returnClientAttrs\": \"Y\"\n    },\n    \"sid\": global.get(\"body\").SID,\n    \"o\":[\n        \"ruLName\",\n        \"ruFName\",\n        \"AgentState\",\n        \"ruMName\",\n        \"StrClientID\",\n        \"Lang\",\n        \"Id\",\n        \"PotentialVIP\",\n        \"St\",\n        \"DB\",\n        \"DTS\",\n        \"Sex\"\n        ]\n    \n};\nmsg.payload.r.push(x);\n\nmsg.headers = {};\nmsg.headers[\"Content-type\"] = \"application/json\";\n\nreturn msg;\n\n\n\nfunction phone(p) {\n  var ph = p.replace(/-| |\\(|\\)|\\+|\\.|\\,/g, \"\"); //убираем лишнее\n  return ph;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 380,
        "y": 120,
        "wires": [
            [
                "15279b05.46cf95"
            ]
        ]
    },
    {
        "id": "adecdd8.c86702",
        "type": "http response",
        "z": "81e3836.4637a8",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1040,
        "y": 120,
        "wires": []
    },
    {
        "id": "fbbd4da1.2a985",
        "type": "http in",
        "z": "81e3836.4637a8",
        "name": "API: getClientByPhone",
        "url": "/clientByPhone",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 120,
        "wires": [
            [
                "7dee2eb.6c15fd"
            ]
        ]
    },
    {
        "id": "6810106f.276a2",
        "type": "function",
        "z": "81e3836.4637a8",
        "name": "Формируем данные для ответа",
        "func": "var body = JSON.parse(msg.payload);\n\nvar data = {};\n\ndata.phone = getPhone(body.r[0].INF_NEW);\ndata.name = getFio(body.r[0].INF_NEW);\ndata.client_id = getId(body.r[0].INF_NEW);\ndata.str_client_id = getStrId(body.r[0].INF_NEW);\ngetAllPhones();\ndata.age = getAge(getDb(body.r[0].INF_NEW));\ndata.statusAgent = getAgentStatus(body.r[0].INF_NEW);\ndata.st = getSt(body.r[0].INF_NEW);\ndata.sex = getSex(body.r[0].INF_NEW);\ndata.DTS = getUnix(getDTS(body.r[0].INF_NEW));\ndata.vip = getVip(body.r[0].INF_NEW);\ndata.fio = getFio(body.r[0].INF_NEW);\ndata.client = getJuniorid(body.r[0].INF_NEW);\n\nmsg.payload = data;\n\nreturn msg;\n\n\n\n//=========================\nfunction getAllPhones() {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//забираем телефоны\n  var arr = body.r[0].INF_NEW[0].CONT_INF;\n  data.phones = [];\n  for (var i=0; i<arr.length; i++) {\n      if (arr[i].Type == \"3\") {\n         data.phones.push(arr[i].Number.replace(\"+\", \"\"));\n    }\n  }\n}\n\nfunction Phone(p) {\n  var phone = p.replace(/-| |\\(|\\)|\\+|\\.|\\,/g, \"\"); //убираем лишнее\n  return phone;\n}\n\nfunction getPhone (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"CONT_INF\" in arr[i]) {\n      \tfor (var j=0; j<arr[i][\"CONT_INF\"].length; j++) {\n          if (arr[i][\"CONT_INF\"][j].GroupMain == \"Y\" && arr[i][\"CONT_INF\"][j].Number != \"\" && /\\+380/.test(arr[i][\"CONT_INF\"][j].Number)) return arr[i][\"CONT_INF\"][j].Number;\n        }\n      }\n  \t}\n  }\n}\n\nfunction getFio (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return arr[i][\"INF_NEW\"].ruLName + \" \" + arr[i][\"INF_NEW\"].ruFName + \" \" + arr[i][\"INF_NEW\"].ruMName;\n  \t}\n  }\n}\n\nfunction getStrId (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return arr[i][\"INF_NEW\"].StrClientID;\n  \t}\n  }\n}\n\nfunction getId (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].Id;\n  \t}\n  }\n}\n\nfunction getAge (DB) {\n  var age;\n  var str = DB;\n  if (str == \"null\" || str == \"\" || typeof str == \"undefined\") return \"-\";\n  var b_y = str.substr(0, 4);\n  var b_m = str.substr(5, 2);\n  var b_d = str.substr(8, 2); \n  var Y = new Date().getFullYear();\n  var M = new Date().getMonth()+1;\n  var D = new Date().getDate();\n  \n  if (+b_m > +M) {\n    age = Y - b_y - 1;\t\n  } else {\n  \tif (+b_m == +M && +D < +b_d) {\n  \t\tage = +Y - b_y - 1;\n  \t} else {\n  \t\tage = +Y - b_y;\n  \t}\n  }\n\n  return age;\n}\n\nfunction getSt (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].St;\n  \t}\n  }\n}\n\nfunction getDb (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].DB;\n  \t}\n  }\n}\n\nfunction getAgentStatus(arr) {\n\tif (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"P_CLIENTATTRS\" in arr[i]) {\n      \tvar statuses = arr[i][\"P_CLIENTATTRS\"].filter(function(item) {\n          if (item.AttrTypeId == 70) return item;\n        });\n      return statuses;\n      }\n  \t}\n  }\n}\n\nfunction getName (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return {\"S\": arr[i][\"INF_NEW\"].ruLName, \"N\": arr[i][\"INF_NEW\"].ruFName, \"L\": arr[i][\"INF_NEW\"].ruMName};\n  \t}\n  }\n}\n\nfunction getSex (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") {\n      \tif (arr[i][\"INF_NEW\"].Sex == \"\" || !arr[i][\"INF_NEW\"].Sex || arr[i][\"INF_NEW\"].Sex == \"undefined\") {\n        \tvar SexByRussianName = (function(){\n\n              function SexByRussianName(surname, first_name, patronymic) {\n                this.surname = surname;\n                this.first_name = first_name;\n                this.patronymic = patronymic;\n              };\n\n              SexByRussianName.FEMALE = 0;\n              SexByRussianName.MALE = 1;\n\n              SexByRussianName.SURNAME = 0;\n              SexByRussianName.PATRONYMIC = 1;\n              SexByRussianName.FIRST_NAME = 2;\n\n              SexByRussianName.surname_completions = [\n                ['ова', 'ева', 'ина', 'ая', 'яя', 'екая', 'цкая'],\n                ['ов', 'ев' ,'ин' ,'ын', 'ой', 'цкий', 'ский', 'цкой', 'ской']\n              ];\n              SexByRussianName.names = [\n                ['авдотья', 'аврора', 'агата', 'агния', 'агриппина', 'ада', 'аксинья', 'алевтина', 'александра', 'алёна', 'алена', 'алина', 'алиса', 'алла', 'альбина', 'амалия', 'анастасия', 'ангелина', 'анжела', 'анжелика', 'анна', 'антонина', 'анфиса', 'арина', 'белла', 'божена', 'валентина', 'валерия', 'ванда', 'варвара', 'василина', 'василиса', 'вера', 'вероника', 'виктория', 'виола', 'виолетта', 'вита', 'виталия', 'владислава', 'власта', 'галина', 'глафира', 'дарья', 'диана', 'дина', 'ева', 'евгения', 'евдокия', 'евлампия', 'екатерина', 'елена', 'елизавета', 'ефросиния', 'ефросинья', 'жанна', 'зиновия', 'злата', 'зоя', 'ивонна', 'изольда', 'илона', 'инга', 'инесса', 'инна', 'ирина', 'ия', 'капитолина', 'карина', 'каролина', 'кира', 'клавдия', 'клара', 'клеопатра', 'кристина', 'ксения', 'лада', 'лариса', 'лиана', 'лидия', 'лилия', 'лина', 'лия', 'лора', 'любава', 'любовь', 'людмила', 'майя', 'маргарита', 'марианна', 'мариетта', 'марина', 'мария', 'марья', 'марта', 'марфа', 'марьяна', 'матрёна', 'матрена', 'матрона', 'милена', 'милослава', 'мирослава', 'муза', 'надежда', 'настасия', 'настасья', 'наталия', 'наталья', 'нелли', 'ника', 'нина', 'нинель', 'нонна', 'оксана', 'олимпиада', 'ольга', 'пелагея', 'полина', 'прасковья', 'раиса', 'рената', 'римма', 'роза', 'роксана', 'руфь', 'сарра', 'светлана', 'серафима', 'снежана', 'софья', 'софия', 'стелла', 'степанида', 'стефания', 'таисия', 'таисья', 'тамара', 'татьяна', 'ульяна', 'устиния', 'устинья', 'фаина', 'фёкла', 'фекла', 'феодора', 'хаврония', 'христина', 'эвелина', 'эдита', 'элеонора', 'элла', 'эльвира', 'эмилия', 'эмма', 'юдифь', 'юлиана', 'юлия', 'ядвига', 'яна', 'ярослава'],\n                ['абрам', 'аверьян', 'авраам', 'агафон', 'адам', 'азар', 'акакий', 'аким', 'аксён', 'александр', 'алексей', 'альберт', 'анатолий', 'андрей', 'андрон', 'антип', 'антон', 'аполлон', 'аристарх', 'аркадий', 'арнольд', 'арсений', 'арсентий', 'артем', 'артём', 'артемий', 'артур', 'аскольд', 'афанасий', 'богдан', 'борис', 'борислав', 'бронислав', 'вадим', 'валентин', 'валерий', 'варлам', 'василий', 'венедикт', 'вениамин', 'веньямин', 'венцеслав', 'виктор', 'вилен', 'виталий', 'владилен', 'владимир', 'владислав', 'владлен', 'всеволод', 'всеслав', 'вячеслав', 'гавриил', 'геннадий', 'георгий', 'герман', 'глеб', 'григорий', 'давид', 'даниил', 'данил', 'данила', 'демьян', 'денис', 'димитрий', 'дмитрий', 'добрыня', 'евгений', 'евдоким', 'евсей', 'егор', 'емельян', 'еремей', 'ермолай', 'ерофей', 'ефим', 'захар', 'иван', 'игнат', 'игорь', 'илларион', 'иларион', 'илья', 'иосиф', 'казимир', 'касьян', 'кирилл', 'кондрат', 'константин', 'кузьма', 'лавр', 'лаврентий', 'лазарь', 'ларион', 'лев', 'леонард', 'леонид', 'лука', 'максим', 'марат', 'мартын', 'матвей', 'мефодий', 'мирон', 'михаил', 'моисей', 'назар', 'никита', 'николай', 'олег', 'осип', 'остап', 'павел', 'панкрат', 'пантелей', 'парамон', 'пётр', 'петр', 'платон', 'потап', 'прохор', 'роберт', 'ростислав', 'савва', 'савелий', 'семён', 'семен', 'сергей', 'сидор', 'спартак', 'тарас', 'терентий', 'тимофей', 'тимур', 'тихон', 'ульян', 'фёдор', 'федор', 'федот', 'феликс', 'фирс', 'фома', 'харитон', 'харлам', 'эдуард', 'эммануил', 'эраст', 'юлиан', 'юлий', 'юрий', 'яков', 'ян', 'ярослав']\n              ];\n              SexByRussianName.patronymic_completions = [\n                ['овна', 'евна', 'ична'],\n                ['ович', 'евич', 'ич']\n              ];\n\n              SexByRussianName.prototype.get_gender = function() {\n                var genders_on_names = [this.gender_by(SexByRussianName.SURNAME, this.surname),\n                                        this.gender_by_first_name(),\n                                        this.gender_by(SexByRussianName.PATRONYMIC, this.patronymic)];\n\n                var gender = this.determine_gender(genders_on_names)\n\n                return gender;\n              };\n\n\n              SexByRussianName.prototype.determine_gender = function(genders) {\n                var male = false,\n                    female = false,\n                    gender = undefined;\n\n                for (var i=0; i < 3; i++){\n                  if (genders[i] === SexByRussianName.MALE) male = true;\n                  if (genders[i] === SexByRussianName.FEMALE) female = true;\n                }\n\n                if (male && !female) gender = SexByRussianName.MALE;\n                if (!male && female) gender = SexByRussianName.FEMALE;\n\n                return gender;\n              }\n\n\n              SexByRussianName.prototype.gender_by_first_name = function() {\n                var gender = undefined,\n                    first_name = this.normalize(this.first_name);\n\n                if (this.is_popular_name(first_name, SexByRussianName.FEMALE)) gender = SexByRussianName.FEMALE;\n                if (this.is_popular_name(first_name, SexByRussianName.MALE)) gender = SexByRussianName.MALE;\n\n                return gender;\n              }\n\n              SexByRussianName.prototype.gender_by = function(name_type, string) {\n                var gender = undefined,\n                    name = this.normalize(string);\n\n                if (this.is_correct(name, name_type, SexByRussianName.FEMALE)) gender = SexByRussianName.FEMALE;\n                if (this.is_correct(name, name_type, SexByRussianName.MALE)) gender = SexByRussianName.MALE;\n\n                return gender;\n              }\n\n              SexByRussianName.prototype.is_correct = function(string, type, gender) {\n                var is_correct = false,\n                    completions;\n\n                  switch (type){\n                    case SexByRussianName.SURNAME:\n                      completions = SexByRussianName.surname_completions[gender];\n                      break;\n                    case SexByRussianName.PATRONYMIC:\n                      completions = SexByRussianName.patronymic_completions[gender];\n                  }\n\n                for (var i=0; i<completions.length; i++){\n                  var completion = this.completion(string, completions[i].length);\n                  if (completion === completions[i]) is_correct = true;\n                }\n\n                return is_correct;\n              }\n\n              SexByRussianName.prototype.is_popular_name = function(first_name, gender) {\n                var is_popular_name = false,\n                    names = SexByRussianName.names[gender];\n\n                for (var i=0; i<names.length; i++){\n                  if (first_name === names[i]) is_popular_name = true;\n                }\n\n                return is_popular_name;\n              }\n\n              SexByRussianName.prototype.completion = function(string, count){\n                var completion = string.substr((string.length - count), (string.length - 1));\n\n                return completion;\n              }\n\n              SexByRussianName.prototype.normalize = function(string) {\n                var normal_string = string.toLowerCase();\n                normal_string = normal_string.replace(/\\s/g, '');\n\n                return normal_string;\n              }\n\n              return SexByRussianName;\n            })();\n\n            var name = getName(data.r[0].INF_NEW);\n            var sex_by_russian_name = new SexByRussianName(name.S, name.N, name.L);\n            var sex = sex_by_russian_name.get_gender(); // 1 — мужской, 0 — женский, undefined — не определен.\n            if (sex == \"1\") return \"M\";\n            if (sex == \"0\") return \"F\";\n            if (sex == \"undefined\") return \"-\";\n        }\n        return arr[i][\"INF_NEW\"].Sex;\n      }\n  \t}\n  }\n}\n\nfunction getDTS (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") {\n        return arr[i][\"INF_NEW\"].DTS;\n      }\n  \t}\n  }\n}\n\nfunction getUnix(dateString){\n\tif (dateString == \"\" || typeof dateString == \"undefined\") {\n  \tvar date = new Date().getTime() + \"\";\n    return date.substr(0, 10);\n  } else {\n  \tvar M = +dateString.substr(5, 2) - 1;\n\t\tvar date = new Date(dateString.substr(0, 4), M, dateString.substr(8, 2)).getTime()+\"\";\n  \treturn date.substr(0, 10);\n  }\n}\n\nfunction getVip (arr) {\n  var VIP = \"N\"; \n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i]) {\n        if (arr[i][\"INF_NEW\"].PotentialVIP == \"Y\" || arr[i][\"INF_NEW\"].VipStatus == \"Y\" ) VIP = \"Y\";\n      }\n      if (\"VIP_INF\" in arr[i]) {\n        if (arr[i][\"VIP_INF\"].VipStatus == \"Y\" ) VIP = \"Y\";\n      }\n  \t}\n  }\n  return VIP;\n}\n\nfunction getJuniorid(arr) {\n\tvar client = {};\n\tfor (var i=0; i<arr.length; i++) {\n  \tvar age = getAge(arr[i].INF_NEW.DB);\n  \tif (age < 18) {\n    \tclient.age = age;\n      client.Id = arr[i].INF_NEW.Id;\n      client.fio = arr[i].INF_NEW.ruLName + \" \" + arr[i].INF_NEW.ruFName + \" \" + arr[i].INF_NEW.ruMName;\n    }\n  }\n\treturn client;\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 120,
        "wires": [
            [
                "adecdd8.c86702"
            ]
        ]
    },
    {
        "id": "adbc4db7.cb214",
        "type": "http request",
        "z": "81e3836.4637a8",
        "name": "Обращаемся к ЕКБ",
        "method": "POST",
        "ret": "txt",
        "url": "https://cis.privatbank.ua/all",
        "tls": "",
        "x": 580,
        "y": 180,
        "wires": [
            [
                "26971f0.9e8cce2"
            ]
        ]
    },
    {
        "id": "429eb7b6.aeb9a8",
        "type": "function",
        "z": "81e3836.4637a8",
        "name": "Готовим запрос",
        "func": "var client_id = msg.payload.client_id;\nmsg.payload = {};\nmsg.payload.r = [];\nvar x = {\n    \"type\":\"INF_NEW\",\n    \"cntr\":\"UA\",\n    \"i\":{\n        \"Id\": client_id\n        \n    }, \n    \"t\":{\n        \"returnContact\":\"Y\", \n        \"returnClientAttrs\": \"Y\",\n        \"ReturnFlVip\": \"Y\"\n    },\n    \"sid\": global.get(\"body\").SID,\n    \"o\":[\n        \"ruLName\",\n        \"ruFName\",\n        \"AgentState\",\n        \"ruMName\",\n        \"StrClientID\",\n        \"Lang\",\n        \"Id\",\n        \"PotentialVIP\",\n        \"St\",\n        \"DB\",\n        \"DTS\",\n        \"Sex\"\n        ]\n    \n};\nmsg.payload.r.push(x);\n\nmsg.headers = {};\nmsg.headers[\"Content-type\"] = \"application/json\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 380,
        "y": 180,
        "wires": [
            [
                "adbc4db7.cb214"
            ]
        ]
    },
    {
        "id": "b29bc96e.9ceeb8",
        "type": "http response",
        "z": "81e3836.4637a8",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1040,
        "y": 180,
        "wires": []
    },
    {
        "id": "26971f0.9e8cce2",
        "type": "function",
        "z": "81e3836.4637a8",
        "name": "Формируем данные для ответа",
        "func": "var data = JSON.parse(msg.payload);\n\nvar body = {};\n\nbody.phone = getPhone(data.r[0].INF_NEW);\nbody.name = getFio(data.r[0].INF_NEW);\nbody.client_id = getId(data.r[0].INF_NEW);\nbody.str_client_id = getStrId(data.r[0].INF_NEW);\ngetAllPhones();\nbody.age = getAge(getDb(data.r[0].INF_NEW));\nbody.statusAgent = getAgentStatus(data.r[0].INF_NEW);\nbody.st = getSt(data.r[0].INF_NEW);\nbody.sex = getSex(data.r[0].INF_NEW);\nbody.DTS = getUnix(getDTS(data.r[0].INF_NEW));\nbody.vip = getVip(data.r[0].INF_NEW);\nbody.isVip = getV(data.r);\n\n\nmsg.payload = body;\n\nreturn msg;\n\nfunction getV(arr){\n    var is_VIP; \n    for (var i=0; i<arr.length; i++) {       //берем каждый объект из массива r\n     var obj = arr[i];\n     for (var k in obj) {           // проверяем на совпадение с INF_NEW\n       if ( k == \"INF_NEW\") {\n          is_VIP = obj[k][0].VIP_MANAGER.IsVip;\n        }\n      }              \n    }\n    return is_VIP;\n}\n\nfunction getAllPhones() {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//забираем телефоны\n  var arr = data.r[0].INF_NEW[0].CONT_INF;\n  body.phones = [];\n  for (var i=0; i<arr.length; i++) {\n      if (arr[i].Type == \"3\") {\n         body.phones.push(arr[i].Number.replace(\"+\", \"\"));\n    }\n  }\n}\n\nfunction Phone(p) {\n  var phone = p.replace(/-| |\\(|\\)|\\+|\\.|\\,/g, \"\"); //убираем лишнее\n  return phone;\n}\n\nfunction getPhone (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"CONT_INF\" in arr[i]) {\n      \tfor (var j=0; j<arr[i][\"CONT_INF\"].length; j++) {\n          if (arr[i][\"CONT_INF\"][j].GroupMain == \"Y\" && arr[i][\"CONT_INF\"][j].Number != \"\" && /\\+380/.test(arr[i][\"CONT_INF\"][j].Number)) {\n          \treturn arr[i][\"CONT_INF\"][j].Number;\n          }\n        }\n        //return \"\";\n      }\n  \t}\n  }\n}\n\nfunction getFio (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return arr[i][\"INF_NEW\"].ruLName + \" \" + arr[i][\"INF_NEW\"].ruFName + \" \" + arr[i][\"INF_NEW\"].ruMName;\n  \t}\n  }\n}\n\nfunction getStrId (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return arr[i][\"INF_NEW\"].StrClientID;\n  \t}\n  }\n}\n\nfunction getId (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].Id;\n  \t}\n  }\n}\n\nfunction getAge (DB) {\n  var age;\n  var str = DB;\n  if (str == \"null\" || str == \"\" || typeof str == \"undefined\") return \"-\";\n  var b_y = str.substr(0, 4);\n  var b_m = str.substr(5, 2);\n  var b_d = str.substr(8, 2); \n  var Y = new Date().getFullYear();\n  var M = new Date().getMonth()+1;\n  var D = new Date().getDate();\n  \n  if (+b_m > +M) {\n    age = Y - b_y - 1;\t\n  } else {\n  \tif (+b_m == +M && +D < +b_d) {\n  \t\tage = +Y - b_y - 1;\n  \t} else {\n  \t\tage = +Y - b_y;\n  \t}\n  }\n\n  return age;\n}\n\nfunction getSt (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].St;\n  \t}\n  }\n}\n\nfunction getDb (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].DB;\n  \t}\n  }\n}\n\nfunction getAgentStatus(arr) {\n\tif (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"P_CLIENTATTRS\" in arr[i]) {\n      \tvar statuses = arr[i][\"P_CLIENTATTRS\"].filter(function(item) {\n          if (item.AttrTypeId == 70) return item;\n        });\n      return statuses;\n      }\n  \t}\n  }\n}\n\nfunction getName (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return {\"S\": arr[i][\"INF_NEW\"].ruLName, \"N\": arr[i][\"INF_NEW\"].ruFName, \"L\": arr[i][\"INF_NEW\"].ruMName};\n  \t}\n  }\n}\n\nfunction getSex (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") {\n      \tif (arr[i][\"INF_NEW\"].Sex == \"\" || !arr[i][\"INF_NEW\"].Sex || arr[i][\"INF_NEW\"].Sex == \"undefined\") {\n        \tvar SexByRussianName = (function(){\n\n              function SexByRussianName(surname, first_name, patronymic) {\n                this.surname = surname;\n                this.first_name = first_name;\n                this.patronymic = patronymic;\n              };\n\n              SexByRussianName.FEMALE = 0;\n              SexByRussianName.MALE = 1;\n\n              SexByRussianName.SURNAME = 0;\n              SexByRussianName.PATRONYMIC = 1;\n              SexByRussianName.FIRST_NAME = 2;\n\n              SexByRussianName.surname_completions = [\n                ['ова', 'ева', 'ина', 'ая', 'яя', 'екая', 'цкая'],\n                ['ов', 'ев' ,'ин' ,'ын', 'ой', 'цкий', 'ский', 'цкой', 'ской']\n              ];\n              SexByRussianName.names = [\n                ['авдотья', 'аврора', 'агата', 'агния', 'агриппина', 'ада', 'аксинья', 'алевтина', 'александра', 'алёна', 'алена', 'алина', 'алиса', 'алла', 'альбина', 'амалия', 'анастасия', 'ангелина', 'анжела', 'анжелика', 'анна', 'антонина', 'анфиса', 'арина', 'белла', 'божена', 'валентина', 'валерия', 'ванда', 'варвара', 'василина', 'василиса', 'вера', 'вероника', 'виктория', 'виола', 'виолетта', 'вита', 'виталия', 'владислава', 'власта', 'галина', 'глафира', 'дарья', 'диана', 'дина', 'ева', 'евгения', 'евдокия', 'евлампия', 'екатерина', 'елена', 'елизавета', 'ефросиния', 'ефросинья', 'жанна', 'зиновия', 'злата', 'зоя', 'ивонна', 'изольда', 'илона', 'инга', 'инесса', 'инна', 'ирина', 'ия', 'капитолина', 'карина', 'каролина', 'кира', 'клавдия', 'клара', 'клеопатра', 'кристина', 'ксения', 'лада', 'лариса', 'лиана', 'лидия', 'лилия', 'лина', 'лия', 'лора', 'любава', 'любовь', 'людмила', 'майя', 'маргарита', 'марианна', 'мариетта', 'марина', 'мария', 'марья', 'марта', 'марфа', 'марьяна', 'матрёна', 'матрена', 'матрона', 'милена', 'милослава', 'мирослава', 'муза', 'надежда', 'настасия', 'настасья', 'наталия', 'наталья', 'нелли', 'ника', 'нина', 'нинель', 'нонна', 'оксана', 'олимпиада', 'ольга', 'пелагея', 'полина', 'прасковья', 'раиса', 'рената', 'римма', 'роза', 'роксана', 'руфь', 'сарра', 'светлана', 'серафима', 'снежана', 'софья', 'софия', 'стелла', 'степанида', 'стефания', 'таисия', 'таисья', 'тамара', 'татьяна', 'ульяна', 'устиния', 'устинья', 'фаина', 'фёкла', 'фекла', 'феодора', 'хаврония', 'христина', 'эвелина', 'эдита', 'элеонора', 'элла', 'эльвира', 'эмилия', 'эмма', 'юдифь', 'юлиана', 'юлия', 'ядвига', 'яна', 'ярослава'],\n                ['абрам', 'аверьян', 'авраам', 'агафон', 'адам', 'азар', 'акакий', 'аким', 'аксён', 'александр', 'алексей', 'альберт', 'анатолий', 'андрей', 'андрон', 'антип', 'антон', 'аполлон', 'аристарх', 'аркадий', 'арнольд', 'арсений', 'арсентий', 'артем', 'артём', 'артемий', 'артур', 'аскольд', 'афанасий', 'богдан', 'борис', 'борислав', 'бронислав', 'вадим', 'валентин', 'валерий', 'варлам', 'василий', 'венедикт', 'вениамин', 'веньямин', 'венцеслав', 'виктор', 'вилен', 'виталий', 'владилен', 'владимир', 'владислав', 'владлен', 'всеволод', 'всеслав', 'вячеслав', 'гавриил', 'геннадий', 'георгий', 'герман', 'глеб', 'григорий', 'давид', 'даниил', 'данил', 'данила', 'демьян', 'денис', 'димитрий', 'дмитрий', 'добрыня', 'евгений', 'евдоким', 'евсей', 'егор', 'емельян', 'еремей', 'ермолай', 'ерофей', 'ефим', 'захар', 'иван', 'игнат', 'игорь', 'илларион', 'иларион', 'илья', 'иосиф', 'казимир', 'касьян', 'кирилл', 'кондрат', 'константин', 'кузьма', 'лавр', 'лаврентий', 'лазарь', 'ларион', 'лев', 'леонард', 'леонид', 'лука', 'максим', 'марат', 'мартын', 'матвей', 'мефодий', 'мирон', 'михаил', 'моисей', 'назар', 'никита', 'николай', 'олег', 'осип', 'остап', 'павел', 'панкрат', 'пантелей', 'парамон', 'пётр', 'петр', 'платон', 'потап', 'прохор', 'роберт', 'ростислав', 'савва', 'савелий', 'семён', 'семен', 'сергей', 'сидор', 'спартак', 'тарас', 'терентий', 'тимофей', 'тимур', 'тихон', 'ульян', 'фёдор', 'федор', 'федот', 'феликс', 'фирс', 'фома', 'харитон', 'харлам', 'эдуард', 'эммануил', 'эраст', 'юлиан', 'юлий', 'юрий', 'яков', 'ян', 'ярослав']\n              ];\n              SexByRussianName.patronymic_completions = [\n                ['овна', 'евна', 'ична'],\n                ['ович', 'евич', 'ич']\n              ];\n\n              SexByRussianName.prototype.get_gender = function() {\n                var genders_on_names = [this.gender_by(SexByRussianName.SURNAME, this.surname),\n                                        this.gender_by_first_name(),\n                                        this.gender_by(SexByRussianName.PATRONYMIC, this.patronymic)];\n\n                var gender = this.determine_gender(genders_on_names)\n\n                return gender;\n              };\n\n\n              SexByRussianName.prototype.determine_gender = function(genders) {\n                var male = false,\n                    female = false,\n                    gender = undefined;\n\n                for (var i=0; i < 3; i++){\n                  if (genders[i] === SexByRussianName.MALE) male = true;\n                  if (genders[i] === SexByRussianName.FEMALE) female = true;\n                }\n\n                if (male && !female) gender = SexByRussianName.MALE;\n                if (!male && female) gender = SexByRussianName.FEMALE;\n\n                return gender;\n              }\n\n\n              SexByRussianName.prototype.gender_by_first_name = function() {\n                var gender = undefined,\n                    first_name = this.normalize(this.first_name);\n\n                if (this.is_popular_name(first_name, SexByRussianName.FEMALE)) gender = SexByRussianName.FEMALE;\n                if (this.is_popular_name(first_name, SexByRussianName.MALE)) gender = SexByRussianName.MALE;\n\n                return gender;\n              }\n\n              SexByRussianName.prototype.gender_by = function(name_type, string) {\n                var gender = undefined,\n                    name = this.normalize(string);\n\n                if (this.is_correct(name, name_type, SexByRussianName.FEMALE)) gender = SexByRussianName.FEMALE;\n                if (this.is_correct(name, name_type, SexByRussianName.MALE)) gender = SexByRussianName.MALE;\n\n                return gender;\n              }\n\n              SexByRussianName.prototype.is_correct = function(string, type, gender) {\n                var is_correct = false,\n                    completions;\n\n                  switch (type){\n                    case SexByRussianName.SURNAME:\n                      completions = SexByRussianName.surname_completions[gender];\n                      break;\n                    case SexByRussianName.PATRONYMIC:\n                      completions = SexByRussianName.patronymic_completions[gender];\n                  }\n\n                for (var i=0; i<completions.length; i++){\n                  var completion = this.completion(string, completions[i].length);\n                  if (completion === completions[i]) is_correct = true;\n                }\n\n                return is_correct;\n              }\n\n              SexByRussianName.prototype.is_popular_name = function(first_name, gender) {\n                var is_popular_name = false,\n                    names = SexByRussianName.names[gender];\n\n                for (var i=0; i<names.length; i++){\n                  if (first_name === names[i]) is_popular_name = true;\n                }\n\n                return is_popular_name;\n              }\n\n              SexByRussianName.prototype.completion = function(string, count){\n                var completion = string.substr((string.length - count), (string.length - 1));\n\n                return completion;\n              }\n\n              SexByRussianName.prototype.normalize = function(string) {\n                var normal_string = string.toLowerCase();\n                normal_string = normal_string.replace(/\\s/g, '');\n\n                return normal_string;\n              }\n\n              return SexByRussianName;\n            })();\n\n            var name = getName(data.r[0].INF_NEW);\n            var sex_by_russian_name = new SexByRussianName(name.S, name.N, name.L);\n            var sex = sex_by_russian_name.get_gender(); // 1 — мужской, 0 — женский, undefined — не определен.\n            if (sex == \"1\") return \"M\";\n            if (sex == \"0\") return \"F\";\n            if (sex == \"undefined\") return \"-\";\n        }\n        return arr[i][\"INF_NEW\"].Sex;\n      }\n  \t}\n  }\n}\n\nfunction getDTS (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") {\n        return arr[i][\"INF_NEW\"].DTS;\n      }\n  \t}\n  }\n}\n\nfunction getUnix(dateString){\n\tif (dateString == \"\" || typeof dateString == \"undefined\") {\n  \tvar date = new Date().getTime() + \"\";\n    return date.substr(0, 10);\n  } else {\n  \tvar M = +dateString.substr(5, 2) - 1;\n\t\tvar date = new Date(dateString.substr(0, 4), M, dateString.substr(8, 2)).getTime()+\"\";\n  \treturn date.substr(0, 10);\n  }\n}\n\nfunction getVip (arr) {\n  var VIP = \"N\"; \n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i]) {\n        if (arr[i][\"INF_NEW\"].PotentialVIP == \"Y\" || arr[i][\"INF_NEW\"].VipStatus == \"Y\" ) VIP = \"Y\";\n      }\n      if (\"VIP_INF\" in arr[i]) {\n        if (arr[i][\"VIP_INF\"].VipStatus == \"Y\" ) VIP = \"Y\";\n      }\n  \t}\n  }\n  return VIP;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 180,
        "wires": [
            [
                "b29bc96e.9ceeb8"
            ]
        ]
    },
    {
        "id": "9ebca547.80cfb8",
        "type": "http in",
        "z": "81e3836.4637a8",
        "name": "API: getClientByEkbId (POST)",
        "url": "/clientInfo",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 180,
        "wires": [
            [
                "429eb7b6.aeb9a8"
            ]
        ]
    },
    {
        "id": "4a499c61.9c5444",
        "type": "http in",
        "z": "f3825ecf.771b3",
        "name": "API: getCreditCardsByEkbId GET",
        "url": "/creditCardsByEkbId",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 200,
        "wires": [
            [
                "8b34fd20.e8c1"
            ]
        ]
    },
    {
        "id": "8b34fd20.e8c1",
        "type": "function",
        "z": "f3825ecf.771b3",
        "name": "Устанавливаем Headers",
        "func": "msg.payload.sid = global.get(\"body\").SID;\nmsg.headers = {};\nmsg.headers[\"Authorization\"] = global.get(\"body\").SID;\nmsg.headers[\"Accept\"] = \"application/json\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 200,
        "wires": [
            [
                "5eaca925.caf8d8"
            ]
        ]
    },
    {
        "id": "5eaca925.caf8d8",
        "type": "change",
        "z": "f3825ecf.771b3",
        "name": "Подставляем клиента в URL ",
        "rules": [
            {
                "t": "set",
                "p": "client_id",
                "pt": "msg",
                "to": "payload.client_id",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 710,
        "y": 200,
        "wires": [
            [
                "16dc3587.713a7a"
            ]
        ]
    },
    {
        "id": "16dc3587.713a7a",
        "type": "http request",
        "z": "f3825ecf.771b3",
        "name": "Запрос в кошелек",
        "method": "GET",
        "ret": "txt",
        "url": "https://stat.privatbank.ua/stat/api/purse/module/cardsforwave/byekb/{{client_id}}",
        "tls": "",
        "x": 950,
        "y": 200,
        "wires": [
            [
                "59970024.75da7"
            ]
        ]
    },
    {
        "id": "59970024.75da7",
        "type": "change",
        "z": "f3825ecf.771b3",
        "name": "Перенесем карты в body ",
        "rules": [
            {
                "t": "set",
                "p": "body.cards",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1170,
        "y": 200,
        "wires": [
            [
                "61a6445e.79064c"
            ]
        ]
    },
    {
        "id": "61a6445e.79064c",
        "type": "function",
        "z": "f3825ecf.771b3",
        "name": "Функция выбора конкретных карт",
        "func": "msg.body.cards = JSON.parse(msg.body.cards);\nmsg.payload = {};\n//запуск:\n// установка текущей даты (формат: мм/гг)\nvar date = new Date();\nvar curMonth = compare(date.getMonth() + 1);\nvar curYear = date.getFullYear().toString().substr(2);\n\nif(Array.isArray(msg.body.cards)) {\n  msg.payload.prod_arr = product_from_ARR(msg.body.cards);\n  \n  if (msg.payload.prod_arr.length === 0) {\n    var prod_arr_exp = exp_product_from_ARR(msg.body.cards);\n    \n    if (prod_arr_exp.length > 0) {\n      msg.payload.exp_cards = true;\n      msg.payload.prod_arr_exp = prod_arr_exp;\n    }\n    \n  } \n  \n} else {\n msg.payload.description = msg.payload.error;\n msg.payload.err = \"Кошелек\";\n}\n\nmsg.payload.is_GOLD = getFlagGold(msg.body.cards);\n\nif (Array.isArray(msg.payload.prod_arr) && msg.payload.prod_arr.length > 1) msg.payload.prod_arr = msg.payload.prod_arr.sort(compareLimits);\n\n\n//функции:*/\nfunction compare(a){\n\treturn a<10 ? \"0\"+a : a+\"\";\n}\n\nfunction product_from_ARR(cards) {\n\n  var prod_arr = [];\n  var card = {};\n\n  for (var i=0; i<cards.length; i++) {\n  \tif (cards[i].product_type==\"KUN\" && +cards[i].currency==980 && cards[i].bank==\"PB\" && cards[i].isCard3rdFace!=\"Y\" && cards[i].contract_state==\"a\" && (cards[i].card_state==\"1\" || cards[i].card_state==\"5\") && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5) && ((cards[i].exdate.substr(0, 2) >= +curMonth && cards[i].exdate.substr(2) == +curYear)  || (cards[i].exdate.substr(2) > +curYear))) {\n        card = {\n              \"pan\":              cards[i].pan,\n              \"refcontract\":   cards[i].refcontract, \n              \"card_name\":  cards[i].card_name,\n              \"isGold\":          cards[i].isGold,\n              \"balance\":       cards[i].balance,\n              \"card_state\":   cards[i].card_state,\n              \"limit\":             cards[i].credit_limit,\n               \"remain\":        cards[i].remain,\n               \"ledgerbalance\": cards[i].ledgerbalance,\n               \"exdate\": cards[i].exdate\n    \t\t};\n        prod_arr.push(card);\n  \t}\n  }\n  \n  return prod_arr;\n}\n\nfunction exp_product_from_ARR(cards) {\n  var prod_arr = [];\n  var card = {};\n  \n  for (var i=0; i<cards.length; i++) {\n  \tif (cards[i].product_type==\"KUN\" && +cards[i].currency==980 && cards[i].bank==\"PB\" && cards[i].isCard3rdFace!=\"Y\" && cards[i].contract_state==\"a\" && (cards[i].card_state==\"1\" || cards[i].card_state==\"5\") && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5)) {\n        if ( (+curMonth - (+cards[i].exdate.substr(0, 2)) >= 6 && cards[i].exdate.substr(2) == +curYear) || (+curYear - cards[i].exdate.substr(2) > 0 && (+curMonth + (12 - (+cards[i].exdate.substr(0, 2))) >= 6)) ) {\n        \tmsg.body.isEXPIRED = true;\n        }         \n        card = {\n              \"pan\":              cards[i].pan,\n              \"refcontract\":   cards[i].refcontract, \n              \"card_name\":  cards[i].card_name,\n              \"isGold\":          cards[i].isGold,\n              \"balance\":       cards[i].balance,\n              \"card_state\":   cards[i].card_state,\n              \"limit\":             cards[i].credit_limit,\n               \"remain\":        cards[i].remain,\n               \"ledgerbalance\": cards[i].ledgerbalance,\n               \"exdate\": cards[i].exdate\n    \t\t};\n        prod_arr.push(card);\n  \t}\n  }\n  return prod_arr;\n}\n\nfunction compareLimits(a, b) {\n  var A = a.credit_limit;\n  var B = b.credit_limit;\n  \n  return +B - (+A);\n}\n\nfunction getFlagGold(cards) {\n  var prod_arr = [];\n  \n  if (!Array.isArray(cards)) return \"N\";\n  \n  var card = {};\n  \n  for (var i=0; i<cards.length; i++) {\n        if (cards[i].isGold==\"Y\" && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5) && ((cards[i].exdate.substr(0, 2) >= +curMonth && cards[i].exdate.substr(2) == +curYear)  || (cards[i].exdate.substr(2) > +curYear))) {\n        card = {\n              \"pan\":              cards[i].pan,\n              \"refcontract\":   cards[i].refcontract, \n              \"card_name\":  cards[i].card_name,\n              \"isGold\":          cards[i].isGold,\n              \"balance\":       cards[i].balance,\n              \"card_state\":   cards[i].card_state,\n              \"limit\":             cards[i].credit_limit,\n               \"remain\":        cards[i].remain,\n               \"ledgerbalance\": cards[i].ledgerbalance,\n               \"exdate\": cards[i].exdate\n    };\n        prod_arr.push(card);\n        }\n  }\n  if (prod_arr.length > 0) return \"Y\";\n  return \"N\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1440,
        "y": 200,
        "wires": [
            [
                "e3f0e1b7.9f82b"
            ]
        ]
    },
    {
        "id": "e3f0e1b7.9f82b",
        "type": "http response",
        "z": "f3825ecf.771b3",
        "name": "Отдаем кредитки",
        "statusCode": "200",
        "headers": {},
        "x": 1690,
        "y": 200,
        "wires": []
    },
    {
        "id": "9469d6ce.12bd58",
        "type": "http request",
        "z": "81e3836.4637a8",
        "name": "Обращаемся к ЕКБ",
        "method": "POST",
        "ret": "txt",
        "url": "https://cis.privatbank.ua/all",
        "tls": "",
        "x": 580,
        "y": 240,
        "wires": [
            [
                "97aeee33.9fb7a"
            ]
        ]
    },
    {
        "id": "acab9102.172bc",
        "type": "function",
        "z": "81e3836.4637a8",
        "name": "Готовим запрос",
        "func": "var client_id = msg.payload.client_id;\nmsg.payload = {};\nmsg.payload.r = [];\nvar x = {\n    \"type\":\"INF_NEW\",\n    \"cntr\":\"UA\",\n    \"i\":{\n        \"Id\": client_id\n        \n    }, \n    \"t\":{\n        \"returnContact\":\"Y\", \n        \"returnClientAttrs\": \"Y\",\n        \"ReturnFlVip\": \"Y\"\n    },\n    \"sid\": global.get(\"body\").SID,\n    \"o\":[\n        \"ruLName\",\n        \"ruFName\",\n        \"AgentState\",\n        \"ruMName\",\n        \"StrClientID\",\n        \"Lang\",\n        \"Id\",\n        \"PotentialVIP\",\n        \"St\",\n        \"DB\",\n        \"DTS\",\n        \"Sex\"\n        ]\n    \n};\nmsg.payload.r.push(x);\n\nmsg.headers = {};\nmsg.headers[\"Content-type\"] = \"application/json\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 380,
        "y": 240,
        "wires": [
            [
                "9469d6ce.12bd58"
            ]
        ]
    },
    {
        "id": "b1b82a45.8bcd78",
        "type": "http response",
        "z": "81e3836.4637a8",
        "name": "",
        "statusCode": "200",
        "headers": {
            "Access-Control-Allow-Origin": "*"
        },
        "x": 1040,
        "y": 240,
        "wires": []
    },
    {
        "id": "97aeee33.9fb7a",
        "type": "function",
        "z": "81e3836.4637a8",
        "name": "Формируем данные для ответа",
        "func": "var data = JSON.parse(msg.payload);\n\nvar body = {};\n\nbody.phone = getPhone(data.r[0].INF_NEW);\nbody.name = getFio(data.r[0].INF_NEW);\nbody.client_id = getId(data.r[0].INF_NEW);\nbody.str_client_id = getStrId(data.r[0].INF_NEW);\ngetAllPhones();\nbody.age = getAge(getDb(data.r[0].INF_NEW));\nbody.statusAgent = getAgentStatus(data.r[0].INF_NEW);\nbody.st = getSt(data.r[0].INF_NEW);\nbody.sex = getSex(data.r[0].INF_NEW);\nbody.DTS = getUnix(getDTS(data.r[0].INF_NEW));\nbody.vip = getVip(data.r[0].INF_NEW);\nbody.isVip = getV(data.r);\n\n\nmsg.payload = body;\n\nreturn msg;\n\nfunction getV(arr){\n    var is_VIP; \n    for (var i=0; i<arr.length; i++) {       //берем каждый объект из массива r\n     var obj = arr[i];\n     for (var k in obj) {           // проверяем на совпадение с INF_NEW\n       if ( k == \"INF_NEW\") {\n          is_VIP = obj[k][0].VIP_MANAGER.IsVip;\n        }\n      }              \n    }\n    return is_VIP;\n}\n\nfunction getAllPhones() {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//забираем телефоны\n  var arr = data.r[0].INF_NEW[0].CONT_INF;\n  body.phones = [];\n  for (var i=0; i<arr.length; i++) {\n      if (arr[i].Type == \"3\") {\n         body.phones.push(arr[i].Number.replace(\"+\", \"\"));\n    }\n  }\n}\n\nfunction Phone(p) {\n  var phone = p.replace(/-| |\\(|\\)|\\+|\\.|\\,/g, \"\"); //убираем лишнее\n  return phone;\n}\n\nfunction getPhone (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"CONT_INF\" in arr[i]) {\n      \tfor (var j=0; j<arr[i][\"CONT_INF\"].length; j++) {\n          if (arr[i][\"CONT_INF\"][j].GroupMain == \"Y\" && arr[i][\"CONT_INF\"][j].Number != \"\" && /\\+380/.test(arr[i][\"CONT_INF\"][j].Number)) {\n          \treturn arr[i][\"CONT_INF\"][j].Number;\n          }\n        }\n        //return \"\";\n      }\n  \t}\n  }\n}\n\nfunction getFio (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return arr[i][\"INF_NEW\"].ruLName + \" \" + arr[i][\"INF_NEW\"].ruFName + \" \" + arr[i][\"INF_NEW\"].ruMName;\n  \t}\n  }\n}\n\nfunction getStrId (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return arr[i][\"INF_NEW\"].StrClientID;\n  \t}\n  }\n}\n\nfunction getId (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].Id;\n  \t}\n  }\n}\n\nfunction getAge (DB) {\n  var age;\n  var str = DB;\n  if (str == \"null\" || str == \"\" || typeof str == \"undefined\") return \"-\";\n  var b_y = str.substr(0, 4);\n  var b_m = str.substr(5, 2);\n  var b_d = str.substr(8, 2); \n  var Y = new Date().getFullYear();\n  var M = new Date().getMonth()+1;\n  var D = new Date().getDate();\n  \n  if (+b_m > +M) {\n    age = Y - b_y - 1;\t\n  } else {\n  \tif (+b_m == +M && +D < +b_d) {\n  \t\tage = +Y - b_y - 1;\n  \t} else {\n  \t\tage = +Y - b_y;\n  \t}\n  }\n\n  return age;\n}\n\nfunction getSt (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].St;\n  \t}\n  }\n}\n\nfunction getDb (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].DB;\n  \t}\n  }\n}\n\nfunction getAgentStatus(arr) {\n\tif (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"P_CLIENTATTRS\" in arr[i]) {\n      \tvar statuses = arr[i][\"P_CLIENTATTRS\"].filter(function(item) {\n          if (item.AttrTypeId == 70) return item;\n        });\n      return statuses;\n      }\n  \t}\n  }\n}\n\nfunction getName (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return {\"S\": arr[i][\"INF_NEW\"].ruLName, \"N\": arr[i][\"INF_NEW\"].ruFName, \"L\": arr[i][\"INF_NEW\"].ruMName};\n  \t}\n  }\n}\n\nfunction getSex (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") {\n      \tif (arr[i][\"INF_NEW\"].Sex == \"\" || !arr[i][\"INF_NEW\"].Sex || arr[i][\"INF_NEW\"].Sex == \"undefined\") {\n        \tvar SexByRussianName = (function(){\n\n              function SexByRussianName(surname, first_name, patronymic) {\n                this.surname = surname;\n                this.first_name = first_name;\n                this.patronymic = patronymic;\n              };\n\n              SexByRussianName.FEMALE = 0;\n              SexByRussianName.MALE = 1;\n\n              SexByRussianName.SURNAME = 0;\n              SexByRussianName.PATRONYMIC = 1;\n              SexByRussianName.FIRST_NAME = 2;\n\n              SexByRussianName.surname_completions = [\n                ['ова', 'ева', 'ина', 'ая', 'яя', 'екая', 'цкая'],\n                ['ов', 'ев' ,'ин' ,'ын', 'ой', 'цкий', 'ский', 'цкой', 'ской']\n              ];\n              SexByRussianName.names = [\n                ['авдотья', 'аврора', 'агата', 'агния', 'агриппина', 'ада', 'аксинья', 'алевтина', 'александра', 'алёна', 'алена', 'алина', 'алиса', 'алла', 'альбина', 'амалия', 'анастасия', 'ангелина', 'анжела', 'анжелика', 'анна', 'антонина', 'анфиса', 'арина', 'белла', 'божена', 'валентина', 'валерия', 'ванда', 'варвара', 'василина', 'василиса', 'вера', 'вероника', 'виктория', 'виола', 'виолетта', 'вита', 'виталия', 'владислава', 'власта', 'галина', 'глафира', 'дарья', 'диана', 'дина', 'ева', 'евгения', 'евдокия', 'евлампия', 'екатерина', 'елена', 'елизавета', 'ефросиния', 'ефросинья', 'жанна', 'зиновия', 'злата', 'зоя', 'ивонна', 'изольда', 'илона', 'инга', 'инесса', 'инна', 'ирина', 'ия', 'капитолина', 'карина', 'каролина', 'кира', 'клавдия', 'клара', 'клеопатра', 'кристина', 'ксения', 'лада', 'лариса', 'лиана', 'лидия', 'лилия', 'лина', 'лия', 'лора', 'любава', 'любовь', 'людмила', 'майя', 'маргарита', 'марианна', 'мариетта', 'марина', 'мария', 'марья', 'марта', 'марфа', 'марьяна', 'матрёна', 'матрена', 'матрона', 'милена', 'милослава', 'мирослава', 'муза', 'надежда', 'настасия', 'настасья', 'наталия', 'наталья', 'нелли', 'ника', 'нина', 'нинель', 'нонна', 'оксана', 'олимпиада', 'ольга', 'пелагея', 'полина', 'прасковья', 'раиса', 'рената', 'римма', 'роза', 'роксана', 'руфь', 'сарра', 'светлана', 'серафима', 'снежана', 'софья', 'софия', 'стелла', 'степанида', 'стефания', 'таисия', 'таисья', 'тамара', 'татьяна', 'ульяна', 'устиния', 'устинья', 'фаина', 'фёкла', 'фекла', 'феодора', 'хаврония', 'христина', 'эвелина', 'эдита', 'элеонора', 'элла', 'эльвира', 'эмилия', 'эмма', 'юдифь', 'юлиана', 'юлия', 'ядвига', 'яна', 'ярослава'],\n                ['абрам', 'аверьян', 'авраам', 'агафон', 'адам', 'азар', 'акакий', 'аким', 'аксён', 'александр', 'алексей', 'альберт', 'анатолий', 'андрей', 'андрон', 'антип', 'антон', 'аполлон', 'аристарх', 'аркадий', 'арнольд', 'арсений', 'арсентий', 'артем', 'артём', 'артемий', 'артур', 'аскольд', 'афанасий', 'богдан', 'борис', 'борислав', 'бронислав', 'вадим', 'валентин', 'валерий', 'варлам', 'василий', 'венедикт', 'вениамин', 'веньямин', 'венцеслав', 'виктор', 'вилен', 'виталий', 'владилен', 'владимир', 'владислав', 'владлен', 'всеволод', 'всеслав', 'вячеслав', 'гавриил', 'геннадий', 'георгий', 'герман', 'глеб', 'григорий', 'давид', 'даниил', 'данил', 'данила', 'демьян', 'денис', 'димитрий', 'дмитрий', 'добрыня', 'евгений', 'евдоким', 'евсей', 'егор', 'емельян', 'еремей', 'ермолай', 'ерофей', 'ефим', 'захар', 'иван', 'игнат', 'игорь', 'илларион', 'иларион', 'илья', 'иосиф', 'казимир', 'касьян', 'кирилл', 'кондрат', 'константин', 'кузьма', 'лавр', 'лаврентий', 'лазарь', 'ларион', 'лев', 'леонард', 'леонид', 'лука', 'максим', 'марат', 'мартын', 'матвей', 'мефодий', 'мирон', 'михаил', 'моисей', 'назар', 'никита', 'николай', 'олег', 'осип', 'остап', 'павел', 'панкрат', 'пантелей', 'парамон', 'пётр', 'петр', 'платон', 'потап', 'прохор', 'роберт', 'ростислав', 'савва', 'савелий', 'семён', 'семен', 'сергей', 'сидор', 'спартак', 'тарас', 'терентий', 'тимофей', 'тимур', 'тихон', 'ульян', 'фёдор', 'федор', 'федот', 'феликс', 'фирс', 'фома', 'харитон', 'харлам', 'эдуард', 'эммануил', 'эраст', 'юлиан', 'юлий', 'юрий', 'яков', 'ян', 'ярослав']\n              ];\n              SexByRussianName.patronymic_completions = [\n                ['овна', 'евна', 'ична'],\n                ['ович', 'евич', 'ич']\n              ];\n\n              SexByRussianName.prototype.get_gender = function() {\n                var genders_on_names = [this.gender_by(SexByRussianName.SURNAME, this.surname),\n                                        this.gender_by_first_name(),\n                                        this.gender_by(SexByRussianName.PATRONYMIC, this.patronymic)];\n\n                var gender = this.determine_gender(genders_on_names)\n\n                return gender;\n              };\n\n\n              SexByRussianName.prototype.determine_gender = function(genders) {\n                var male = false,\n                    female = false,\n                    gender = undefined;\n\n                for (var i=0; i < 3; i++){\n                  if (genders[i] === SexByRussianName.MALE) male = true;\n                  if (genders[i] === SexByRussianName.FEMALE) female = true;\n                }\n\n                if (male && !female) gender = SexByRussianName.MALE;\n                if (!male && female) gender = SexByRussianName.FEMALE;\n\n                return gender;\n              }\n\n\n              SexByRussianName.prototype.gender_by_first_name = function() {\n                var gender = undefined,\n                    first_name = this.normalize(this.first_name);\n\n                if (this.is_popular_name(first_name, SexByRussianName.FEMALE)) gender = SexByRussianName.FEMALE;\n                if (this.is_popular_name(first_name, SexByRussianName.MALE)) gender = SexByRussianName.MALE;\n\n                return gender;\n              }\n\n              SexByRussianName.prototype.gender_by = function(name_type, string) {\n                var gender = undefined,\n                    name = this.normalize(string);\n\n                if (this.is_correct(name, name_type, SexByRussianName.FEMALE)) gender = SexByRussianName.FEMALE;\n                if (this.is_correct(name, name_type, SexByRussianName.MALE)) gender = SexByRussianName.MALE;\n\n                return gender;\n              }\n\n              SexByRussianName.prototype.is_correct = function(string, type, gender) {\n                var is_correct = false,\n                    completions;\n\n                  switch (type){\n                    case SexByRussianName.SURNAME:\n                      completions = SexByRussianName.surname_completions[gender];\n                      break;\n                    case SexByRussianName.PATRONYMIC:\n                      completions = SexByRussianName.patronymic_completions[gender];\n                  }\n\n                for (var i=0; i<completions.length; i++){\n                  var completion = this.completion(string, completions[i].length);\n                  if (completion === completions[i]) is_correct = true;\n                }\n\n                return is_correct;\n              }\n\n              SexByRussianName.prototype.is_popular_name = function(first_name, gender) {\n                var is_popular_name = false,\n                    names = SexByRussianName.names[gender];\n\n                for (var i=0; i<names.length; i++){\n                  if (first_name === names[i]) is_popular_name = true;\n                }\n\n                return is_popular_name;\n              }\n\n              SexByRussianName.prototype.completion = function(string, count){\n                var completion = string.substr((string.length - count), (string.length - 1));\n\n                return completion;\n              }\n\n              SexByRussianName.prototype.normalize = function(string) {\n                var normal_string = string.toLowerCase();\n                normal_string = normal_string.replace(/\\s/g, '');\n\n                return normal_string;\n              }\n\n              return SexByRussianName;\n            })();\n\n            var name = getName(data.r[0].INF_NEW);\n            var sex_by_russian_name = new SexByRussianName(name.S, name.N, name.L);\n            var sex = sex_by_russian_name.get_gender(); // 1 — мужской, 0 — женский, undefined — не определен.\n            if (sex == \"1\") return \"M\";\n            if (sex == \"0\") return \"F\";\n            if (sex == \"undefined\") return \"-\";\n        }\n        return arr[i][\"INF_NEW\"].Sex;\n      }\n  \t}\n  }\n}\n\nfunction getDTS (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") {\n        return arr[i][\"INF_NEW\"].DTS;\n      }\n  \t}\n  }\n}\n\nfunction getUnix(dateString){\n\tif (dateString == \"\" || typeof dateString == \"undefined\") {\n  \tvar date = new Date().getTime() + \"\";\n    return date.substr(0, 10);\n  } else {\n  \tvar M = +dateString.substr(5, 2) - 1;\n\t\tvar date = new Date(dateString.substr(0, 4), M, dateString.substr(8, 2)).getTime()+\"\";\n  \treturn date.substr(0, 10);\n  }\n}\n\nfunction getVip (arr) {\n  var VIP = \"N\"; \n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i]) {\n        if (arr[i][\"INF_NEW\"].PotentialVIP == \"Y\" || arr[i][\"INF_NEW\"].VipStatus == \"Y\" ) VIP = \"Y\";\n      }\n      if (\"VIP_INF\" in arr[i]) {\n        if (arr[i][\"VIP_INF\"].VipStatus == \"Y\" ) VIP = \"Y\";\n      }\n  \t}\n  }\n  return VIP;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 240,
        "wires": [
            [
                "b1b82a45.8bcd78"
            ]
        ]
    },
    {
        "id": "b46fed25.3e05",
        "type": "http in",
        "z": "81e3836.4637a8",
        "name": "API: getClientByEkbId (GET)",
        "url": "/clientInfo",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 240,
        "wires": [
            [
                "acab9102.172bc"
            ]
        ]
    },
    {
        "id": "eed8becd.18a52",
        "type": "http in",
        "z": "3b71b008.50e91",
        "name": "API: getTiketsByClient",
        "url": "/searchTikets",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 200,
        "wires": [
            [
                "e3751e1d.94942"
            ]
        ]
    },
    {
        "id": "a6d03e78.b7062",
        "type": "http response",
        "z": "3b71b008.50e91",
        "name": "Ответ",
        "statusCode": "200",
        "headers": {},
        "x": 850,
        "y": 200,
        "wires": []
    },
    {
        "id": "e3751e1d.94942",
        "type": "function",
        "z": "3b71b008.50e91",
        "name": "",
        "func": "msg.headers = {};\nmsg.headers[\"Content-type\"] = \"application/json\";\n\nif (typeof msg.payload.atsrs != \"object\" && msg.payload.client_id != \"\" && typeof msg.payload.client_id != \"undefined\") {\n    msg.payload.atsrs = {\"35\": msg.payload.client_id};\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 200,
        "wires": [
            [
                "b1ba4fd2.08c51"
            ]
        ]
    },
    {
        "id": "b1ba4fd2.08c51",
        "type": "http request",
        "z": "3b71b008.50e91",
        "name": "Запрос в СХП API",
        "method": "POST",
        "ret": "txt",
        "url": "https://att.privatbank.ua/all/conv/attachmentservice/search.json",
        "tls": "",
        "x": 530,
        "y": 200,
        "wires": [
            [
                "d0a69809.1294d8"
            ]
        ]
    },
    {
        "id": "d0a69809.1294d8",
        "type": "function",
        "z": "3b71b008.50e91",
        "name": "",
        "func": "if (msg.statusCode == \"200\") {\n    msg.body = {\n        \"obj\": JSON.parse(msg.payload)\n        \n    };\n    \n    msg.attach = msg.body.obj.attachments;\n    \n    //пройдемся по тикетам    \n    for (var i=0; i<msg.attach.length; i++) {\n        //зачистим ненужные поля текета\n        for (var k in msg.attach[i]) {\n            if (!/id|vdDoc|lastModificationDate|atsr/.test(k)) {\n                delete msg.attach[i][k];\n            } else {\n                if (k == \"vdDoc\") {\n                    for (var n in msg.attach[i][k]) {\n                        if (!/id/.test(n)) {\n                            delete msg.attach[i][k][n];\n                        }\n                    }\n                } else if (k == \"atsr\") {\n                    var reload = false;\n                    msg.atsr = [];\n                    for (var j=0; j<msg.attach[i][k].length; j++) {\n                        if (msg.attach[i][k][j].docRule.id == 29) {\n                            //msg.atsr = msg.attach[i][k][j];\n                            msg.atsr.push(msg.attach[i][k][j]);\n                            reload = true;\n                        } else if (msg.attach[i][k][j].docRule.id == 43) {\n                            //msg.atsr = msg.attach[i][k][j];\n                            msg.atsr.push(msg.attach[i][k][j]);\n                            reload = true;\n                        }\n                    }\n                    if (reload) {\n                        msg.attach[i][k] = msg.atsr;\n                    } else {\n                        delete msg.attach[i][k];\n                    }\n                }\n            }\n        }\n    }\n    \n    msg.payload = msg.attach;   \n}\n\n//: \"2019-08-06 18:24:19.655+0300\nfunction getDeltaTime(str) {\n    var now = new Date().getTime(), \n        time = new Date(str.substr(0, 4), str.substr(5, 2) - 1, str.substr(8, 2)).getTime();\n    return now - time;\n}\n\nfunction get29Attr(arr) {\n\tif (Array.isArray(arr)) {\n  \tfor (var i=0; i<arr.length; i++) {\n    \tif (arr[i].docRule.id == 29) {\n      \treturn arr[i].value;\n      }\n    }\n  }\n  return null;\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 200,
        "wires": [
            [
                "a6d03e78.b7062"
            ]
        ]
    },
    {
        "id": "1bc6a9e2.16ab86",
        "type": "http response",
        "z": "3b71b008.50e91",
        "name": "Ответ",
        "statusCode": "200",
        "headers": {},
        "x": 850,
        "y": 420,
        "wires": []
    },
    {
        "id": "231f3515.f1d5ca",
        "type": "function",
        "z": "3b71b008.50e91",
        "name": "",
        "func": "msg.headers = {};\nmsg.headers[\"Content-type\"] = \"application/json\";\n\nif (typeof msg.payload.atsrs != \"object\" && msg.payload.client_id != \"\" && typeof msg.payload.client_id != \"undefined\") {\n    msg.payload.atsrs = {\"35\": msg.payload.client_id};\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 420,
        "wires": [
            [
                "e86981a1.7798e"
            ]
        ]
    },
    {
        "id": "e86981a1.7798e",
        "type": "http request",
        "z": "3b71b008.50e91",
        "name": "Запрос в СХП API",
        "method": "POST",
        "ret": "txt",
        "url": "https://att.privatbank.ua/all/conv/attachmentservice/search.json",
        "tls": "",
        "x": 530,
        "y": 420,
        "wires": [
            [
                "30df57f8.222e28"
            ]
        ]
    },
    {
        "id": "30df57f8.222e28",
        "type": "function",
        "z": "3b71b008.50e91",
        "name": "",
        "func": "if (msg.statusCode == \"200\") {\n    msg.body = {\n        \"obj\": JSON.parse(msg.payload)\n        \n    };\n    \n    msg.attach = msg.body.obj.attachments;\n        \n    for (var i=0; i<msg.attach.length; i++) {\n        for (var k in msg.attach[i]) {\n            if (!/id|vdDoc|lastModificationDate/.test(k)) {\n                delete msg.attach[i][k];\n            } else {\n                if (k == \"vdDoc\") {\n                    for (var n in msg.attach[i][k]) {\n                        if (!/id/.test(n)) {\n                            delete msg.attach[i][k][n];\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n\n\nvar data = {\n    \"attachments\": msg.attach\n},\n    tickets = [],\n    flag = false;\n\nif (data.attachments.length > 0){\n\tfor (x in data.attachments){\n            if (/1219|2815|3020|3147/.test(data.attachments[x].vdDoc.id) && getDays(data.attachments[x].lastModificationDate) < 365) {\n              tickets.push(data.attachments[x].id) ;\n              flag = true;\n            }\n\t}\n}\n\ndata.tickets = tickets;\n\ndata.flag = flag;\n\ndata.max = data.tickets.length;\n\ndelete data.attachments;\n\nmsg.payload = data;\n\nreturn msg;\n\n\nfunction getDays(date) {\n  var last = new Date(date.substr(0, 4), (+date.substr(5, 2)-1), date.substr(8, 2)).getTime(),\n      now = new Date().getTime();\n  return Math.floor((now - last)/86400000);\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 710,
        "y": 420,
        "wires": [
            [
                "1bc6a9e2.16ab86"
            ]
        ]
    },
    {
        "id": "75de175b.5b7c98",
        "type": "debug",
        "z": "3b71b008.50e91",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 850,
        "y": 300,
        "wires": []
    },
    {
        "id": "9eea4c0f.fc37",
        "type": "http in",
        "z": "3b71b008.50e91",
        "name": "API: getOnlyTiketsByClient",
        "url": "/searchOnlyTikets",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 420,
        "wires": [
            [
                "231f3515.f1d5ca"
            ]
        ]
    },
    {
        "id": "9d32e74c.b741a8",
        "type": "http in",
        "z": "1e3801f3.ffb9ae",
        "name": "API: getPrecalcFlagByClientId",
        "url": "/getPrecalcFlag",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 200,
        "wires": [
            [
                "4503a920.773518"
            ]
        ]
    },
    {
        "id": "4503a920.773518",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.client_id = msg.payload.client_id;\nmsg.source = msg.payload.source;\nmsg.cb_url = msg.payload.callback_url;\n\nif (!/^(3700|BirthDay|P24WEB|P24MOB|limitpbua|agents|176535|temp_from_28716|chat)$/.test(msg.source)) msg.source = \"error\";\n\nif (/^(3700|P24WEB|chat)$/.test(msg.source)) {\n    msg.toRedis = \"true\";\n} else {\n    msg.toRedis = \"false\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 370,
        "y": 200,
        "wires": [
            [
                "3127a775.c9e868",
                "4cb47277.55ac9c"
            ]
        ]
    },
    {
        "id": "9936fff4.55e2e",
        "type": "http request",
        "z": "81e3836.4637a8",
        "name": "Обращаемся к ЕКБ",
        "method": "POST",
        "ret": "txt",
        "url": "https://cis.privatbank.ua/all",
        "tls": "",
        "x": 580,
        "y": 300,
        "wires": [
            [
                "e4427b20.0eb0c8"
            ]
        ]
    },
    {
        "id": "e507c91e.927928",
        "type": "function",
        "z": "81e3836.4637a8",
        "name": "Готовим запрос",
        "func": "var client_id = msg.client_id;\nmsg.payload = {};\nmsg.payload.r = [];\nvar x = {\n    \"type\":\"INF_NEW\",\n    \"cntr\":\"UA\",\n    \"i\":{\n        \"Id\": client_id\n        \n    }, \n    \"t\":{\n        \"returnContact\":\"Y\", \n        \"returnClientAttrs\": \"Y\",\n        \"ReturnFlVip\": \"Y\"\n    },\n    \"sid\": global.get(\"body\").SID,\n    \"o\":[\n        \"ruLName\",\n        \"ruFName\",\n        \"AgentState\",\n        \"ruMName\",\n        \"StrClientID\",\n        \"Lang\",\n        \"Id\",\n        \"PotentialVIP\",\n        \"St\",\n        \"DB\",\n        \"DTS\",\n        \"Sex\"\n        ]\n    \n};\nmsg.payload.r.push(x);\n\nmsg.headers = {};\nmsg.headers[\"Content-type\"] = \"application/json\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 380,
        "y": 300,
        "wires": [
            [
                "9936fff4.55e2e"
            ]
        ]
    },
    {
        "id": "e4427b20.0eb0c8",
        "type": "function",
        "z": "81e3836.4637a8",
        "name": "Формируем данные для ответа",
        "func": "var data = JSON.parse(msg.payload);\n\nvar body = {};\n\nbody.phone = getPhone(data.r[0].INF_NEW);\nbody.name = getFio(data.r[0].INF_NEW);\nbody.client_id = getId(data.r[0].INF_NEW);\nbody.str_client_id = getStrId(data.r[0].INF_NEW);\ngetAllPhones();\nbody.age = getAge(getDb(data.r[0].INF_NEW));\nbody.statusAgent = getAgentStatus(data.r[0].INF_NEW);\nbody.st = getSt(data.r[0].INF_NEW);\nbody.sex = getSex(data.r[0].INF_NEW);\nbody.DTS = getUnix(getDTS(data.r[0].INF_NEW));\nbody.vip = getVip(data.r[0].INF_NEW);\nbody.isVip = getV(data.r);\n\n\nmsg.payload = body;\n\nreturn msg;\n\nfunction getV(arr){\n    var is_VIP; \n    for (var i=0; i<arr.length; i++) {       //берем каждый объект из массива r\n     var obj = arr[i];\n     for (var k in obj) {           // проверяем на совпадение с INF_NEW\n       if ( k == \"INF_NEW\") {\n          is_VIP = obj[k][0].VIP_MANAGER.IsVip;\n        }\n      }              \n    }\n    return is_VIP;\n}\n\nfunction getAllPhones() {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//забираем телефоны\n  var arr = data.r[0].INF_NEW[0].CONT_INF;\n  body.phones = [];\n  for (var i=0; i<arr.length; i++) {\n      if (arr[i].Type == \"3\") {\n         body.phones.push(arr[i].Number.replace(\"+\", \"\"));\n    }\n  }\n}\n\nfunction Phone(p) {\n  var phone = p.replace(/-| |\\(|\\)|\\+|\\.|\\,/g, \"\"); //убираем лишнее\n  return phone;\n}\n\nfunction getPhone (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"CONT_INF\" in arr[i]) {\n      \tfor (var j=0; j<arr[i][\"CONT_INF\"].length; j++) {\n          if (arr[i][\"CONT_INF\"][j].GroupMain == \"Y\" && arr[i][\"CONT_INF\"][j].Number != \"\" && /\\+380/.test(arr[i][\"CONT_INF\"][j].Number)) {\n          \treturn arr[i][\"CONT_INF\"][j].Number;\n          }\n        }\n        //return \"\";\n      }\n  \t}\n  }\n}\n\nfunction getFio (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return arr[i][\"INF_NEW\"].ruLName + \" \" + arr[i][\"INF_NEW\"].ruFName + \" \" + arr[i][\"INF_NEW\"].ruMName;\n  \t}\n  }\n}\n\nfunction getStrId (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return arr[i][\"INF_NEW\"].StrClientID;\n  \t}\n  }\n}\n\nfunction getId (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].Id;\n  \t}\n  }\n}\n\nfunction getAge (DB) {\n  var age;\n  var str = DB;\n  if (str == \"null\" || str == \"\" || typeof str == \"undefined\") return \"-\";\n  var b_y = str.substr(0, 4);\n  var b_m = str.substr(5, 2);\n  var b_d = str.substr(8, 2); \n  var Y = new Date().getFullYear();\n  var M = new Date().getMonth()+1;\n  var D = new Date().getDate();\n  \n  if (+b_m > +M) {\n    age = Y - b_y - 1;\t\n  } else {\n  \tif (+b_m == +M && +D < +b_d) {\n  \t\tage = +Y - b_y - 1;\n  \t} else {\n  \t\tage = +Y - b_y;\n  \t}\n  }\n\n  return age;\n}\n\nfunction getSt (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].St;\n  \t}\n  }\n}\n\nfunction getDb (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].DB;\n  \t}\n  }\n}\n\nfunction getAgentStatus(arr) {\n\tif (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"P_CLIENTATTRS\" in arr[i]) {\n      \tvar statuses = arr[i][\"P_CLIENTATTRS\"].filter(function(item) {\n          if (item.AttrTypeId == 70) return item;\n        });\n      return statuses;\n      }\n  \t}\n  }\n}\n\nfunction getName (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return {\"S\": arr[i][\"INF_NEW\"].ruLName, \"N\": arr[i][\"INF_NEW\"].ruFName, \"L\": arr[i][\"INF_NEW\"].ruMName};\n  \t}\n  }\n}\n\nfunction getSex (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") {\n      \tif (arr[i][\"INF_NEW\"].Sex == \"\" || !arr[i][\"INF_NEW\"].Sex || arr[i][\"INF_NEW\"].Sex == \"undefined\") {\n        \tvar SexByRussianName = (function(){\n\n              function SexByRussianName(surname, first_name, patronymic) {\n                this.surname = surname;\n                this.first_name = first_name;\n                this.patronymic = patronymic;\n              };\n\n              SexByRussianName.FEMALE = 0;\n              SexByRussianName.MALE = 1;\n\n              SexByRussianName.SURNAME = 0;\n              SexByRussianName.PATRONYMIC = 1;\n              SexByRussianName.FIRST_NAME = 2;\n\n              SexByRussianName.surname_completions = [\n                ['ова', 'ева', 'ина', 'ая', 'яя', 'екая', 'цкая'],\n                ['ов', 'ев' ,'ин' ,'ын', 'ой', 'цкий', 'ский', 'цкой', 'ской']\n              ];\n              SexByRussianName.names = [\n                ['авдотья', 'аврора', 'агата', 'агния', 'агриппина', 'ада', 'аксинья', 'алевтина', 'александра', 'алёна', 'алена', 'алина', 'алиса', 'алла', 'альбина', 'амалия', 'анастасия', 'ангелина', 'анжела', 'анжелика', 'анна', 'антонина', 'анфиса', 'арина', 'белла', 'божена', 'валентина', 'валерия', 'ванда', 'варвара', 'василина', 'василиса', 'вера', 'вероника', 'виктория', 'виола', 'виолетта', 'вита', 'виталия', 'владислава', 'власта', 'галина', 'глафира', 'дарья', 'диана', 'дина', 'ева', 'евгения', 'евдокия', 'евлампия', 'екатерина', 'елена', 'елизавета', 'ефросиния', 'ефросинья', 'жанна', 'зиновия', 'злата', 'зоя', 'ивонна', 'изольда', 'илона', 'инга', 'инесса', 'инна', 'ирина', 'ия', 'капитолина', 'карина', 'каролина', 'кира', 'клавдия', 'клара', 'клеопатра', 'кристина', 'ксения', 'лада', 'лариса', 'лиана', 'лидия', 'лилия', 'лина', 'лия', 'лора', 'любава', 'любовь', 'людмила', 'майя', 'маргарита', 'марианна', 'мариетта', 'марина', 'мария', 'марья', 'марта', 'марфа', 'марьяна', 'матрёна', 'матрена', 'матрона', 'милена', 'милослава', 'мирослава', 'муза', 'надежда', 'настасия', 'настасья', 'наталия', 'наталья', 'нелли', 'ника', 'нина', 'нинель', 'нонна', 'оксана', 'олимпиада', 'ольга', 'пелагея', 'полина', 'прасковья', 'раиса', 'рената', 'римма', 'роза', 'роксана', 'руфь', 'сарра', 'светлана', 'серафима', 'снежана', 'софья', 'софия', 'стелла', 'степанида', 'стефания', 'таисия', 'таисья', 'тамара', 'татьяна', 'ульяна', 'устиния', 'устинья', 'фаина', 'фёкла', 'фекла', 'феодора', 'хаврония', 'христина', 'эвелина', 'эдита', 'элеонора', 'элла', 'эльвира', 'эмилия', 'эмма', 'юдифь', 'юлиана', 'юлия', 'ядвига', 'яна', 'ярослава'],\n                ['абрам', 'аверьян', 'авраам', 'агафон', 'адам', 'азар', 'акакий', 'аким', 'аксён', 'александр', 'алексей', 'альберт', 'анатолий', 'андрей', 'андрон', 'антип', 'антон', 'аполлон', 'аристарх', 'аркадий', 'арнольд', 'арсений', 'арсентий', 'артем', 'артём', 'артемий', 'артур', 'аскольд', 'афанасий', 'богдан', 'борис', 'борислав', 'бронислав', 'вадим', 'валентин', 'валерий', 'варлам', 'василий', 'венедикт', 'вениамин', 'веньямин', 'венцеслав', 'виктор', 'вилен', 'виталий', 'владилен', 'владимир', 'владислав', 'владлен', 'всеволод', 'всеслав', 'вячеслав', 'гавриил', 'геннадий', 'георгий', 'герман', 'глеб', 'григорий', 'давид', 'даниил', 'данил', 'данила', 'демьян', 'денис', 'димитрий', 'дмитрий', 'добрыня', 'евгений', 'евдоким', 'евсей', 'егор', 'емельян', 'еремей', 'ермолай', 'ерофей', 'ефим', 'захар', 'иван', 'игнат', 'игорь', 'илларион', 'иларион', 'илья', 'иосиф', 'казимир', 'касьян', 'кирилл', 'кондрат', 'константин', 'кузьма', 'лавр', 'лаврентий', 'лазарь', 'ларион', 'лев', 'леонард', 'леонид', 'лука', 'максим', 'марат', 'мартын', 'матвей', 'мефодий', 'мирон', 'михаил', 'моисей', 'назар', 'никита', 'николай', 'олег', 'осип', 'остап', 'павел', 'панкрат', 'пантелей', 'парамон', 'пётр', 'петр', 'платон', 'потап', 'прохор', 'роберт', 'ростислав', 'савва', 'савелий', 'семён', 'семен', 'сергей', 'сидор', 'спартак', 'тарас', 'терентий', 'тимофей', 'тимур', 'тихон', 'ульян', 'фёдор', 'федор', 'федот', 'феликс', 'фирс', 'фома', 'харитон', 'харлам', 'эдуард', 'эммануил', 'эраст', 'юлиан', 'юлий', 'юрий', 'яков', 'ян', 'ярослав']\n              ];\n              SexByRussianName.patronymic_completions = [\n                ['овна', 'евна', 'ична'],\n                ['ович', 'евич', 'ич']\n              ];\n\n              SexByRussianName.prototype.get_gender = function() {\n                var genders_on_names = [this.gender_by(SexByRussianName.SURNAME, this.surname),\n                                        this.gender_by_first_name(),\n                                        this.gender_by(SexByRussianName.PATRONYMIC, this.patronymic)];\n\n                var gender = this.determine_gender(genders_on_names)\n\n                return gender;\n              };\n\n\n              SexByRussianName.prototype.determine_gender = function(genders) {\n                var male = false,\n                    female = false,\n                    gender = undefined;\n\n                for (var i=0; i < 3; i++){\n                  if (genders[i] === SexByRussianName.MALE) male = true;\n                  if (genders[i] === SexByRussianName.FEMALE) female = true;\n                }\n\n                if (male && !female) gender = SexByRussianName.MALE;\n                if (!male && female) gender = SexByRussianName.FEMALE;\n\n                return gender;\n              }\n\n\n              SexByRussianName.prototype.gender_by_first_name = function() {\n                var gender = undefined,\n                    first_name = this.normalize(this.first_name);\n\n                if (this.is_popular_name(first_name, SexByRussianName.FEMALE)) gender = SexByRussianName.FEMALE;\n                if (this.is_popular_name(first_name, SexByRussianName.MALE)) gender = SexByRussianName.MALE;\n\n                return gender;\n              }\n\n              SexByRussianName.prototype.gender_by = function(name_type, string) {\n                var gender = undefined,\n                    name = this.normalize(string);\n\n                if (this.is_correct(name, name_type, SexByRussianName.FEMALE)) gender = SexByRussianName.FEMALE;\n                if (this.is_correct(name, name_type, SexByRussianName.MALE)) gender = SexByRussianName.MALE;\n\n                return gender;\n              }\n\n              SexByRussianName.prototype.is_correct = function(string, type, gender) {\n                var is_correct = false,\n                    completions;\n\n                  switch (type){\n                    case SexByRussianName.SURNAME:\n                      completions = SexByRussianName.surname_completions[gender];\n                      break;\n                    case SexByRussianName.PATRONYMIC:\n                      completions = SexByRussianName.patronymic_completions[gender];\n                  }\n\n                for (var i=0; i<completions.length; i++){\n                  var completion = this.completion(string, completions[i].length);\n                  if (completion === completions[i]) is_correct = true;\n                }\n\n                return is_correct;\n              }\n\n              SexByRussianName.prototype.is_popular_name = function(first_name, gender) {\n                var is_popular_name = false,\n                    names = SexByRussianName.names[gender];\n\n                for (var i=0; i<names.length; i++){\n                  if (first_name === names[i]) is_popular_name = true;\n                }\n\n                return is_popular_name;\n              }\n\n              SexByRussianName.prototype.completion = function(string, count){\n                var completion = string.substr((string.length - count), (string.length - 1));\n\n                return completion;\n              }\n\n              SexByRussianName.prototype.normalize = function(string) {\n                var normal_string = string.toLowerCase();\n                normal_string = normal_string.replace(/\\s/g, '');\n\n                return normal_string;\n              }\n\n              return SexByRussianName;\n            })();\n\n            var name = getName(data.r[0].INF_NEW);\n            var sex_by_russian_name = new SexByRussianName(name.S, name.N, name.L);\n            var sex = sex_by_russian_name.get_gender(); // 1 — мужской, 0 — женский, undefined — не определен.\n            if (sex == \"1\") return \"M\";\n            if (sex == \"0\") return \"F\";\n            if (sex == \"undefined\") return \"-\";\n        }\n        return arr[i][\"INF_NEW\"].Sex;\n      }\n  \t}\n  }\n}\n\nfunction getDTS (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") {\n        return arr[i][\"INF_NEW\"].DTS;\n      }\n  \t}\n  }\n}\n\nfunction getUnix(dateString){\n\tif (dateString == \"\" || typeof dateString == \"undefined\") {\n  \tvar date = new Date().getTime() + \"\";\n    return date.substr(0, 10);\n  } else {\n  \tvar M = +dateString.substr(5, 2) - 1;\n\t\tvar date = new Date(dateString.substr(0, 4), M, dateString.substr(8, 2)).getTime()+\"\";\n  \treturn date.substr(0, 10);\n  }\n}\n\nfunction getVip (arr) {\n  var VIP = \"N\"; \n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i]) {\n        if (arr[i][\"INF_NEW\"].PotentialVIP == \"Y\" || arr[i][\"INF_NEW\"].VipStatus == \"Y\" ) VIP = \"Y\";\n      }\n      if (\"VIP_INF\" in arr[i]) {\n        if (arr[i][\"VIP_INF\"].VipStatus == \"Y\" ) VIP = \"Y\";\n      }\n  \t}\n  }\n  return VIP;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 830,
        "y": 300,
        "wires": [
            [
                "b67dc0fc.2dd04"
            ]
        ]
    },
    {
        "id": "b67dc0fc.2dd04",
        "type": "link out",
        "z": "81e3836.4637a8",
        "name": "",
        "links": [
            "a12aee68.6b41c"
        ],
        "x": 995,
        "y": 300,
        "wires": []
    },
    {
        "id": "af4801fb.3fde5",
        "type": "link in",
        "z": "81e3836.4637a8",
        "name": "",
        "links": [
            "badf17e8.f72478"
        ],
        "x": 255,
        "y": 300,
        "wires": [
            [
                "e507c91e.927928"
            ]
        ]
    },
    {
        "id": "58cb2b36.7a7134",
        "type": "link in",
        "z": "f3825ecf.771b3",
        "name": "",
        "links": [
            "e5ae4a3f.f47248"
        ],
        "x": 295,
        "y": 300,
        "wires": [
            [
                "878a9dcb.bb745"
            ]
        ]
    },
    {
        "id": "878a9dcb.bb745",
        "type": "function",
        "z": "f3825ecf.771b3",
        "name": "Устанавливаем Headers",
        "func": "msg.payload.sid = global.get(\"body\").SID;\nmsg.headers = {};\nmsg.headers[\"Authorization\"] = global.get(\"body\").SID;\nmsg.headers[\"Accept\"] = \"application/json\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 450,
        "y": 300,
        "wires": [
            [
                "576841ce.267ba"
            ]
        ]
    },
    {
        "id": "576841ce.267ba",
        "type": "http request",
        "z": "f3825ecf.771b3",
        "name": "Запрос в кошелек",
        "method": "GET",
        "ret": "obj",
        "url": "https://stat.privatbank.ua/stat/api/purse/module/cardsforwave/byekb/{{client_id}}",
        "tls": "",
        "x": 670,
        "y": 300,
        "wires": [
            [
                "7dc176e9.c06a48"
            ]
        ]
    },
    {
        "id": "7dc176e9.c06a48",
        "type": "function",
        "z": "f3825ecf.771b3",
        "name": "Функция выбора конкретных карт",
        "func": "if (typeof msg.body != \"object\") msg.body = {}; \nmsg.body.cards = msg.payload;\nmsg.payload = {};\n//запуск:\n// установка текущей даты (формат: мм/гг)\nvar date = new Date();\nvar curMonth = compare(date.getMonth() + 1);\nvar curYear = date.getFullYear().toString().substr(2);\n\nif(Array.isArray(msg.body.cards) && msg.client_status != \"vip\") {\n  \n  msg.payload.prod_arr = product_from_ARR(msg.body.cards);\n  \n  if (msg.payload.prod_arr.length === 0) {\n    \n    var prod_arr_exp = exp_product_from_ARR(msg.body.cards);\n    \n    if (prod_arr_exp.length > 0) {\n      \n      msg.payload.exp_cards = true;\n      msg.payload.prod_arr_exp = prod_arr_exp;\n\n    }\n    \n  }\n  \n  msg.payload.is_GOLD = getFlagGold(msg.body.cards);\n  \n} if(Array.isArray(msg.body.cards) && msg.client_status == \"vip\") {\n  \n  msg.payload.prod_arr = product_from_Vip_ARR(msg.body.cards);\n  \n  if (msg.payload.prod_arr.length > 0) {\n    msg.is_GOLD = \"N\";\n    msg.is_VIP = \"Y\";\n    msg.most_vip = most_vip(msg.payload.prod_arr);\n    \n  } else {\n    msg.payload.prod_arr = product_from_ARR(msg.body.cards);\n  \n  if (msg.payload.prod_arr.length === 0) {\n    \n    var prod_arr_exp = exp_product_from_ARR(msg.body.cards);\n    \n    if (prod_arr_exp.length > 0) {\n      \n      msg.payload.exp_cards = true;\n      msg.payload.prod_arr_exp = prod_arr_exp;\n\n    }\n    \n  }\n  \n  msg.is_GOLD = getFlagGold(msg.body.cards);\n  \n  }\n    \n} else {\n \n msg.payload.description = msg.payload.error;\n msg.payload.err = \"Кошелек\";\n    \n}\n\n\n\nif (Array.isArray(msg.payload.prod_arr) && msg.payload.prod_arr.length > 1) msg.payload.prod_arr = msg.payload.prod_arr.sort(compareLimits);\n\n\n//функции:*/\nfunction compare(a){\n\treturn a<10 ? \"0\"+a : a+\"\";\n}\n\nfunction product_from_ARR(cards) {\n\n  var prod_arr = [];\n  var card = {};\n  var curMonth = compare(date.getMonth() + 1);\n  var curY = date.getFullYear().toString().substr(2);\n\n  for (var i=0; i<cards.length; i++) {\n  \tif (cards[i].product_type==\"KUN\" && +cards[i].currency==980 && cards[i].bank==\"PB\" && cards[i].isCard3rdFace!=\"Y\" && cards[i].contract_state==\"a\" && (cards[i].card_state==\"1\" || cards[i].card_state==\"5\") && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5) && ((cards[i].exdate.substr(0, 2) >= +curMonth && cards[i].exdate.substr(2) == +curY)  || (cards[i].exdate.substr(2) > +curY))) {\n        card = {\n              \"pan\":              cards[i].pan,\n              \"refcontract\":   cards[i].refcontract, \n              \"card_name\":  cards[i].card_name,\n              \"isGold\":          cards[i].isGold,\n              \"balance\":       cards[i].balance,\n              \"card_state\":   cards[i].card_state,\n              \"limit\":             cards[i].credit_limit,\n               \"remain\":        cards[i].remain,\n               \"ledgerbalance\": cards[i].ledgerbalance,\n               \"exdate\": cards[i].exdate\n    \t\t};\n        prod_arr.push(card);\n  \t}\n  }\n  \n  return prod_arr;\n}\n\nfunction exp_product_from_ARR(cards) {\n  var prod_arr = [];\n  var card = {};\n  var curMonth = compare(date.getMonth() + 1);\n  var curYear = date.getFullYear().toString().substr(2);\n  \n  for (var i=0; i<cards.length; i++) {\n  \tif (cards[i].product_type==\"KUN\" && +cards[i].currency==980 && cards[i].bank==\"PB\" && cards[i].isCard3rdFace!=\"Y\" && cards[i].contract_state==\"a\" && (cards[i].card_state==\"1\" || cards[i].card_state==\"5\") && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5)) {\n        if ( (+curMonth - (+cards[i].exdate.substr(0, 2)) >= 6 && cards[i].exdate.substr(2) == +curYear) || (+curYear - cards[i].exdate.substr(2) > 0 && (+curMonth + (12 - (+cards[i].exdate.substr(0, 2))) >= 6)) ) {\n        \tmsg.body.isEXPIRED = true;\n        }         \n        card = {\n              \"pan\":              cards[i].pan,\n              \"refcontract\":   cards[i].refcontract, \n              \"card_name\":  cards[i].card_name,\n              \"isGold\":          cards[i].isGold,\n              \"balance\":       cards[i].balance,\n              \"card_state\":   cards[i].card_state,\n              \"limit\":             cards[i].credit_limit,\n               \"remain\":        cards[i].remain,\n               \"ledgerbalance\": cards[i].ledgerbalance,\n               \"exdate\": cards[i].exdate\n    \t\t};\n        prod_arr.push(card);\n  \t}\n  }\n  return prod_arr;\n}\n\nfunction compareLimits(a, b) {\n  var A = a.credit_limit;\n  var B = b.credit_limit;\n  \n  return +B - (+A);\n}\n\nfunction getFlagGold(cards) {\n  var prod_arr = [];\n  \n  if (!Array.isArray(cards)) return \"N\";\n  \n  var card = {};\n  var curMonth = compare(date.getMonth() + 1);\n  var cur_Year = date.getFullYear().toString().substr(2);\n  \n  for (var i=0; i<cards.length; i++) {\n        if (cards[i].isGold==\"Y\" && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5) && ((cards[i].exdate.substr(0, 2) >= +curMonth && cards[i].exdate.substr(2) == +cur_Year)  || (cards[i].exdate.substr(2) > +cur_Year))) {\n        card = {\n              \"pan\":              cards[i].pan,\n              \"refcontract\":   cards[i].refcontract, \n              \"card_name\":  cards[i].card_name,\n              \"isGold\":          cards[i].isGold,\n              \"balance\":       cards[i].balance,\n              \"card_state\":   cards[i].card_state,\n              \"limit\":             cards[i].credit_limit,\n               \"remain\":        cards[i].remain,\n               \"ledgerbalance\": cards[i].ledgerbalance,\n               \"exdate\": cards[i].exdate\n    };\n        prod_arr.push(card);\n        }\n  }\n  if (prod_arr.length > 0) return \"Y\";\n  return \"N\";\n}\n\nfunction most_vip(prod_arr) {\n  var most = 0;\n  var most_el;\n\t\n  for (var z=0; z<prod_arr.length; z++) {\n  \tif (prod_arr[z].most_vip > most) {\n   \t\tmost_el = z;\n\t\t}\n\t}\n\treturn most_el;\n}\n\nfunction product_from_Vip_ARR(cards) {\n\tvar prod_arr = [], \n  \tcard = {},\n    prior_1 = [\"FORL\", \"FRE3\", \"EXI2\", \"PPF1\", \"REP1\", \"EXI1\", \"FRE1\", \"FOR1\", \"LOYD\", \"EXID\", \"VIPP\"],\n    prior_2 = [\"VIPE\"],\n    prior_3 = [\"MCWS\", \"MCWL\", \"WS55\", \"WS05\", \"WS0P\", \"WS5P\", \"MCWF\", \"WS00\", \"VIPW\"],\n    prior_4 = [\"INFI\", \"INFA\", \"INFL\", \"INPA\", \"INPI\", \"VIPI\"];\n\n\n\tfor (var i=0; i<cards.length; i++) {\n     if (cards[i].product_type == \"KUN\" && \n     /FORL|FRE3|EXI2|PPF1|REP1|EXI1|FRE1|FOR1|LOYD|EXID|VIPP|VIPE|MCWS|MCWL|WS55|WS05|WS0P|WS5P|MCWF|WS00|VIPW|INFI|INFA|INFL|INPA|INPI|VIPI/.test(cards[i].contract_type) && \n     +cards[i].currency==980 && \n     cards[i].bank==\"PB\" && \n     cards[i].isCard3rdFace==\"N\" && \n     cards[i].contract_state==\"a\" && \n     (cards[i].card_state==\"1\" || cards[i].card_state==\"5\") && \n     (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5) && \n     cards[i].pan.substr(0,9)!=\"545708221\" && \n     ((cards[i].exdate.substr(0, 2) >= +curMonth && cards[i].exdate.substr(2) == +curYear)  || (cards[i].exdate.substr(2) > +curYear)) && \n     cards[i].idekbOwn == cards[i].idEkbPan ) {\n\n        var most_vip;\n        if(prior_4.indexOf(cards[i].contract_type) != -1) {\n          most_vip = 4;\n        } else if(prior_3.indexOf(cards[i].contract_type) != -1) {\n          most_vip = 3;\n        } else if(prior_2.indexOf(cards[i].contract_type) != -1) {\n          most_vip = 2;\n        } else if(prior_1.indexOf(cards[i].contract_type) != -1) {\n          most_vip = 1;\n        }\n\n        card = {\n              \"pan\":                cards[i].pan,\n              \"refcontract\":        cards[i].refcontract, \n              \"card_name\":          cards[i].card_name,\n              \"isGold\":             cards[i].isGold,\n              \"contract_type\":      cards[i].contract_type,\n              \"most_vip\":           most_vip,\n              \"name_en\":            cards[i].card_name_en,\n              \"exdate\":             cards[i].exdate,\n              \"balance\":            cards[i].balance,\n              \"credit_limit\":       cards[i].credit_limit,\n               \"currency\":          cards[i].currency\n   \t\t\t};\n      \tprod_arr.push(card);\n\t\t}\n\t}\n\treturn prod_arr;\n}\n\nmsg.body.creditСards = msg.payload.prod_arr;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 920,
        "y": 300,
        "wires": [
            [
                "6ddbc49c.eb300c"
            ]
        ]
    },
    {
        "id": "6ddbc49c.eb300c",
        "type": "link out",
        "z": "f3825ecf.771b3",
        "name": "",
        "links": [
            "a3e824a7.d994b8"
        ],
        "x": 1095,
        "y": 300,
        "wires": []
    },
    {
        "id": "9af54b4f.9bad68",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "запишем в BODY ",
        "func": "if (typeof msg.body != \"object\") msg.body = {};\n\nmsg.body.ekb_info = msg.payload;\n\nmsg.payload = {};\n\n//msg.client_id = msg.body.ekb_info.client_id;\n\nif (msg.body.ekb_info.isVip === \"Y\" || msg.body.ekb_info.vip === \"Y\") {\n    msg.client_status = \"vip\";\n} else {\n    msg.client_status = \"?\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2170,
        "y": 260,
        "wires": [
            [
                "9e8495ec.3adff8"
            ]
        ]
    },
    {
        "id": "aa09dcdf.27ebc",
        "type": "debug",
        "z": "f3825ecf.771b3",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 1130,
        "y": 360,
        "wires": []
    },
    {
        "id": "395159a6.512e16",
        "type": "debug",
        "z": "f3825ecf.771b3",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 390,
        "y": 360,
        "wires": []
    },
    {
        "id": "2e6bb2da.84f30e",
        "type": "link in",
        "z": "c1799c47.0285e",
        "name": "Вход на ШАГ 1",
        "links": [
            "65090758.154f18"
        ],
        "x": 235,
        "y": 80,
        "wires": [
            [
                "202811ba.5bfb2e"
            ]
        ]
    },
    {
        "id": "202811ba.5bfb2e",
        "type": "function",
        "z": "c1799c47.0285e",
        "name": "Готовим запрос ШАГ 1 в НРМ ",
        "func": "//запишем входные параметры в BODY\nmsg.body = JSON.perse(msg.payload);\n\n//зачистим PAYLOAD\nmsg.payload = {\"channel\": \"trin\"};\n\n//формируем запрос в НРМ \nif (msg.body.type != \"TEST\") {\n    msg.type = \"PROD\";\n    msg.sid = global.get(\"siddeclines\");\n    \n    msg.payload.client_id = msg.body.clid;\n    msg.payload.pan = msg.body.pan;\n    \n} else {\n    msg.type = \"TEST\";\n    msg.sid = msg.SID  //тестовая сессия\n    \n    msg.payload.client_id = msg.body.clid;\n    msg.payload.pan = msg.body.pan;\n    \n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\",\n    \"Accept\": \"application/json\",\n    \"sid\": msg.sid\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 410,
        "y": 120,
        "wires": [
            [
                "83c57b53.958288",
                "1d7692f3.17ef2d"
            ]
        ]
    },
    {
        "id": "32ea1679.8fc1da",
        "type": "http request",
        "z": "c1799c47.0285e",
        "name": "ШАГ 1 - Проверка (PROD)",
        "method": "POST",
        "ret": "txt",
        "url": "http://app1.rtdm.dp.loc:3535/SituationalUpLimit/P1",
        "tls": "",
        "x": 860,
        "y": 120,
        "wires": [
            [
                "4ef6c787.22a438"
            ]
        ]
    },
    {
        "id": "656c810a.3bf7b",
        "type": "link out",
        "z": "c1799c47.0285e",
        "name": "Выход ШАГ 1",
        "links": [
            "88b3e342.6a2e4"
        ],
        "x": 1255,
        "y": 120,
        "wires": []
    },
    {
        "id": "a92b2b4a.20ec68",
        "type": "link out",
        "z": "c1799c47.0285e",
        "name": "Выход ШАГ 2",
        "links": [],
        "x": 1255,
        "y": 240,
        "wires": []
    },
    {
        "id": "7381a10a.57464",
        "type": "link in",
        "z": "c1799c47.0285e",
        "name": "Вход на ШАГ 2",
        "links": [],
        "x": 235,
        "y": 200,
        "wires": [
            [
                "52ddbe82.9e022"
            ]
        ]
    },
    {
        "id": "52ddbe82.9e022",
        "type": "function",
        "z": "c1799c47.0285e",
        "name": "Готовим запрос ШАГ 2 в НРМ ",
        "func": "//запишем входные параметры в BODY\nmsg.body = JSON.perse(msg.payload);\n\n//зачистим PAYLOAD\nmsg.payload = {};\n\n//формируем запрос в НРМ \nif (msg.body.type != \"TEST\") {\n    msg.type = \"PROD\";\n    msg.sid = global.get(\"siddeclines\");\n    \n    msg.payload.ref = msg.body.ref;\n    msg.payload.clientAgree = msg.body.clientAgree; // Y|N\n    \n} else {\n    msg.type = \"TEST\";\n    msg.sid = msg.SID  //тестовая сессия\n    \n    msg.payload.ref = msg.body.ref;\n    msg.payload.clientAgree = msg.body.clientAgree; // Y|N\n    \n}\n\nmsg.headers = {\n    \"content-type\":\"application/json\",\n    \"Accept\": \"application/json\",\n    \"sid\": msg.sid\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 410,
        "y": 240,
        "wires": [
            [
                "b2f1f184.ca79c",
                "2721c751.0f0fb8"
            ]
        ]
    },
    {
        "id": "f311f94d.45ba98",
        "type": "http request",
        "z": "c1799c47.0285e",
        "name": "Шаг 2 - Увеличение (TEST)",
        "method": "POST",
        "ret": "txt",
        "url": "http://app-rtdm.test.it.loc:3535/SituationalUpLimit/P2",
        "tls": "",
        "x": 860,
        "y": 240,
        "wires": [
            [
                "29363274.00884e"
            ]
        ]
    },
    {
        "id": "4ef6c787.22a438",
        "type": "function",
        "z": "c1799c47.0285e",
        "name": "парсим ответ НРМ",
        "func": "msg.payload = JSON.parse(msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 120,
        "wires": [
            [
                "656c810a.3bf7b",
                "9dc57c28.db583"
            ]
        ]
    },
    {
        "id": "29363274.00884e",
        "type": "function",
        "z": "c1799c47.0285e",
        "name": "парсим ответ НРМ",
        "func": "msg.payload = JSON.parse(msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 240,
        "wires": [
            [
                "a92b2b4a.20ec68",
                "9dc57c28.db583"
            ]
        ]
    },
    {
        "id": "2d1a4c54.156504",
        "type": "http request",
        "z": "c1799c47.0285e",
        "name": "ШАГ 1 - Проверка (TEST)",
        "method": "POST",
        "ret": "txt",
        "url": "http://app-rtdm.test.it.loc:3535/SituationalUpLimit/P1",
        "tls": "",
        "x": 860,
        "y": 80,
        "wires": [
            [
                "4ef6c787.22a438"
            ]
        ]
    },
    {
        "id": "83c57b53.958288",
        "type": "switch",
        "z": "c1799c47.0285e",
        "name": "Фильтр PROD",
        "property": "type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "PROD",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 640,
        "y": 120,
        "wires": [
            [
                "32ea1679.8fc1da"
            ]
        ]
    },
    {
        "id": "1d7692f3.17ef2d",
        "type": "switch",
        "z": "c1799c47.0285e",
        "name": "Фильтр TEST",
        "property": "type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "TEST",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 640,
        "y": 80,
        "wires": [
            [
                "2d1a4c54.156504"
            ]
        ]
    },
    {
        "id": "3c8129ba.4531c6",
        "type": "http request",
        "z": "c1799c47.0285e",
        "name": "Шаг 2 - Увеличение (PROD)",
        "method": "POST",
        "ret": "txt",
        "url": "http://app1.rtdm.dp.loc:3535/SituationalUpLimit/P2",
        "tls": "",
        "x": 860,
        "y": 280,
        "wires": [
            [
                "29363274.00884e"
            ]
        ]
    },
    {
        "id": "2721c751.0f0fb8",
        "type": "switch",
        "z": "c1799c47.0285e",
        "name": "Фильтр PROD",
        "property": "type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "PROD",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 640,
        "y": 280,
        "wires": [
            [
                "3c8129ba.4531c6"
            ]
        ]
    },
    {
        "id": "b2f1f184.ca79c",
        "type": "switch",
        "z": "c1799c47.0285e",
        "name": "Фильтр TEST",
        "property": "type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "TEST",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 640,
        "y": 240,
        "wires": [
            [
                "f311f94d.45ba98"
            ]
        ]
    },
    {
        "id": "9dc57c28.db583",
        "type": "http response",
        "z": "c1799c47.0285e",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1300,
        "y": 180,
        "wires": []
    },
    {
        "id": "b882ee76.4358f",
        "type": "http in",
        "z": "c1799c47.0285e",
        "name": "POST запрос на ШАГ 1",
        "url": "/getNrmFirstStep",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 120,
        "wires": [
            [
                "202811ba.5bfb2e"
            ]
        ]
    },
    {
        "id": "ce118ef2.95b8b",
        "type": "http in",
        "z": "c1799c47.0285e",
        "name": "POST запрос на ШАГ 2",
        "url": "/setNewLimit",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 240,
        "wires": [
            [
                "52ddbe82.9e022"
            ]
        ]
    },
    {
        "id": "ce22f326.c395c",
        "type": "debug",
        "z": "81e3836.4637a8",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 350,
        "y": 360,
        "wires": []
    },
    {
        "id": "a6b88147.4b4b7",
        "type": "debug",
        "z": "81e3836.4637a8",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 1030,
        "y": 340,
        "wires": []
    },
    {
        "id": "fe0c151c.646d48",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "1. Старт процесса проверки ",
        "info": "",
        "x": 180,
        "y": 160,
        "wires": []
    },
    {
        "id": "11ddc6d1.fb13c9",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "3.1. Поиска карты с лимитом",
        "info": "",
        "x": 1600,
        "y": 340,
        "wires": []
    },
    {
        "id": "9610dc24.8e052",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "3.2. Фильтруем подходящих клиентов",
        "info": "",
        "x": 2370,
        "y": 340,
        "wires": []
    },
    {
        "id": "cfa9fc51.b0249",
        "type": "http request",
        "z": "1e197245.dfdf2e",
        "name": "Создание сессии",
        "method": "POST",
        "ret": "obj",
        "url": "https://promin.privatbank.ua:8072/ChameleonServer/sessions/open",
        "tls": "",
        "x": 590,
        "y": 320,
        "wires": [
            [
                "c92dd9a4.e6c2f8",
                "361cef4.274cf1"
            ]
        ]
    },
    {
        "id": "10244c32.d43ba4",
        "type": "function",
        "z": "1e197245.dfdf2e",
        "name": "Параметры новой сессии",
        "func": "msg.payload = {\n    \"user\": {\"login\":\"conveyor84049\",\"password\":\"CyEud8iygZYjRgez69oA\",\"auth\":\"EXCL\"}\n};\n\nmsg.headers = {\n    \"Content-Type\": \"application/json;charset=UTF-8\",\n    \"Accept\": \"application/json;charset=UTF-8\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 320,
        "y": 320,
        "wires": [
            [
                "cfa9fc51.b0249"
            ]
        ]
    },
    {
        "id": "71c90d94.d75684",
        "type": "change",
        "z": "1e197245.dfdf2e",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "body",
                "pt": "global",
                "to": "body",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1260,
        "y": 320,
        "wires": [
            [
                "703bc676.924b78"
            ]
        ]
    },
    {
        "id": "703bc676.924b78",
        "type": "debug",
        "z": "1e197245.dfdf2e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 1430,
        "y": 320,
        "wires": []
    },
    {
        "id": "5f8f1b58.cc6eb4",
        "type": "debug",
        "z": "1e197245.dfdf2e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 1270,
        "y": 120,
        "wires": []
    },
    {
        "id": "bb2c889e.af0908",
        "type": "http request",
        "z": "1e197245.dfdf2e",
        "name": "Запрос на проверку",
        "method": "GET",
        "ret": "obj",
        "paytoqs": false,
        "url": "https://promin.privatbank.ua:8072/ChameleonServer/sessions/get/{{value}}",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 860,
        "y": 120,
        "wires": [
            [
                "2ebac40.1170e3c"
            ]
        ]
    },
    {
        "id": "1706dfbf.0418a",
        "type": "function",
        "z": "1e197245.dfdf2e",
        "name": "Активная сессия",
        "func": "msg.value = global.get(\"body\").SID ;\n\nif (typeof msg.value === \"undefined\") global.set(\"body\").SID = \"190830csb26uzzfo9zee\"; \n\nmsg.headers = {\n    \"Content-Type\": \"application/json;charset=UTF-8\",\n    \"Accept\": \"application/json;charset=UTF-8\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 370,
        "y": 120,
        "wires": [
            [
                "bb2c889e.af0908"
            ]
        ]
    },
    {
        "id": "2ebac40.1170e3c",
        "type": "switch",
        "z": "1e197245.dfdf2e",
        "name": "Фильтр упавшей сессии",
        "property": "payload.state",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "ACTIVE",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1090,
        "y": 120,
        "wires": [
            [
                "10244c32.d43ba4",
                "5f8f1b58.cc6eb4"
            ]
        ]
    },
    {
        "id": "87f04ec1.bbe2",
        "type": "function",
        "z": "1e197245.dfdf2e",
        "name": "заберем сессию",
        "func": "msg.body = {\n    \"SID\": msg.payload.id\n};\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1050,
        "y": 320,
        "wires": [
            [
                "71c90d94.d75684"
            ]
        ]
    },
    {
        "id": "361cef4.274cf1",
        "type": "switch",
        "z": "1e197245.dfdf2e",
        "name": "Фильтр ТЕСТового ЕКБ",
        "property": "payload.code",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "L0016",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 830,
        "y": 400,
        "wires": [
            [
                "e89070cf.8a5e3"
            ]
        ]
    },
    {
        "id": "c92dd9a4.e6c2f8",
        "type": "switch",
        "z": "1e197245.dfdf2e",
        "name": "Фильтр боевого ЕКБ",
        "property": "payload.code",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "200",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 820,
        "y": 320,
        "wires": [
            [
                "87f04ec1.bbe2"
            ]
        ]
    },
    {
        "id": "fcb45eec.683af",
        "type": "inject",
        "z": "1e197245.dfdf2e",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 100,
        "y": 320,
        "wires": [
            [
                "10244c32.d43ba4"
            ]
        ]
    },
    {
        "id": "9c3bcded.45da8",
        "type": "debug",
        "z": "1e197245.dfdf2e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 1430,
        "y": 560,
        "wires": []
    },
    {
        "id": "d914f581.0987d8",
        "type": "debug",
        "z": "1e197245.dfdf2e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 210,
        "y": 240,
        "wires": []
    },
    {
        "id": "5fee3a34.5c95a4",
        "type": "inject",
        "z": "1e197245.dfdf2e",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 780,
        "y": 500,
        "wires": [
            [
                "ba4a4f61.46d38"
            ]
        ]
    },
    {
        "id": "ba4a4f61.46d38",
        "type": "function",
        "z": "1e197245.dfdf2e",
        "name": "",
        "func": "msg.payload = {\n    \"SID\": \"190830csb26uzzfo9zee\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 500,
        "wires": [
            [
                "cdeecb55.77bb78"
            ]
        ]
    },
    {
        "id": "e89070cf.8a5e3",
        "type": "function",
        "z": "1e197245.dfdf2e",
        "name": "",
        "func": "msg.payload = {\n    \"cbUrl\": \"http://10.56.3.187:1965/session\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1030,
        "y": 400,
        "wires": [
            [
                "13b9f33d.e3765d"
            ]
        ]
    },
    {
        "id": "e235517f.b9c5d",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Проверяем карту",
        "func": "if (typeof msg.most_vip != \"undefined\") {\n    msg.pan = msg.body.creditСards[msg.most_vip].pan;\n    msg.refcontract = msg.body.creditСards[msg.most_vip].refcontract;\n    msg.card_name_en = msg.body.creditСards[msg.most_vip].name_en;\n    msg.limit = msg.body.creditСards[msg.most_vip].limit;\n} else if (msg.body.creditСards.length > 0) {\n     if (msg.body.creditСards[0].isGold == 'Y') {\n        msg.client_status = 'gold';\n        msg.is_GOLD = \"Y\";\n     } else {\n        msg.client_status = 'uni';\n        msg.is_GOLD = \"N\";\n     }\n    msg.pan = msg.body.creditСards[0].pan;\n    msg.refcontract = msg.body.creditСards[0].refcontract;\n    msg.card_name_en = msg.body.creditСards[0].name_en;\n    msg.balance = msg.body.creditСards[0].balance;\n    msg.currency = msg.body.creditСards[0].currency;\n    msg.limit = msg.body.creditСards[0].limit;\n} else {\n     msg.description = \"Нет карты универсальной / универсальной голд\";\n     msg.code = '400';\n     msg.is_GOLD = \"?\";\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2090,
        "y": 380,
        "wires": [
            [
                "7132417c.d8df",
                "4bac26f1.7726f8"
            ]
        ]
    },
    {
        "id": "7132417c.d8df",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "Клиент с картой",
        "property": "code",
        "propertyType": "msg",
        "rules": [
            {
                "t": "neq",
                "v": "400",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2310,
        "y": 420,
        "wires": [
            [
                "63d417f0.cf9cb8"
            ]
        ]
    },
    {
        "id": "4bac26f1.7726f8",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "Клиент БЕЗ карты",
        "property": "code",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "400",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2310,
        "y": 380,
        "wires": [
            [
                "44fffaf6.98f714"
            ]
        ]
    },
    {
        "id": "ec391d49.e4b5f",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "2. Проверка показов в REDIS ",
        "info": "",
        "x": 750,
        "y": 160,
        "wires": []
    },
    {
        "id": "8f83dde8.c3ae9",
        "type": "catch",
        "z": "1e197245.dfdf2e",
        "name": "",
        "scope": [
            "1706dfbf.0418a"
        ],
        "uncaught": false,
        "x": 70,
        "y": 240,
        "wires": [
            [
                "10244c32.d43ba4",
                "d914f581.0987d8"
            ]
        ]
    },
    {
        "id": "7ed0c51b.54291c",
        "type": "link out",
        "z": "1cc16612.5125da",
        "name": "RedisFinish",
        "links": [
            "9f1d35e2.d44a18"
        ],
        "x": 955,
        "y": 360,
        "wires": []
    },
    {
        "id": "6df6caff.97ef44",
        "type": "link in",
        "z": "1cc16612.5125da",
        "name": "RedisStart",
        "links": [
            "b1f236fa.c7aa48",
            "2e21ebcc.4bf554"
        ],
        "x": 255,
        "y": 300,
        "wires": [
            [
                "b50b01b0.90657"
            ]
        ]
    },
    {
        "id": "b50b01b0.90657",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "",
        "func": "//msg.isWatched = \"false\";\n\nmsg.payload = [msg.client_id];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 300,
        "wires": [
            [
                "61be31fd.90c9c"
            ]
        ]
    },
    {
        "id": "490724d4.6e5adc",
        "type": "switch",
        "z": "1cc16612.5125da",
        "name": "Не показывали ",
        "property": "isWatched",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "false",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 840,
        "y": 360,
        "wires": [
            [
                "7ed0c51b.54291c",
                "d0de0966.37f6e8"
            ]
        ]
    },
    {
        "id": "117d32b1.36a81d",
        "type": "switch",
        "z": "1cc16612.5125da",
        "name": "Показывали ",
        "property": "isWatched",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 830,
        "y": 300,
        "wires": [
            [
                "59bc939a.1856ec",
                "50034d57.76c7d4"
            ]
        ]
    },
    {
        "id": "59bc939a.1856ec",
        "type": "link out",
        "z": "1cc16612.5125da",
        "name": "RedisFinal",
        "links": [
            "aee23e62.8ad68"
        ],
        "x": 955,
        "y": 300,
        "wires": []
    },
    {
        "id": "e5b9a950.15fc88",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "var nrm_solution = {\n    \"limUP\": \"N\",\n    \"client_id\": msg.client_id,\n    \"source\": msg.source,\n    \"descript\": \"Запрещено показывать предложение в канале \" + msg.source\n};\n\nmsg.payload = {\"nrm_solution\": nrm_solution};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1450,
        "y": 140,
        "wires": [
            [
                "9019b125.7925c"
            ]
        ]
    },
    {
        "id": "9646bdb6.eeb6a",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "ОТВЕТ: Показывали ранее",
        "info": "",
        "x": 1520,
        "y": 100,
        "wires": []
    },
    {
        "id": "25bc73a4.e488bc",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "var nrm_solution = {\n    \"limUP\": \"N\",\n    \"descript\": \"Нет возможности увеличить кредитный лимит. Нет карты для увеличения лимита\"\n};\n\nmsg.payload = {\"nrm_solution\": nrm_solution};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2930,
        "y": 380,
        "wires": [
            [
                "9019b125.7925c"
            ]
        ]
    },
    {
        "id": "f117c7c1.3137f8",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "ОТВЕТ: Нет карты",
        "info": "",
        "x": 2970,
        "y": 340,
        "wires": []
    },
    {
        "id": "fb3e3cda.25d3d",
        "type": "http request",
        "z": "1e3801f3.ffb9ae",
        "name": "Слить клиента без карты на ЦП",
        "method": "POST",
        "ret": "txt",
        "paytoqs": false,
        "url": "https://cp.privatbank.ua/api/1/json/public/159634/3384e25ec90cd5622cfbba56bf97e693f72cadbd",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 2700,
        "y": 380,
        "wires": [
            [
                "25bc73a4.e488bc"
            ]
        ]
    },
    {
        "id": "44fffaf6.98f714",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload = {\n    \"client_id\": msg.client_id,\n    \"description\": \"Нет карты для установки лимита\",\n    \"is_GOLD\": msg.is_GOLD || \"-\",\n    \"source\": msg.source,\n    \"is_vip\": msg.is_vip || \"-\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2470,
        "y": 380,
        "wires": [
            [
                "fb3e3cda.25d3d"
            ]
        ]
    },
    {
        "id": "603a1140.827c1",
        "type": "catch",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "scope": [],
        "uncaught": false,
        "x": 2250,
        "y": 1020,
        "wires": [
            [
                "293a9932.510316"
            ]
        ]
    },
    {
        "id": "4724ec77.c98614",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "ОТВЕТ: Ошибка",
        "info": "",
        "x": 2520,
        "y": 960,
        "wires": []
    },
    {
        "id": "293a9932.510316",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "var nrm_solution = {\n    \"limUP\": \"N\",\n    \"descript\": \"Ошибка процесса\"\n};\n\nmsg.payload = {\"nrm_solution\": nrm_solution};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2390,
        "y": 1020,
        "wires": [
            [
                "d3ad5b9a.0609c8",
                "afefd501.3b8ae8"
            ]
        ]
    },
    {
        "id": "d3ad5b9a.0609c8",
        "type": "http response",
        "z": "1e3801f3.ffb9ae",
        "name": "ERROR",
        "statusCode": "500",
        "headers": {},
        "x": 2540,
        "y": 1020,
        "wires": []
    },
    {
        "id": "afefd501.3b8ae8",
        "type": "debug",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 2530,
        "y": 1060,
        "wires": []
    },
    {
        "id": "c2b80ac6.9ffe08",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "4. Запрашиваем данные в НРМ ШАГ_1",
        "info": "",
        "x": 2660,
        "y": 500,
        "wires": []
    },
    {
        "id": "63d417f0.cf9cb8",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload = {\n    \"pan\": msg.pan,\n    \"step\": \"1\",\n    \"refcontract\": msg.refcontract,\n    \"source\": msg.source,\n    \"client_id\": msg.client_id,\n    \"callBack\": msg.cb_url,\n    \"limit\": msg.limit,\n    \"nodeProcURL\": \"http://10.56.3.187:1965/setNrmStep1\"\n};\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2470,
        "y": 420,
        "wires": [
            [
                "5579bee0.6123e"
            ]
        ]
    },
    {
        "id": "1ffa74a6.9aeb0b",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "6. Старт ШАГ_2",
        "info": "",
        "x": 140,
        "y": 980,
        "wires": []
    },
    {
        "id": "7fc04232.c9d4dc",
        "type": "http in",
        "z": "1e3801f3.ffb9ae",
        "name": "API: setNewLimit",
        "url": "/setNewLimit",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 1040,
        "wires": [
            [
                "b944b1cd.cdf8b"
            ]
        ]
    },
    {
        "id": "65cc878c.fd0cd8",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload = {\n    \"newlimit\": msg.newlimit,\n    \"src\": msg.source,\n    \"nrmRef \": msg.nrmRef,\n    \"crmRef \": msg.crmRef,\n    \"client_id\": msg.client_id,\n    \"pan\": msg.pan,\n    \"oldlim\": msg.oldlim,\n\t\"refcontract\": msg.refcontract,\n    \"nodeProcURL\": \"http://10.56.3.187:1965/setNrmStep2\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 1260,
        "wires": [
            [
                "6d846486.78690c"
            ]
        ]
    },
    {
        "id": "9d118302.f5ca8",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "8. Отправка на cp -> СМС",
        "info": "",
        "x": 2590,
        "y": 1300,
        "wires": []
    },
    {
        "id": "af5bab26.9d5a48",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "9. Отправка на cp -> витрину",
        "info": "",
        "x": 2960,
        "y": 1300,
        "wires": []
    },
    {
        "id": "b5b72b5.f5412d8",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "10. Запись на cp -> ЕЛО",
        "info": "",
        "x": 3330,
        "y": 1300,
        "wires": []
    },
    {
        "id": "298ab2b9.5d828e",
        "type": "link out",
        "z": "7a3f5df8.227004",
        "name": "Finish ЦП",
        "links": [],
        "x": 555,
        "y": 140,
        "wires": []
    },
    {
        "id": "3af7d007.524f7",
        "type": "link in",
        "z": "7a3f5df8.227004",
        "name": "Start на ЦП",
        "links": [],
        "x": 95,
        "y": 140,
        "wires": [
            [
                "3b19f9af.143616"
            ]
        ]
    },
    {
        "id": "3b19f9af.143616",
        "type": "function",
        "z": "7a3f5df8.227004",
        "name": "",
        "func": "msg.data = msg.payload;\n\nmsg.ops = [];\nmsg.ops.push({\n    \"conv_id\": msg.conv_id,\n    \"ref\": msg.ref,\n    \"type\": \"create\",\n    \"obj\": \"task\",\n    \"data\": msg.data\n});\n\nmsg.payload = JSON.stringify({\n    \"ops\": msg.ops\n});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 220,
        "y": 140,
        "wires": [
            [
                "2b79038e.277d8c"
            ]
        ]
    },
    {
        "id": "2b79038e.277d8c",
        "type": "http request",
        "z": "7a3f5df8.227004",
        "name": "",
        "method": "POST",
        "ret": "txt",
        "url": "{{{directUpload}}}",
        "tls": "",
        "x": 410,
        "y": 140,
        "wires": [
            [
                "298ab2b9.5d828e"
            ]
        ]
    },
    {
        "id": "70c607.bcb359f8",
        "type": "catch",
        "z": "7a3f5df8.227004",
        "name": "",
        "scope": [
            "2b79038e.277d8c"
        ],
        "x": 390,
        "y": 220,
        "wires": [
            [
                "48de6654.7465e8"
            ]
        ]
    },
    {
        "id": "48de6654.7465e8",
        "type": "debug",
        "z": "7a3f5df8.227004",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 540,
        "y": 220,
        "wires": []
    },
    {
        "id": "87dc817e.76ed2",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.data = {\n    \"pan\": msg.pan,\n    \"refcontract\": msg.refcontract,\n    \"client_id\": msg.client_id,\n    \"old_limit\": msg.limit,\n    \"mode_lim\": msg.mode_lim,\n    \"from\": \"140003\",\n    \"gr\": msg.client_status,\n    \"new_limit\": msg.newlimit\n};\n\nmsg.ops = [];\nmsg.ops.push({\n    \"conv_id\": \"182693\",\n    \"ref\": msg.client_id + \"_up\",\n    \"type\": \"create\",\n    \"obj\": \"task\",\n    \"data\": msg.data\n});\n\nmsg.payload = JSON.stringify({\n    \"ops\": msg.ops\n});\n\nmsg.smsUrl = \"/182693/50f973fe3263f58ac39b91fd15aa3ee3c66fea9b\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2530,
        "y": 1360,
        "wires": [
            [
                "13b253cf.0c6a3c"
            ]
        ]
    },
    {
        "id": "13b253cf.0c6a3c",
        "type": "http request",
        "z": "1e3801f3.ffb9ae",
        "name": "отправка СМС с ЦП",
        "method": "POST",
        "ret": "txt",
        "paytoqs": false,
        "url": "https://cp.privatbank.ua/api/1/json/public{{{smsUrl}}}",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 2700,
        "y": 1360,
        "wires": [
            [
                "6fe9a22c.e2339c"
            ]
        ]
    },
    {
        "id": "6fe9a22c.e2339c",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.data = {\n    \"pan\": msg.pan,\n    \"refcontract\": msg.refcontract,\n    \"client_id\": msg.client_id,\n    \"lim\": msg.limit,\n    \"mode_lim\": msg.mode_lim,\n    \"CONV_ID\": \"140003\",\n    \"gr\": msg.client_status,\n    \"newlimit\": msg.newlimit,\n    \"sourse\": msg.source,\n    \"statusUP\": msg.statusUP,\n    \"skk_ref\": msg.skk_ref\n};\n\nmsg.ops = [];\nmsg.ops.push({\n    \"conv_id\": \"183162\",\n    \"ref\": msg.client_id,\n    \"type\": \"create\",\n    \"obj\": \"task\",\n    \"data\": msg.data\n});\n\nmsg.payload = JSON.stringify({\n    \"ops\": msg.ops\n});\n\nmsg.vitUrl = \"/183162/9e0764e60657025c5f9798cabf7822c0858b2cd9\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2890,
        "y": 1360,
        "wires": [
            [
                "92e02f3e.7b2e5"
            ]
        ]
    },
    {
        "id": "92e02f3e.7b2e5",
        "type": "http request",
        "z": "1e3801f3.ffb9ae",
        "name": "отправка на витрину СР",
        "method": "POST",
        "ret": "txt",
        "paytoqs": false,
        "url": "https://cp.privatbank.ua/api/1/json/public{{{vitUrl}}}",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 3070,
        "y": 1360,
        "wires": [
            [
                "65f2d332.904e2c"
            ]
        ]
    },
    {
        "id": "65f2d332.904e2c",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "var time = new Date().getTime() + \"\";\n\nmsg.data = {\n    \"pan\": msg.pan,\n    \"refcontract\": msg.refcontract,\n    \"client_id\": msg.client_id,\n    \"old_limit\": msg.limit,\n    \"mode_lim\": msg.mode_lim,\n    \"from\": \"140003\",\n    \"gr\": msg.client_status,\n    \"new_limit\": msg.newlimit,\n    \"result\": \"success\",\n    \"RES_DEC_FINAL_COMMENT_RUS\": \"\",\n    \"id\": \"nodeRed_209502_\"+msg.client_id,\n    \"pointType\": \"Предложение в канале: \" + msg.source,\n    \"create_time\": time.substr(0, 10),\n    \"operation\": \"UP\",\n    \"refuseCodes\": \"statusUP: \" + msg.statusUP + \", mode_lim: \" + msg.mode_lim,\n    \"cardLimit\": msg.limit,\n    \"limitFinal\": msg.newlimit,\n    \"selectedLimit\": msg.newlimit,\n    \"REF\": msg.client_id,\n    \"ref\": msg.skkRef,\n    \"cardName\": \"Универсальная / Универсальная ГОЛД\",\n    \"change_time\": time.substr(0, 10)\n};\n\nmsg.ops = [];\nmsg.ops.push({\n    \"conv_id\": \"186149\",\n    \"ref\": msg.client_id,\n    \"type\": \"create\",\n    \"obj\": \"task\",\n    \"data\": msg.data\n});\n\nmsg.payload = JSON.stringify({\n    \"ops\": msg.ops\n});\n\nmsg.eloUrl = \"/186149/ec372be05829dc3eff43dd98f8b91553a0e48973\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3270,
        "y": 1360,
        "wires": [
            [
                "9a60416a.b457c"
            ]
        ]
    },
    {
        "id": "9a60416a.b457c",
        "type": "http request",
        "z": "1e3801f3.ffb9ae",
        "name": "отправка ЕЛО с ЦП",
        "method": "POST",
        "ret": "txt",
        "paytoqs": false,
        "url": "https://cp.privatbank.ua/api/1/json/public{{{eloUrl}}}",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 3440,
        "y": 1360,
        "wires": [
            []
        ]
    },
    {
        "id": "61be31fd.90c9c",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "get",
        "name": "REDIS GET",
        "topic": "",
        "x": 510,
        "y": 300,
        "wires": [
            [
                "554a7a7.a0c8084"
            ]
        ]
    },
    {
        "id": "2f0ab8b3.b7dd78",
        "type": "inject",
        "z": "1cc16612.5125da",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 160,
        "y": 240,
        "wires": [
            [
                "927ee29.ca44a2"
            ]
        ]
    },
    {
        "id": "927ee29.ca44a2",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "",
        "func": "msg.client_id = \"12243729\";\n\nmsg.source = \"3700\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 290,
        "y": 240,
        "wires": [
            [
                "b50b01b0.90657"
            ]
        ]
    },
    {
        "id": "554a7a7.a0c8084",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "",
        "func": "if (msg.payload === null) {\n    msg.isWatched = \"false\";\n} else {\n    //разберем ответ от редиса \"{\"3700\":1568784693809}\"\n\n    var payload = JSON.parse(msg.payload);\n    msg.REDIS = payload;\n    var time = new Date().getTime();\n    \n    if (typeof payload[msg.source] != \"undefined\" && time < payload[msg.source] + (86400000 * 30) ) {\n        msg.isWatched = \"true\";\n    } else if (time > payload[msg.source] + (86400000 * 30)) {\n        msg.isWatched = \"false\";\n        msg.toReload = \"true\";\n        delete payload[msg.source];\n        msg.REDIS = payload;\n    } else {\n        msg.isWatched = \"false\";\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 300,
        "wires": [
            [
                "117d32b1.36a81d",
                "490724d4.6e5adc",
                "163445.a467fbbb"
            ]
        ]
    },
    {
        "id": "50034d57.76c7d4",
        "type": "debug",
        "z": "1cc16612.5125da",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 990,
        "y": 240,
        "wires": []
    },
    {
        "id": "b5c1e099.0ae7b",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "",
        "func": "//msg.isWatched = \"false\";\n\nvar obj = {};\nobj[msg.source] = new Date().getTime();\n//obj[msg.source] = msg.client_id == \"12243729\" ? 1550613600000 : new Date().getTime();\n\nvar value = JSON.stringify(obj);\n\nmsg.payload = [msg.client_id, value];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 680,
        "wires": [
            [
                "7a115880.5f7598",
                "9d941e69.c8d55"
            ]
        ]
    },
    {
        "id": "7a115880.5f7598",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "set",
        "name": "REDIS SET",
        "topic": "",
        "x": 1210,
        "y": 600,
        "wires": [
            [
                "f94ff73.81e9c08"
            ]
        ]
    },
    {
        "id": "3420eeb7.7282b2",
        "type": "inject",
        "z": "1cc16612.5125da",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 180,
        "y": 600,
        "wires": [
            [
                "9b18de3b.d9c31"
            ]
        ]
    },
    {
        "id": "6f0c6f65.16b22",
        "type": "link in",
        "z": "1cc16612.5125da",
        "name": "",
        "links": [],
        "x": 915,
        "y": 680,
        "wires": [
            [
                "b5c1e099.0ae7b"
            ]
        ]
    },
    {
        "id": "58d9826e.db323c",
        "type": "comment",
        "z": "1cc16612.5125da",
        "name": "проверка показа",
        "info": "",
        "x": 160,
        "y": 180,
        "wires": []
    },
    {
        "id": "649060e2.d5b1c",
        "type": "comment",
        "z": "1cc16612.5125da",
        "name": "Запись информации",
        "info": "",
        "x": 180,
        "y": 540,
        "wires": []
    },
    {
        "id": "9b18de3b.d9c31",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "",
        "func": "msg.client_id = \"12243729\";\n\nmsg.source = \"3700\";\n\nmsg.payload = [msg.client_id];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 600,
        "wires": [
            [
                "43d84c57.cd4174"
            ]
        ]
    },
    {
        "id": "50ad7451.25160c",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "del",
        "name": "REDIS DEL",
        "topic": "",
        "x": 1170,
        "y": 420,
        "wires": [
            [
                "13780b26.c671a5"
            ]
        ]
    },
    {
        "id": "163445.a467fbbb",
        "type": "switch",
        "z": "1cc16612.5125da",
        "name": "Перезаписать",
        "property": "toReload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 840,
        "y": 420,
        "wires": [
            [
                "31afc27d.f07ece"
            ]
        ]
    },
    {
        "id": "31afc27d.f07ece",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "",
        "func": "//msg.isWatched = \"false\";\n\nmsg.payload = [msg.client_id];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 420,
        "wires": [
            [
                "50ad7451.25160c",
                "43e08860.c12968"
            ]
        ]
    },
    {
        "id": "13780b26.c671a5",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "RESET",
        "func": "msg.payload = [msg.client_id, JSON.stringify(msg.REDIS)];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1020,
        "y": 600,
        "wires": [
            [
                "7a115880.5f7598",
                "9d941e69.c8d55"
            ]
        ]
    },
    {
        "id": "d0de0966.37f6e8",
        "type": "debug",
        "z": "1cc16612.5125da",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1050,
        "y": 360,
        "wires": []
    },
    {
        "id": "43e08860.c12968",
        "type": "debug",
        "z": "1cc16612.5125da",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1270,
        "y": 360,
        "wires": []
    },
    {
        "id": "43d84c57.cd4174",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "get",
        "name": "REDIS GET",
        "topic": "",
        "x": 490,
        "y": 600,
        "wires": [
            [
                "7e6593e9.fea7dc"
            ]
        ]
    },
    {
        "id": "7e6593e9.fea7dc",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "",
        "func": "msg.is = \"false\";\n\nif (typeof msg.payload == \"string\") {\n    msg.REDIS = JSON.parse(msg.payload);\n    //msg.REDIS[msg.source] = msg.client_id == \"12243729\" ? 1550613600000 : new Date().getTime();\n    msg.REDIS[msg.source] = new Date().getTime();\n    msg.is = \"true\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 600,
        "wires": [
            [
                "a334fc4.94d6",
                "a10d2f40.f0375"
            ]
        ]
    },
    {
        "id": "a334fc4.94d6",
        "type": "switch",
        "z": "1cc16612.5125da",
        "name": "Есть запись",
        "property": "is",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 810,
        "y": 600,
        "wires": [
            [
                "13780b26.c671a5"
            ]
        ]
    },
    {
        "id": "a10d2f40.f0375",
        "type": "switch",
        "z": "1cc16612.5125da",
        "name": "Нет записи",
        "property": "is",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "false",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 810,
        "y": 680,
        "wires": [
            [
                "b5c1e099.0ae7b"
            ]
        ]
    },
    {
        "id": "9d941e69.c8d55",
        "type": "debug",
        "z": "1cc16612.5125da",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1190,
        "y": 680,
        "wires": []
    },
    {
        "id": "f94ff73.81e9c08",
        "type": "debug",
        "z": "1cc16612.5125da",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1350,
        "y": 600,
        "wires": []
    },
    {
        "id": "d2c3d4b1.1e1588",
        "type": "catch",
        "z": "3b71b008.50e91",
        "name": "",
        "scope": [
            "d0a69809.1294d8",
            "30df57f8.222e28"
        ],
        "uncaught": false,
        "x": 710,
        "y": 300,
        "wires": [
            [
                "75de175b.5b7c98"
            ]
        ]
    },
    {
        "id": "99b22bac.a97458",
        "type": "http in",
        "z": "da7980eb.de052",
        "name": "IN TG robot",
        "url": "/webhookTG",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 220,
        "wires": [
            [
                "77ea13d7.a8ed2c"
            ]
        ]
    },
    {
        "id": "e62318ae.f04028",
        "type": "debug",
        "z": "da7980eb.de052",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 830,
        "y": 400,
        "wires": []
    },
    {
        "id": "f89b1c6e.96b3c",
        "type": "switch",
        "z": "da7980eb.de052",
        "name": "Фильтр CallBack TG",
        "property": "type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "callback",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 620,
        "y": 540,
        "wires": [
            [
                "9dfc9a79.526ca8"
            ]
        ]
    },
    {
        "id": "90b3c763.1dc568",
        "type": "switch",
        "z": "da7980eb.de052",
        "name": "Фильтр картинок TG",
        "property": "type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "picture",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 620,
        "y": 220,
        "wires": [
            []
        ]
    },
    {
        "id": "8b4d5794.619208",
        "type": "switch",
        "z": "da7980eb.de052",
        "name": "Фильтр Inline TG",
        "property": "type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "inline",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 610,
        "y": 280,
        "wires": [
            [
                "8f683906.6a9088"
            ]
        ]
    },
    {
        "id": "9dfc9a79.526ca8",
        "type": "debug",
        "z": "da7980eb.de052",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 830,
        "y": 540,
        "wires": []
    },
    {
        "id": "8f683906.6a9088",
        "type": "debug",
        "z": "da7980eb.de052",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 810,
        "y": 280,
        "wires": []
    },
    {
        "id": "77ea13d7.a8ed2c",
        "type": "function",
        "z": "da7980eb.de052",
        "name": "разделим параметры",
        "func": "msg.data = msg.payload.data;    //заберем body \ndelete msg.data.config;         //удалим старый конфиг\n\nmsg.config = {\n    \"token\": \"389761962:AAFmbsN4o6-QdmdoZeBpg0keOxmIoabWiNY\"\n};\ndelete msg.payload.data;  //чистим передеанные данные\n\n//проверим канал откуда пришла заявка и \n//разберем данные на части\n\nif (typeof msg.data.message === \"object\") { //Телега\n    msg.type = \"message\";\n    msg.user_text = msg.data.message.text;\n    msg.user_name = msg.data.message.from.last_name + \" \" + msg.data.message.from.first_name;\n    msg.chat_id = msg.data.message.chat.id;\n    msg.channel = \"telegram\";\n    \n    if (Array.isArray(msg.data.message.photo) && msg.data.message.photo[0] !== \"\") {\n        //проверим наличие картинки\n        var len = msg.data.message.photo.length - 1;\n        msg.file_id = msg.data.message.photo[len].file_id;\n        msg.type = \"picture\";\n        msg.token = msg.config.token;\n    }\n} else if (typeof msg.data.callback_query === \"object\") {\n    msg.user_text = msg.data.callback_query.data;\n    msg.user_name = msg.data.callback_query.from.last_name + \" \" + msg.data.callback_query.from.first_name;\n    msg.chat_id = msg.data.callback_query.message.chat.id;\n    msg.prev_mess_id = msg.data.callback_query.message.message_id;\n    msg.button_id = msg.data.callback_query.data;\n    msg.channel = \"telegram\";\n    msg.type = \"callback\";\n} else if (typeof msg.data.inline_query === \"object\") {\n    msg.chat_id = msg.data.inline_query.from.id;\n    msg.channel = \"telegram\";\n    msg.type = \"inline\";\n}\n\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 360,
        "y": 220,
        "wires": [
            [
                "f89b1c6e.96b3c",
                "90b3c763.1dc568",
                "8b4d5794.619208",
                "14cd88f7.27af07"
            ]
        ]
    },
    {
        "id": "14cd88f7.27af07",
        "type": "switch",
        "z": "da7980eb.de052",
        "name": "Фильтр сообщений TG",
        "property": "type",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "message",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 630,
        "y": 480,
        "wires": [
            [
                "e62318ae.f04028",
                "a25f6355.dadc1"
            ]
        ]
    },
    {
        "id": "4d8adb11.f6fe74",
        "type": "http request",
        "z": "da7980eb.de052",
        "name": "Получим URL картинки",
        "method": "GET",
        "ret": "obj",
        "paytoqs": false,
        "url": "https://api.telegram.org/bot{{token}}/getFile?file_id={{file_id}}",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 870,
        "y": 220,
        "wires": [
            [
                "fe18e0ba.9cfec"
            ]
        ]
    },
    {
        "id": "fe18e0ba.9cfec",
        "type": "function",
        "z": "da7980eb.de052",
        "name": "Формируем URL",
        "func": "msg.url = \"https://api.telegram.org/file/bot\" + msg.token + \"/\" + msg.payload.result.file_path;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1110,
        "y": 220,
        "wires": [
            [
                "82633e91.e309e",
                "a25f6355.dadc1"
            ]
        ]
    },
    {
        "id": "82633e91.e309e",
        "type": "debug",
        "z": "da7980eb.de052",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1290,
        "y": 220,
        "wires": []
    },
    {
        "id": "a25f6355.dadc1",
        "type": "link out",
        "z": "da7980eb.de052",
        "name": "",
        "links": [],
        "x": 1035,
        "y": 480,
        "wires": []
    },
    {
        "id": "1884c110.df8c2f",
        "type": "link in",
        "z": "da7980eb.de052",
        "name": "MainProc",
        "links": [],
        "x": 75,
        "y": 620,
        "wires": [
            [
                "ba941508.1f8c78"
            ]
        ]
    },
    {
        "id": "b800c70e.5d2248",
        "type": "redis-command",
        "z": "da7980eb.de052",
        "server": "ccaa13e5.b3ad3",
        "command": "set",
        "name": "Поиск пользователя в REDIS",
        "topic": "",
        "x": 450,
        "y": 620,
        "wires": [
            [
                "8ec98db3.c7bbc"
            ]
        ]
    },
    {
        "id": "4e36b63d.423648",
        "type": "comment",
        "z": "da7980eb.de052",
        "name": "Проверка пользователя",
        "info": "",
        "x": 170,
        "y": 560,
        "wires": []
    },
    {
        "id": "67db5b7f.61ab54",
        "type": "comment",
        "z": "da7980eb.de052",
        "name": "Подготовка входящих параметров",
        "info": "",
        "x": 220,
        "y": 180,
        "wires": []
    },
    {
        "id": "75324b89.6b3de4",
        "type": "comment",
        "z": "da7980eb.de052",
        "name": "НЕ РАБОТАЕТ",
        "info": "",
        "x": 840,
        "y": 160,
        "wires": []
    },
    {
        "id": "ba941508.1f8c78",
        "type": "function",
        "z": "da7980eb.de052",
        "name": "Поисковый запрос",
        "func": "msg.payload = [msg.channel +\"_\" + msg.chat_id];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 210,
        "y": 620,
        "wires": [
            [
                "b800c70e.5d2248"
            ]
        ]
    },
    {
        "id": "8ec98db3.c7bbc",
        "type": "debug",
        "z": "da7980eb.de052",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 650,
        "y": 620,
        "wires": []
    },
    {
        "id": "4f17b79a.37dc48",
        "type": "http request",
        "z": "da7980eb.de052",
        "name": "Отправим message",
        "method": "POST",
        "ret": "obj",
        "paytoqs": false,
        "url": "https://api.telegram.org/bot{{token}}/sendMessage",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 560,
        "y": 760,
        "wires": [
            [
                "a536cb23.954ef8"
            ]
        ]
    },
    {
        "id": "5527d6c2.c0f268",
        "type": "inject",
        "z": "da7980eb.de052",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 140,
        "y": 760,
        "wires": [
            [
                "f5bdcbb7.4d3a68"
            ]
        ]
    },
    {
        "id": "f5bdcbb7.4d3a68",
        "type": "function",
        "z": "da7980eb.de052",
        "name": "Поисковый запрос",
        "func": "msg.payload = {\n    \"chat_id\": \"112080804\",\n    \"text\": \"Привет с NodeRED!\"\n};\n\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 330,
        "y": 760,
        "wires": [
            [
                "4f17b79a.37dc48"
            ]
        ]
    },
    {
        "id": "a536cb23.954ef8",
        "type": "debug",
        "z": "da7980eb.de052",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 770,
        "y": 760,
        "wires": []
    },
    {
        "id": "bb0173b4.8a055",
        "type": "comment",
        "z": "da7980eb.de052",
        "name": "НЕ РАБОТАЕТ",
        "info": "",
        "x": 540,
        "y": 720,
        "wires": []
    },
    {
        "id": "aa5ff6b2.b60ce8",
        "type": "comment",
        "z": "3e6d7003.49c1e",
        "name": "Отправк в CRM и сохранение результата в REDIS ХЭШ  ",
        "info": "# На старт \n\n**поступает массив клиентов для которых:**\n * необходимо создать СКК\n * проверить результат через время Т",
        "x": 230,
        "y": 40,
        "wires": []
    },
    {
        "id": "a21dcd51.e7bd",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "Готовим тело запроса",
        "func": "var addrtype, \n    addrid, \n    attrs = {\n        /*\n        \"код атрибута\":\"Значение атрибута 1\",\n        \"код атрибута\":\"Значение атрибута 2\",\n        \"COMM\":\"Комментарий\"\n        */\n    },\n    history = [\n        /*{\n            \"st\":\"состояние\",\n            \"ch\":\"канал\",\n            \"con\":\"контактные данные\",\n            \"com\":\"комментарий\",\n            \"dt\": \"дата в формате yyyyMMddHHmmss / yyyyMMddHHmm / yyyyMMdd - если не передавать будет getdate()\"\n        }*/\n     ];\n\n//запишем тело в заявку\nfor (var k in msg.payload) {\n    msg[k] = msg.payload[k];\n}\n\n \n\nif (typeof msg.phone != \"undefined\" && /^(\\+380[0-9]{9}|380[0-9]{9})$/.test(msg.phone)) {\n    addrtype = \"MB\";\n    if (/^380[0-9]{9}$/.test(msg.phone)) msg.phone = \"+\" + msg.phone;\n    addrid = msg.phone;\n} else if (typeof msg.client_id != \"undefined\" && msg.client_id !== \"\") {\n    addrtype = \"CI\";\n    addrid = msg.client_id;\n} else if (typeof msg.ldap != \"undefined\" && /^([A-Z a-z]{2}[0-9]{6}[A-Z a-z]{3}|[A-Z a-z]{2}[0-9]{6}[A-Z a-z]{3}[0-9]{1})$/.test(msg.ldap)) {\n    addrtype = \"LD\";\n    addrid = msg.ldap;\n}\n\nmsg.payload = {\n   \"evt\": msg.evt,\n   \"st\":\"WT\",\n   \"src\":\"AGENT\",\n   \"addrid\": addrid,\n   \"addrtype\": addrtype,\n   \"bank\":\"PB\",\n   \"lang\":\"UA\",\n   \"extref\": addrid + \"_\" + new Date().getTime(),\n   \"attrs\" : attrs,\n   \"history\": history\n};\n\nmsg.SID = global.get(\"body\").SID;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 360,
        "y": 180,
        "wires": [
            [
                "b5deb8f4.8ba738"
            ]
        ]
    },
    {
        "id": "faaa1795.538b48",
        "type": "http in",
        "z": "3e6d7003.49c1e",
        "name": "Приемник ид клиента",
        "url": "/clientIdToCRM",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 180,
        "wires": [
            [
                "a21dcd51.e7bd"
            ]
        ]
    },
    {
        "id": "b5deb8f4.8ba738",
        "type": "http request",
        "z": "3e6d7003.49c1e",
        "name": "",
        "method": "POST",
        "ret": "obj",
        "paytoqs": false,
        "url": "http://crm.privatbank.ua:4000/Contact/api/event/add?sid={{SID}}",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 550,
        "y": 180,
        "wires": [
            [
                "3ff72482.b71d7c"
            ]
        ]
    },
    {
        "id": "32b4944d.1ac28c",
        "type": "inject",
        "z": "3e6d7003.49c1e",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 100,
        "y": 100,
        "wires": [
            [
                "91917567.2a92a8"
            ]
        ]
    },
    {
        "id": "91917567.2a92a8",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "",
        "func": "msg.payload = {\n    \"client_id\": \"12243729\", //22198388\n    \"evt\": \"085629\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 230,
        "y": 100,
        "wires": [
            [
                "a21dcd51.e7bd"
            ]
        ]
    },
    {
        "id": "a2a1faa8.2c1c48",
        "type": "redis-command",
        "z": "3e6d7003.49c1e",
        "server": "ccaa13e5.b3ad3",
        "command": "hset",
        "name": "Запишем в хэш по СКК",
        "topic": "0",
        "x": 970,
        "y": 220,
        "wires": [
            [
                "cc32bdc.4c6534"
            ]
        ]
    },
    {
        "id": "4ec710db.9cf3",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "Формируем хэш СКК",
        "func": "//запишем тело в заявку\nfor (var k in msg.payload) {\n    msg[k] = msg.payload[k];\n}\n\nif (typeof msg.client_id == \"undefined\") {\n    if (typeof msg.phone == \"undefined\") {\n        msg.client_id = msg.ldap;\n    } else {\n        msg.client_id = msg.phone;\n    }\n} \n\nvar obj = {\n    \"ref\": msg.ref,\n    \"startTime\": new Date().getTime()\n}; \n\nmsg.payload = [msg.evt, msg.client_id, JSON.stringify(obj)];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 220,
        "wires": [
            [
                "a2a1faa8.2c1c48"
            ]
        ]
    },
    {
        "id": "cc32bdc.4c6534",
        "type": "http response",
        "z": "3e6d7003.49c1e",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1160,
        "y": 220,
        "wires": []
    },
    {
        "id": "db5ebae.f2af848",
        "type": "inject",
        "z": "3e6d7003.49c1e",
        "name": "Генератор",
        "topic": "{\"evt\": \"085629\"}",
        "payload": "",
        "payloadType": "date",
        "repeat": "3600",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 90,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "8b356ce8.aac96",
        "type": "comment",
        "z": "3e6d7003.49c1e",
        "name": "Запуск проверки заявок из ХЭШа REDIS по СКК",
        "info": "",
        "x": 210,
        "y": 520,
        "wires": []
    },
    {
        "id": "14a78b5a.03a3d5",
        "type": "redis-command",
        "z": "3e6d7003.49c1e",
        "server": "ccaa13e5.b3ad3",
        "command": "hgetall",
        "name": "Вычитка ХЭШа",
        "topic": "0",
        "x": 500,
        "y": 560,
        "wires": [
            [
                "8e3b3351.fe62"
            ]
        ]
    },
    {
        "id": "ef7ad978.d93d88",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "Все заявки из ХЭШа",
        "func": "//запишем тело в заявку\nfor (var k in msg.payload) {\n    msg[k] = msg.payload[k];\n}\n\nmsg.evt = \"085629\";\n\nmsg.payload = [msg.evt];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 300,
        "y": 560,
        "wires": [
            [
                "14a78b5a.03a3d5"
            ]
        ]
    },
    {
        "id": "f4897c3a.8c99b",
        "type": "comment",
        "z": "3e6d7003.49c1e",
        "name": "Цикл проверки состояния СКК",
        "info": "",
        "x": 730,
        "y": 620,
        "wires": []
    },
    {
        "id": "25ce873e.da1828",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "поиск по ref СКК",
        "func": "//запуск цикла:\n//получим первый элемент\nvar redisO = msg.redisArr[msg.counter];\n\n//получим объект \nfor (var k in redisO) {\n    var temp = redisO[k];\n    redisO[k] = JSON.parse(temp);\n    msg.client_id = k;\n    msg.ref = redisO[k].ref; \t\t\t\t\t\t\t//ref SKK\n\tmsg.startTime = redisO[k].startTime; \t//дата старта коммуникации \n}\n\nvar now = new Date().getTime();\nvar delta = +msg.startTime + 86400000*30;\n\n//сравним дату выхода\nif (+now > +delta) {\n    msg.endFlag = \"true\";\n} else {\n    msg.endFlag = \"false\";\n}\n\nmsg.SID = global.get(\"body\").SID;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 970,
        "y": 720,
        "wires": [
            [
                "6a6cce95.8c821",
                "6d68805d.14913"
            ]
        ]
    },
    {
        "id": "4be9edce.e3bde4",
        "type": "http request",
        "z": "3e6d7003.49c1e",
        "name": "",
        "method": "GET",
        "ret": "obj",
        "paytoqs": false,
        "url": "http://crm.privatbank.ua:4000/Contact/api/event/get?sid={{SID}}&ref={{ref}}",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 1270,
        "y": 780,
        "wires": [
            [
                "31a6c8a9.832668"
            ]
        ]
    },
    {
        "id": "31a6c8a9.832668",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "Проверка статуса СКК",
        "func": "msg.st = msg.payload.st;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1310,
        "y": 820,
        "wires": [
            [
                "2061eddd.5239d2",
                "44f1becb.3bc0d",
                "eee4d19b.a48d8"
            ]
        ]
    },
    {
        "id": "6a6cce95.8c821",
        "type": "switch",
        "z": "3e6d7003.49c1e",
        "name": "",
        "property": "endFlag",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "false",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1130,
        "y": 780,
        "wires": [
            [
                "4be9edce.e3bde4"
            ]
        ]
    },
    {
        "id": "eee4d19b.a48d8",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "counter + 1",
        "func": "msg.counter = +msg.counter + 1;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 490,
        "y": 660,
        "wires": [
            [
                "4b1d4404.6abc1c"
            ]
        ]
    },
    {
        "id": "a68253d7.c47d",
        "type": "debug",
        "z": "3e6d7003.49c1e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1650,
        "y": 780,
        "wires": []
    },
    {
        "id": "3ff72482.b71d7c",
        "type": "switch",
        "z": "3e6d7003.49c1e",
        "name": "",
        "property": "statusCode",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "200",
                "vt": "num"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 690,
        "y": 180,
        "wires": [
            [
                "4ec710db.9cf3"
            ]
        ]
    },
    {
        "id": "7fa0212b.41096",
        "type": "switch",
        "z": "3e6d7003.49c1e",
        "name": "",
        "property": "counter",
        "propertyType": "msg",
        "rules": [
            {
                "t": "lt",
                "v": "max",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 810,
        "y": 720,
        "wires": [
            [
                "25ce873e.da1828"
            ]
        ]
    },
    {
        "id": "13fd447.cc9bebc",
        "type": "switch",
        "z": "3e6d7003.49c1e",
        "name": "",
        "property": "counter",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "max",
                "vt": "msg"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 810,
        "y": 660,
        "wires": [
            [
                "c32c1c04.99c3f"
            ]
        ]
    },
    {
        "id": "c32c1c04.99c3f",
        "type": "debug",
        "z": "3e6d7003.49c1e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 930,
        "y": 660,
        "wires": []
    },
    {
        "id": "6d68805d.14913",
        "type": "switch",
        "z": "3e6d7003.49c1e",
        "name": "",
        "property": "endFlag",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1130,
        "y": 720,
        "wires": [
            [
                "eee4d19b.a48d8"
            ]
        ]
    },
    {
        "id": "8e3b3351.fe62",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "Заявки из ХЭШа",
        "func": "msg.redisArr = [];\n\nfor (var k in msg.payload) {\n    var obj = {};\n    obj[k] = msg.payload[k];\n    msg.redisArr.push(obj);\n}\n\nmsg.redisObj = msg.payload;\n\nmsg.payload = {};\n\nmsg.counter = 0;\n\nmsg.max = Object.keys(msg.redisObj).length;\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 690,
        "y": 560,
        "wires": [
            [
                "4b1d4404.6abc1c"
            ]
        ]
    },
    {
        "id": "4b1d4404.6abc1c",
        "type": "delay",
        "z": "3e6d7003.49c1e",
        "name": "",
        "pauseType": "delay",
        "timeout": "200",
        "timeoutUnits": "milliseconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "x": 670,
        "y": 660,
        "wires": [
            [
                "7fa0212b.41096",
                "13fd447.cc9bebc"
            ]
        ]
    },
    {
        "id": "2061eddd.5239d2",
        "type": "switch",
        "z": "3e6d7003.49c1e",
        "name": "",
        "property": "st",
        "propertyType": "msg",
        "rules": [
            {
                "t": "regex",
                "v": "OK",
                "vt": "str",
                "case": false
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1490,
        "y": 820,
        "wires": [
            [
                "a68253d7.c47d",
                "1997502c.ab7a5"
            ]
        ]
    },
    {
        "id": "b5992f84.39546",
        "type": "debug",
        "z": "3e6d7003.49c1e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1650,
        "y": 940,
        "wires": []
    },
    {
        "id": "c1df08f5.227dc8",
        "type": "comment",
        "z": "3e6d7003.49c1e",
        "name": "Выход на процесс по нужному статусу",
        "info": "",
        "x": 2150,
        "y": 240,
        "wires": []
    },
    {
        "id": "30da2f9e.f3fa9",
        "type": "comment",
        "z": "3e6d7003.49c1e",
        "name": "Статус = OK",
        "info": "",
        "x": 1670,
        "y": 740,
        "wires": []
    },
    {
        "id": "e374da92.4813a8",
        "type": "comment",
        "z": "3e6d7003.49c1e",
        "name": "Статус = IC",
        "info": "",
        "x": 1670,
        "y": 900,
        "wires": []
    },
    {
        "id": "7cfa4177.e84ea",
        "type": "redis-command",
        "z": "3e6d7003.49c1e",
        "server": "ccaa13e5.b3ad3",
        "command": "hdel",
        "name": "Удалить клиента из хэша",
        "topic": "0",
        "x": 1960,
        "y": 820,
        "wires": [
            [
                "5716302.7ecffd"
            ]
        ]
    },
    {
        "id": "1997502c.ab7a5",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "Заявка на удаление",
        "func": "msg.payload = [msg.evt, msg.client_id];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1700,
        "y": 820,
        "wires": [
            [
                "7cfa4177.e84ea"
            ]
        ]
    },
    {
        "id": "44f1becb.3bc0d",
        "type": "switch",
        "z": "3e6d7003.49c1e",
        "name": "",
        "property": "st",
        "propertyType": "msg",
        "rules": [
            {
                "t": "regex",
                "v": "IC",
                "vt": "str",
                "case": false
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1490,
        "y": 940,
        "wires": [
            [
                "b5992f84.39546",
                "1997502c.ab7a5"
            ]
        ]
    },
    {
        "id": "5716302.7ecffd",
        "type": "debug",
        "z": "3e6d7003.49c1e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 2110,
        "y": 760,
        "wires": []
    },
    {
        "id": "32be4161.00dc3e",
        "type": "comment",
        "z": "3e6d7003.49c1e",
        "name": "Передать в другой процесс",
        "info": "",
        "x": 2180,
        "y": 720,
        "wires": []
    },
    {
        "id": "430df50.8b8830c",
        "type": "debug",
        "z": "3e6d7003.49c1e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 290,
        "y": 280,
        "wires": []
    },
    {
        "id": "dd90d91f.c51018",
        "type": "http in",
        "z": "3e6d7003.49c1e",
        "name": "",
        "url": "/ip",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 320,
        "wires": [
            [
                "568bda19.19f1a4",
                "430df50.8b8830c"
            ]
        ]
    },
    {
        "id": "568bda19.19f1a4",
        "type": "http response",
        "z": "3e6d7003.49c1e",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 300,
        "y": 320,
        "wires": []
    },
    {
        "id": "ca07dd6c.7ebbb",
        "type": "redis-command",
        "z": "3e6d7003.49c1e",
        "server": "ccaa13e5.b3ad3",
        "command": "ttl",
        "name": "Читаем время жизни заявки",
        "topic": "0",
        "x": 460,
        "y": 1060,
        "wires": [
            [
                "9d160168.31ebe"
            ]
        ]
    },
    {
        "id": "9d160168.31ebe",
        "type": "debug",
        "z": "3e6d7003.49c1e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 670,
        "y": 1060,
        "wires": []
    },
    {
        "id": "70758fee.cae95",
        "type": "inject",
        "z": "3e6d7003.49c1e",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 100,
        "y": 1060,
        "wires": [
            [
                "77c5dfbb.a5e0b"
            ]
        ]
    },
    {
        "id": "77c5dfbb.a5e0b",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "",
        "func": "msg.payload = [\"12243729\"];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 230,
        "y": 1060,
        "wires": [
            [
                "ca07dd6c.7ebbb"
            ]
        ]
    },
    {
        "id": "4d766505.742b1c",
        "type": "redis-command",
        "z": "3e6d7003.49c1e",
        "server": "ccaa13e5.b3ad3",
        "command": "expire",
        "name": "Запишем время жизни заявки",
        "topic": "0",
        "x": 470,
        "y": 1120,
        "wires": [
            [
                "f20252cd.8f4af"
            ]
        ]
    },
    {
        "id": "f20252cd.8f4af",
        "type": "debug",
        "z": "3e6d7003.49c1e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 670,
        "y": 1120,
        "wires": []
    },
    {
        "id": "7acd478b.f79238",
        "type": "inject",
        "z": "3e6d7003.49c1e",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 100,
        "y": 1120,
        "wires": [
            [
                "21c83f52.ed149"
            ]
        ]
    },
    {
        "id": "21c83f52.ed149",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "",
        "func": "msg.payload = [\"12243729\", 6000];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 230,
        "y": 1120,
        "wires": [
            [
                "4d766505.742b1c"
            ]
        ]
    },
    {
        "id": "b1eecda0.1b76a",
        "type": "comment",
        "z": "3e6d7003.49c1e",
        "name": "Для простой строки в REDIS ",
        "info": "",
        "x": 140,
        "y": 980,
        "wires": []
    },
    {
        "id": "8e0abac7.966288",
        "type": "redis-command",
        "z": "3e6d7003.49c1e",
        "server": "ccaa13e5.b3ad3",
        "command": "scan",
        "name": "Получим ВСЕ заявки",
        "topic": "0",
        "x": 440,
        "y": 1180,
        "wires": [
            [
                "b3cb484.0769eb8"
            ]
        ]
    },
    {
        "id": "b3cb484.0769eb8",
        "type": "debug",
        "z": "3e6d7003.49c1e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 670,
        "y": 1180,
        "wires": []
    },
    {
        "id": "c69cd11e.60c13",
        "type": "inject",
        "z": "3e6d7003.49c1e",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 100,
        "y": 1180,
        "wires": [
            [
                "da623a2f.aa1068"
            ]
        ]
    },
    {
        "id": "da623a2f.aa1068",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "",
        "func": "msg.payload = [\"0\"];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 230,
        "y": 1180,
        "wires": [
            [
                "8e0abac7.966288"
            ]
        ]
    },
    {
        "id": "14fc5259.3ea64e",
        "type": "redis-command",
        "z": "3e6d7003.49c1e",
        "server": "ccaa13e5.b3ad3",
        "command": "hscan",
        "name": "Получим ВСЕ заявки ХЭШа",
        "topic": "0",
        "x": 1220,
        "y": 1060,
        "wires": [
            [
                "7752a13a.91f09"
            ]
        ]
    },
    {
        "id": "7752a13a.91f09",
        "type": "debug",
        "z": "3e6d7003.49c1e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1430,
        "y": 1060,
        "wires": []
    },
    {
        "id": "5eea4c7b.2a3354",
        "type": "inject",
        "z": "3e6d7003.49c1e",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 880,
        "y": 1060,
        "wires": [
            [
                "e47d7d9b.a68aa"
            ]
        ]
    },
    {
        "id": "e47d7d9b.a68aa",
        "type": "function",
        "z": "3e6d7003.49c1e",
        "name": "",
        "func": "msg.payload = [\"085629\",\"0\"];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1010,
        "y": 1060,
        "wires": [
            [
                "14fc5259.3ea64e"
            ]
        ]
    },
    {
        "id": "bb9f16c6.d886e8",
        "type": "comment",
        "z": "3e6d7003.49c1e",
        "name": "Для ХЭШа в REDIS ",
        "info": "",
        "x": 870,
        "y": 980,
        "wires": []
    },
    {
        "id": "7906a6e.c3a4458",
        "type": "http in",
        "z": "da7980eb.de052",
        "name": "",
        "url": "/test",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 60,
        "wires": [
            [
                "1a9af93.1060b07",
                "3c90accf.16da44"
            ]
        ]
    },
    {
        "id": "1a9af93.1060b07",
        "type": "http response",
        "z": "da7980eb.de052",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 300,
        "y": 60,
        "wires": []
    },
    {
        "id": "3c90accf.16da44",
        "type": "debug",
        "z": "da7980eb.de052",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 290,
        "y": 100,
        "wires": []
    },
    {
        "id": "24411459.14731c",
        "type": "http in",
        "z": "1e3801f3.ffb9ae",
        "name": "callback from cp-NRM ШАГ 1",
        "url": "/setNrmStep1",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 3040,
        "y": 540,
        "wires": [
            [
                "be2fd908.7c2878",
                "f9b807d9.1d6118",
                "5eaf19b2.800a78"
            ]
        ]
    },
    {
        "id": "c5aeae51.ef6f",
        "type": "http request",
        "z": "1e3801f3.ffb9ae",
        "name": "Запрос в ср-НРМ ШАГ 1",
        "method": "POST",
        "ret": "obj",
        "paytoqs": false,
        "url": "https://cp.privatbank.ua/api/1/json/public/209397/a9c792ba6ba669672bf531d768c17c4a7c327b22",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 2730,
        "y": 540,
        "wires": [
            []
        ]
    },
    {
        "id": "75565a4.42688a4",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "5. Получим ответ от ср-НРМ ШАГ_1",
        "info": "",
        "x": 3070,
        "y": 500,
        "wires": []
    },
    {
        "id": "5579bee0.6123e",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.data = msg.payload;\n\nmsg.ops = [];\nmsg.ops.push({\n    \"conv_id\": \"209397\",\n    \"ref\": msg.client_id,\n    \"type\": \"create\",\n    \"obj\": \"task\",\n    \"data\": msg.data\n});\n\nmsg.payload = JSON.stringify({\n    \"ops\": msg.ops\n});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2550,
        "y": 540,
        "wires": [
            [
                "c5aeae51.ef6f"
            ]
        ]
    },
    {
        "id": "70a4ee23.dccfa",
        "type": "http response",
        "z": "1e3801f3.ffb9ae",
        "name": "приняли",
        "statusCode": "200",
        "headers": {},
        "x": 800,
        "y": 100,
        "wires": []
    },
    {
        "id": "30a0dcc5.9764a4",
        "type": "http request",
        "z": "1e3801f3.ffb9ae",
        "name": "callback unswer",
        "method": "POST",
        "ret": "txt",
        "paytoqs": false,
        "url": "{{{cb_url}}}",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 3240,
        "y": 140,
        "wires": [
            []
        ]
    },
    {
        "id": "be2fd908.7c2878",
        "type": "http response",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 3260,
        "y": 540,
        "wires": []
    },
    {
        "id": "3fcebe4b.19c442",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload = {\n    \"status\": \"ok\",\n    \"description\": \"Ожидайте ответ на URL: \" + msg.cb_url\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 670,
        "y": 100,
        "wires": [
            [
                "70a4ee23.dccfa"
            ]
        ]
    },
    {
        "id": "f9b807d9.1d6118",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "формируем ответ на cb_url",
        "func": "var data = msg.payload;\ndata.nrm_solution.client_id = msg.payload.client_id;\n\nmsg.cb_url = data.cb_url;\nmsg.payload = data.nrm_solution;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3340,
        "y": 360,
        "wires": [
            [
                "30a0dcc5.9764a4"
            ]
        ]
    },
    {
        "id": "98c75112.0957f",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "5.1 Отправим ответ на cb_url  ",
        "info": "",
        "x": 3280,
        "y": 100,
        "wires": []
    },
    {
        "id": "5eaf19b2.800a78",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "разберем ответ НРМ",
        "func": "var data = msg.payload;\n\nmsg.cb_url = data.cb_url;\nmsg.client_id = data.client_id;\nmsg.source = data.nrm_solution.source;\nmsg.limUP = data.nrm_solution.limUP;\nmsg.newlimit = data.nrm_solution.newlimit;\nmsg.oldlim = data.nrm_solution.lim;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3300,
        "y": 580,
        "wires": [
            [
                "b6fd3b04.350fe8"
            ]
        ]
    },
    {
        "id": "b6fd3b04.350fe8",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "Пропустим limUP = Y",
        "property": "limUP",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "Y",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 3520,
        "y": 580,
        "wires": [
            [
                "43941e56.c5ced"
            ]
        ]
    },
    {
        "id": "bbfdf57f.afc768",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Формируем первую запись",
        "func": "var obj = {\n    \"ref\": msg.nrm_ref, //реф заявки \n    \"limUP\": msg.limUP, //разрешено ли увеличение\n    \"newlimit\": msg.newlimit, //новый лимит\n    \"endTime\": new Date().getTime() + (86400000*30) //время смерти заявки\n}; \n\nobj[msg.source] = {\n    \"startTime\": new Date().getTime(),  //время показа заявки в канале\n    \"endTime\": getEndDayTime(),         //время паузы \n    \"isWatched\": \"Y\",                   //флаг показа\n    \"isUped\": \"N\"                       //флаг увеличения после показа\n};\n\nmsg.payload = [msg.client_id, JSON.stringify(obj)];\n\n\nreturn msg;\n\n\n\nfunction getEndDayTime() {\n  var date = new Date();\n  return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 0).getTime();\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 4360,
        "y": 540,
        "wires": [
            [
                "a46c8a13.4c81c8"
            ]
        ]
    },
    {
        "id": "a46c8a13.4c81c8",
        "type": "redis-command",
        "z": "1e3801f3.ffb9ae",
        "server": "ccaa13e5.b3ad3",
        "command": "set",
        "name": "Запишем в REDIS ",
        "topic": "0",
        "x": 4590,
        "y": 580,
        "wires": [
            [
                "578fd1ac.b516c"
            ]
        ]
    },
    {
        "id": "cfc69b32.7a4758",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "5.3 Запишем показ предложения в канале source",
        "info": "",
        "x": 4430,
        "y": 500,
        "wires": []
    },
    {
        "id": "47bf38df.92fd18",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Запрос проверки в REDIS",
        "func": "msg.payload = [msg.client_id];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 740,
        "y": 200,
        "wires": [
            [
                "c890499f.1fd128"
            ]
        ]
    },
    {
        "id": "c890499f.1fd128",
        "type": "redis-command",
        "z": "1e3801f3.ffb9ae",
        "server": "ccaa13e5.b3ad3",
        "command": "get",
        "name": "Проверим REDIS",
        "topic": "0",
        "x": 970,
        "y": 200,
        "wires": [
            [
                "292a137a.55c07c"
            ]
        ]
    },
    {
        "id": "31086a0b.673986",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "Показывали ",
        "property": "isWatched",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "false",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1270,
        "y": 200,
        "wires": [
            [
                "e5b9a950.15fc88"
            ],
            [
                "bd0ca75.c692358"
            ]
        ]
    },
    {
        "id": "292a137a.55c07c",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "if (msg.payload === null) {\n  msg.isWatched = \"false\"; //не показывали предложение\n  msg.inRedis = \"false\";\n  msg.descr = \"НЕ показывали ранее - Светим\";\n} else { \n  msg.inRedis = \"true\";\n  var payload = JSON.parse(msg.payload);\n  msg.REDIS = payload;\n  var time = new Date().getTime();\n  \n  if (typeof msg.REDIS[msg.source] != \"object\") {\n  \tif (time < msg.REDIS.endTime) { \n      for (var k in msg.REDIS) {\n        if (typeof msg.REDIS[k] == \"object\" && msg.REDIS[k].isUped == \"Y\") {\n          msg.isWatched = \"true\"; \n          msg.descr = \"увеличивали за последние 30 дней в канале \" + k + \" - Отказ\";\n        } else {\n          msg.isWatched = \"false\";\n          msg.descr = \"показывали где-то за прошлые 30 дней но без увеличения - Светим\";\n        }\n      }\n    } else {\n        msg.isWatched = \"false\";\n        msg.descr = \"показывали где-то но прошло 30+ дней - Светим\";\n    } \n  } else {\n  \tvar sD = new Date(msg.REDIS[msg.source].endTime);\n    var endDay = new Date(sD.getFullYear(), sD.getMonth(), sD.getDate(), 23, 59, 0).getTime();\n\n    if (time < endDay) {\n        msg.isWatched = \"true\"; \n        msg.descr = \"показывали в текущем канале за последние 30 дней - Отказ\";\n    } else if (time < msg.REDIS.endTime) { \n      for (var z in msg.REDIS) {\n        if (typeof msg.REDIS[z] == \"object\" && msg.REDIS[z].isUped == \"Y\") {\n          msg.isWatched = \"true\"; \n          msg.descr = \"увеличивали за последние 30 дней в \" + z + \" - Отказ\";\n        } else {\n          msg.isWatched = \"false\";\n          msg.descr = \"показывали где-то за прошлые 30 дней но без увеличения - Светим\";\n        }\n      }\n    } else {\n        msg.isWatched = \"false\";\n        msg.descr = \"показывали в канале но прошло 30+ дней - Светим\";\n    }\n  }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1130,
        "y": 200,
        "wires": [
            [
                "31086a0b.673986"
            ]
        ]
    },
    {
        "id": "ba4a4bfd.da96a8",
        "type": "http request",
        "z": "1e3801f3.ffb9ae",
        "name": "Обращаемся к ЕКБ",
        "method": "POST",
        "ret": "txt",
        "url": "https://cis.privatbank.ua/all",
        "tls": "",
        "x": 1700,
        "y": 260,
        "wires": [
            [
                "456c71b8.1de4e"
            ]
        ]
    },
    {
        "id": "456c71b8.1de4e",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "клиентские данные",
        "func": "var data = JSON.parse(msg.payload);\n\nvar body = {};\n\nbody.phone = getPhone(data.r[0].INF_NEW);\nbody.name = getFio(data.r[0].INF_NEW);\nbody.client_id = getId(data.r[0].INF_NEW);\nbody.str_client_id = getStrId(data.r[0].INF_NEW);\ngetAllPhones();\nbody.age = getAge(getDb(data.r[0].INF_NEW));\nbody.statusAgent = getAgentStatus(data.r[0].INF_NEW);\nbody.st = getSt(data.r[0].INF_NEW);\nbody.sex = getSex(data.r[0].INF_NEW);\nbody.DTS = getUnix(getDTS(data.r[0].INF_NEW));\nbody.vip = getVip(data.r[0].INF_NEW);\nbody.isVip = getV(data.r);\n\n\nmsg.payload = body;\n\nreturn msg;\n\nfunction getV(arr){\n    var is_VIP; \n    for (var i=0; i<arr.length; i++) {       //берем каждый объект из массива r\n     var obj = arr[i];\n     for (var k in obj) {           // проверяем на совпадение с INF_NEW\n       if ( k == \"INF_NEW\") {\n          is_VIP = obj[k][0].VIP_MANAGER.IsVip;\n        }\n      }              \n    }\n    return is_VIP;\n}\n\nfunction getAllPhones() {\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//забираем телефоны\n  var arr = data.r[0].INF_NEW[0].CONT_INF;\n  body.phones = [];\n  for (var i=0; i<arr.length; i++) {\n      if (arr[i].Type == \"3\") {\n         body.phones.push(arr[i].Number.replace(\"+\", \"\"));\n    }\n  }\n}\n\nfunction Phone(p) {\n  var phone = p.replace(/-| |\\(|\\)|\\+|\\.|\\,/g, \"\"); //убираем лишнее\n  return phone;\n}\n\nfunction getPhone (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"CONT_INF\" in arr[i]) {\n      \tfor (var j=0; j<arr[i][\"CONT_INF\"].length; j++) {\n          if (arr[i][\"CONT_INF\"][j].GroupMain == \"Y\" && arr[i][\"CONT_INF\"][j].Number != \"\" && /\\+380/.test(arr[i][\"CONT_INF\"][j].Number)) {\n          \treturn arr[i][\"CONT_INF\"][j].Number;\n          }\n        }\n        //return \"\";\n      }\n  \t}\n  }\n}\n\nfunction getFio (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return arr[i][\"INF_NEW\"].ruLName + \" \" + arr[i][\"INF_NEW\"].ruFName + \" \" + arr[i][\"INF_NEW\"].ruMName;\n  \t}\n  }\n}\n\nfunction getStrId (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return arr[i][\"INF_NEW\"].StrClientID;\n  \t}\n  }\n}\n\nfunction getId (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].Id;\n  \t}\n  }\n}\n\nfunction getAge (DB) {\n  var age;\n  var str = DB;\n  if (str == \"null\" || str == \"\" || typeof str == \"undefined\") return \"-\";\n  var b_y = str.substr(0, 4);\n  var b_m = str.substr(5, 2);\n  var b_d = str.substr(8, 2); \n  var Y = new Date().getFullYear();\n  var M = new Date().getMonth()+1;\n  var D = new Date().getDate();\n  \n  if (+b_m > +M) {\n    age = Y - b_y - 1;\t\n  } else {\n  \tif (+b_m == +M && +D < +b_d) {\n  \t\tage = +Y - b_y - 1;\n  \t} else {\n  \t\tage = +Y - b_y;\n  \t}\n  }\n\n  return age;\n}\n\nfunction getSt (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].St;\n  \t}\n  }\n}\n\nfunction getDb (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") return arr[i][\"INF_NEW\"].DB;\n  \t}\n  }\n}\n\nfunction getAgentStatus(arr) {\n\tif (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"P_CLIENTATTRS\" in arr[i]) {\n      \tvar statuses = arr[i][\"P_CLIENTATTRS\"].filter(function(item) {\n          if (item.AttrTypeId == 70) return item;\n        });\n      return statuses;\n      }\n  \t}\n  }\n}\n\nfunction getName (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\" ) return {\"S\": arr[i][\"INF_NEW\"].ruLName, \"N\": arr[i][\"INF_NEW\"].ruFName, \"L\": arr[i][\"INF_NEW\"].ruMName};\n  \t}\n  }\n}\n\nfunction getSex (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") {\n      \tif (arr[i][\"INF_NEW\"].Sex == \"\" || !arr[i][\"INF_NEW\"].Sex || arr[i][\"INF_NEW\"].Sex == \"undefined\") {\n        \tvar SexByRussianName = (function(){\n\n              function SexByRussianName(surname, first_name, patronymic) {\n                this.surname = surname;\n                this.first_name = first_name;\n                this.patronymic = patronymic;\n              };\n\n              SexByRussianName.FEMALE = 0;\n              SexByRussianName.MALE = 1;\n\n              SexByRussianName.SURNAME = 0;\n              SexByRussianName.PATRONYMIC = 1;\n              SexByRussianName.FIRST_NAME = 2;\n\n              SexByRussianName.surname_completions = [\n                ['ова', 'ева', 'ина', 'ая', 'яя', 'екая', 'цкая'],\n                ['ов', 'ев' ,'ин' ,'ын', 'ой', 'цкий', 'ский', 'цкой', 'ской']\n              ];\n              SexByRussianName.names = [\n                ['авдотья', 'аврора', 'агата', 'агния', 'агриппина', 'ада', 'аксинья', 'алевтина', 'александра', 'алёна', 'алена', 'алина', 'алиса', 'алла', 'альбина', 'амалия', 'анастасия', 'ангелина', 'анжела', 'анжелика', 'анна', 'антонина', 'анфиса', 'арина', 'белла', 'божена', 'валентина', 'валерия', 'ванда', 'варвара', 'василина', 'василиса', 'вера', 'вероника', 'виктория', 'виола', 'виолетта', 'вита', 'виталия', 'владислава', 'власта', 'галина', 'глафира', 'дарья', 'диана', 'дина', 'ева', 'евгения', 'евдокия', 'евлампия', 'екатерина', 'елена', 'елизавета', 'ефросиния', 'ефросинья', 'жанна', 'зиновия', 'злата', 'зоя', 'ивонна', 'изольда', 'илона', 'инга', 'инесса', 'инна', 'ирина', 'ия', 'капитолина', 'карина', 'каролина', 'кира', 'клавдия', 'клара', 'клеопатра', 'кристина', 'ксения', 'лада', 'лариса', 'лиана', 'лидия', 'лилия', 'лина', 'лия', 'лора', 'любава', 'любовь', 'людмила', 'майя', 'маргарита', 'марианна', 'мариетта', 'марина', 'мария', 'марья', 'марта', 'марфа', 'марьяна', 'матрёна', 'матрена', 'матрона', 'милена', 'милослава', 'мирослава', 'муза', 'надежда', 'настасия', 'настасья', 'наталия', 'наталья', 'нелли', 'ника', 'нина', 'нинель', 'нонна', 'оксана', 'олимпиада', 'ольга', 'пелагея', 'полина', 'прасковья', 'раиса', 'рената', 'римма', 'роза', 'роксана', 'руфь', 'сарра', 'светлана', 'серафима', 'снежана', 'софья', 'софия', 'стелла', 'степанида', 'стефания', 'таисия', 'таисья', 'тамара', 'татьяна', 'ульяна', 'устиния', 'устинья', 'фаина', 'фёкла', 'фекла', 'феодора', 'хаврония', 'христина', 'эвелина', 'эдита', 'элеонора', 'элла', 'эльвира', 'эмилия', 'эмма', 'юдифь', 'юлиана', 'юлия', 'ядвига', 'яна', 'ярослава'],\n                ['абрам', 'аверьян', 'авраам', 'агафон', 'адам', 'азар', 'акакий', 'аким', 'аксён', 'александр', 'алексей', 'альберт', 'анатолий', 'андрей', 'андрон', 'антип', 'антон', 'аполлон', 'аристарх', 'аркадий', 'арнольд', 'арсений', 'арсентий', 'артем', 'артём', 'артемий', 'артур', 'аскольд', 'афанасий', 'богдан', 'борис', 'борислав', 'бронислав', 'вадим', 'валентин', 'валерий', 'варлам', 'василий', 'венедикт', 'вениамин', 'веньямин', 'венцеслав', 'виктор', 'вилен', 'виталий', 'владилен', 'владимир', 'владислав', 'владлен', 'всеволод', 'всеслав', 'вячеслав', 'гавриил', 'геннадий', 'георгий', 'герман', 'глеб', 'григорий', 'давид', 'даниил', 'данил', 'данила', 'демьян', 'денис', 'димитрий', 'дмитрий', 'добрыня', 'евгений', 'евдоким', 'евсей', 'егор', 'емельян', 'еремей', 'ермолай', 'ерофей', 'ефим', 'захар', 'иван', 'игнат', 'игорь', 'илларион', 'иларион', 'илья', 'иосиф', 'казимир', 'касьян', 'кирилл', 'кондрат', 'константин', 'кузьма', 'лавр', 'лаврентий', 'лазарь', 'ларион', 'лев', 'леонард', 'леонид', 'лука', 'максим', 'марат', 'мартын', 'матвей', 'мефодий', 'мирон', 'михаил', 'моисей', 'назар', 'никита', 'николай', 'олег', 'осип', 'остап', 'павел', 'панкрат', 'пантелей', 'парамон', 'пётр', 'петр', 'платон', 'потап', 'прохор', 'роберт', 'ростислав', 'савва', 'савелий', 'семён', 'семен', 'сергей', 'сидор', 'спартак', 'тарас', 'терентий', 'тимофей', 'тимур', 'тихон', 'ульян', 'фёдор', 'федор', 'федот', 'феликс', 'фирс', 'фома', 'харитон', 'харлам', 'эдуард', 'эммануил', 'эраст', 'юлиан', 'юлий', 'юрий', 'яков', 'ян', 'ярослав']\n              ];\n              SexByRussianName.patronymic_completions = [\n                ['овна', 'евна', 'ична'],\n                ['ович', 'евич', 'ич']\n              ];\n\n              SexByRussianName.prototype.get_gender = function() {\n                var genders_on_names = [this.gender_by(SexByRussianName.SURNAME, this.surname),\n                                        this.gender_by_first_name(),\n                                        this.gender_by(SexByRussianName.PATRONYMIC, this.patronymic)];\n\n                var gender = this.determine_gender(genders_on_names)\n\n                return gender;\n              };\n\n\n              SexByRussianName.prototype.determine_gender = function(genders) {\n                var male = false,\n                    female = false,\n                    gender = undefined;\n\n                for (var i=0; i < 3; i++){\n                  if (genders[i] === SexByRussianName.MALE) male = true;\n                  if (genders[i] === SexByRussianName.FEMALE) female = true;\n                }\n\n                if (male && !female) gender = SexByRussianName.MALE;\n                if (!male && female) gender = SexByRussianName.FEMALE;\n\n                return gender;\n              }\n\n\n              SexByRussianName.prototype.gender_by_first_name = function() {\n                var gender = undefined,\n                    first_name = this.normalize(this.first_name);\n\n                if (this.is_popular_name(first_name, SexByRussianName.FEMALE)) gender = SexByRussianName.FEMALE;\n                if (this.is_popular_name(first_name, SexByRussianName.MALE)) gender = SexByRussianName.MALE;\n\n                return gender;\n              }\n\n              SexByRussianName.prototype.gender_by = function(name_type, string) {\n                var gender = undefined,\n                    name = this.normalize(string);\n\n                if (this.is_correct(name, name_type, SexByRussianName.FEMALE)) gender = SexByRussianName.FEMALE;\n                if (this.is_correct(name, name_type, SexByRussianName.MALE)) gender = SexByRussianName.MALE;\n\n                return gender;\n              }\n\n              SexByRussianName.prototype.is_correct = function(string, type, gender) {\n                var is_correct = false,\n                    completions;\n\n                  switch (type){\n                    case SexByRussianName.SURNAME:\n                      completions = SexByRussianName.surname_completions[gender];\n                      break;\n                    case SexByRussianName.PATRONYMIC:\n                      completions = SexByRussianName.patronymic_completions[gender];\n                  }\n\n                for (var i=0; i<completions.length; i++){\n                  var completion = this.completion(string, completions[i].length);\n                  if (completion === completions[i]) is_correct = true;\n                }\n\n                return is_correct;\n              }\n\n              SexByRussianName.prototype.is_popular_name = function(first_name, gender) {\n                var is_popular_name = false,\n                    names = SexByRussianName.names[gender];\n\n                for (var i=0; i<names.length; i++){\n                  if (first_name === names[i]) is_popular_name = true;\n                }\n\n                return is_popular_name;\n              }\n\n              SexByRussianName.prototype.completion = function(string, count){\n                var completion = string.substr((string.length - count), (string.length - 1));\n\n                return completion;\n              }\n\n              SexByRussianName.prototype.normalize = function(string) {\n                var normal_string = string.toLowerCase();\n                normal_string = normal_string.replace(/\\s/g, '');\n\n                return normal_string;\n              }\n\n              return SexByRussianName;\n            })();\n\n            var name = getName(data.r[0].INF_NEW);\n            var sex_by_russian_name = new SexByRussianName(name.S, name.N, name.L);\n            var sex = sex_by_russian_name.get_gender(); // 1 — мужской, 0 — женский, undefined — не определен.\n            if (sex == \"1\") return \"M\";\n            if (sex == \"0\") return \"F\";\n            if (sex == \"undefined\") return \"-\";\n        }\n        return arr[i][\"INF_NEW\"].Sex;\n      }\n  \t}\n  }\n}\n\nfunction getDTS (arr) {\n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i] && arr[i][\"INF_NEW\"].ruFName != \"null\" && arr[i][\"INF_NEW\"].DB != \"null\") {\n        return arr[i][\"INF_NEW\"].DTS;\n      }\n  \t}\n  }\n}\n\nfunction getUnix(dateString){\n\tif (dateString == \"\" || typeof dateString == \"undefined\") {\n  \tvar date = new Date().getTime() + \"\";\n    return date.substr(0, 10);\n  } else {\n  \tvar M = +dateString.substr(5, 2) - 1;\n\t\tvar date = new Date(dateString.substr(0, 4), M, dateString.substr(8, 2)).getTime()+\"\";\n  \treturn date.substr(0, 10);\n  }\n}\n\nfunction getVip (arr) {\n  var VIP = \"N\"; \n  if (Array.isArray(arr)){\n  \tfor (var i=0; i<arr.length; i++) {\n      if (\"INF_NEW\" in arr[i]) {\n        if (arr[i][\"INF_NEW\"].PotentialVIP == \"Y\" || arr[i][\"INF_NEW\"].VipStatus == \"Y\" ) VIP = \"Y\";\n      }\n      if (\"VIP_INF\" in arr[i]) {\n        if (arr[i][\"VIP_INF\"].VipStatus == \"Y\" ) VIP = \"Y\";\n      }\n  \t}\n  }\n  return VIP;\n}\n",
        "outputs": 1,
        "noerr": 0,
        "x": 1940,
        "y": 260,
        "wires": [
            [
                "9af54b4f.9bad68"
            ]
        ]
    },
    {
        "id": "7ad7e10c.6871a",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Готовим запрос",
        "func": "var client_id = msg.client_id;\nmsg.SID = msg.payload;\n\nmsg.payload = {};\nmsg.payload.r = [];\nvar x = {\n    \"type\":\"INF_NEW\",\n    \"cntr\":\"UA\",\n    \"i\":{\n        \"Id\": client_id\n        \n    }, \n    \"t\":{\n        \"returnContact\":\"Y\", \n        \"returnClientAttrs\": \"Y\",\n        \"ReturnFlVip\": \"Y\"\n    },\n    \"sid\": msg.SID,\n    \"o\":[\n        \"ruLName\",\n        \"ruFName\",\n        \"AgentState\",\n        \"ruMName\",\n        \"StrClientID\",\n        \"Lang\",\n        \"Id\",\n        \"PotentialVIP\",\n        \"St\",\n        \"DB\",\n        \"DTS\",\n        \"Sex\"\n        ]\n    \n};\nmsg.payload.r.push(x);\n\nmsg.headers = {};\nmsg.headers[\"Content-type\"] = \"application/json\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1500,
        "y": 260,
        "wires": [
            [
                "ba4a4bfd.da96a8"
            ]
        ]
    },
    {
        "id": "9e8495ec.3adff8",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload.sid = msg.SID;\nmsg.headers = {};\nmsg.headers[\"Authorization\"] = msg.SID;\nmsg.headers[\"Accept\"] = \"application/json\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1530,
        "y": 380,
        "wires": [
            [
                "11a6fd76.4d6863"
            ]
        ]
    },
    {
        "id": "11a6fd76.4d6863",
        "type": "http request",
        "z": "1e3801f3.ffb9ae",
        "name": "Запрос в кошелек",
        "method": "GET",
        "ret": "obj",
        "url": "https://stat.privatbank.ua/stat/api/purse/module/cardsforwave/byekb/{{client_id}}",
        "tls": "",
        "x": 1690,
        "y": 380,
        "wires": [
            [
                "5c2187a6.ab2fc8"
            ]
        ]
    },
    {
        "id": "5c2187a6.ab2fc8",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Поиск карты",
        "func": "if (typeof msg.body != \"object\") msg.body = {}; \nmsg.body.cards = msg.payload;\nmsg.payload = {};\n//запуск:\n// установка текущей даты (формат: мм/гг)\nvar date = new Date();\nvar curMonth = compare(date.getMonth() + 1);\nvar curYear = date.getFullYear().toString().substr(2);\n\nif(Array.isArray(msg.body.cards) && msg.client_status != \"vip\") {\n  \n  msg.payload.prod_arr = product_from_ARR(msg.body.cards);\n  \n  if (msg.payload.prod_arr.length === 0) {\n    \n    var prod_arr_exp = exp_product_from_ARR(msg.body.cards);\n    \n    if (prod_arr_exp.length > 0) {\n      \n      msg.payload.exp_cards = true;\n      msg.payload.prod_arr_exp = prod_arr_exp;\n\n    }\n    \n  }\n  \n  msg.payload.is_GOLD = getFlagGold(msg.body.cards);\n  \n} if(Array.isArray(msg.body.cards) && msg.client_status == \"vip\") {\n  \n  msg.payload.prod_arr = product_from_Vip_ARR(msg.body.cards);\n  \n  if (msg.payload.prod_arr.length > 0) {\n    msg.is_GOLD = \"N\";\n    msg.is_VIP = \"Y\";\n    msg.most_vip = most_vip(msg.payload.prod_arr);\n    \n  } else {\n    msg.payload.prod_arr = product_from_ARR(msg.body.cards);\n  \n  if (msg.payload.prod_arr.length === 0) {\n    \n    var prod_arr_exp = exp_product_from_ARR(msg.body.cards);\n    \n    if (prod_arr_exp.length > 0) {\n      \n      msg.payload.exp_cards = true;\n      msg.payload.prod_arr_exp = prod_arr_exp;\n\n    }\n    \n  }\n  \n  msg.is_GOLD = getFlagGold(msg.body.cards);\n  \n  }\n    \n} else {\n \n msg.payload.description = msg.payload.error;\n msg.payload.err = \"Кошелек\";\n    \n}\n\n\n\nif (Array.isArray(msg.payload.prod_arr) && msg.payload.prod_arr.length > 1) msg.payload.prod_arr = msg.payload.prod_arr.sort(compareLimits);\n\n\n//функции:*/\nfunction compare(a){\n\treturn a<10 ? \"0\"+a : a+\"\";\n}\n\nfunction product_from_ARR(cards) {\n\n  var prod_arr = [];\n  var card = {};\n  var curMonth = compare(date.getMonth() + 1);\n  var curY = date.getFullYear().toString().substr(2);\n\n  for (var i=0; i<cards.length; i++) {\n  \tif (cards[i].product_type==\"KUN\" && +cards[i].currency==980 && cards[i].bank==\"PB\" && cards[i].isCard3rdFace!=\"Y\" && cards[i].contract_state==\"a\" && (cards[i].card_state==\"1\" || cards[i].card_state==\"5\") && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5) && ((cards[i].exdate.substr(0, 2) >= +curMonth && cards[i].exdate.substr(2) == +curY)  || (cards[i].exdate.substr(2) > +curY))) {\n        card = {\n              \"pan\":            cards[i].pan,\n              \"refcontract\":    cards[i].refcontract, \n              \"card_name\":      cards[i].card_name,\n              \"isGold\":         cards[i].isGold,\n              \"balance\":        cards[i].balance,\n              \"card_state\":     cards[i].card_state,\n              \"limit\":          cards[i].credit_limit,\n              \"remain\":         cards[i].remain,\n              \"ledgerbalance\":  cards[i].ledgerbalance,\n              \"exdate\":         cards[i].exdate\n    \t\t};\n        prod_arr.push(card);\n  \t}\n  }\n  \n  return prod_arr;\n}\n\nfunction exp_product_from_ARR(cards) {\n  var prod_arr = [];\n  var card = {};\n  var curMonth = compare(date.getMonth() + 1);\n  var curYear = date.getFullYear().toString().substr(2);\n  \n  for (var i=0; i<cards.length; i++) {\n  \tif (cards[i].product_type==\"KUN\" && +cards[i].currency==980 && cards[i].bank==\"PB\" && cards[i].isCard3rdFace!=\"Y\" && cards[i].contract_state==\"a\" && (cards[i].card_state==\"1\" || cards[i].card_state==\"5\") && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5)) {\n        if ( (+curMonth - (+cards[i].exdate.substr(0, 2)) >= 6 && cards[i].exdate.substr(2) == +curYear) || (+curYear - cards[i].exdate.substr(2) > 0 && (+curMonth + (12 - (+cards[i].exdate.substr(0, 2))) >= 6)) ) {\n        \tmsg.body.isEXPIRED = true;\n        }         \n        card = {\n              \"pan\":            cards[i].pan,\n              \"refcontract\":    cards[i].refcontract, \n              \"card_name\":      cards[i].card_name,\n              \"isGold\":         cards[i].isGold,\n              \"balance\":        cards[i].balance,\n              \"card_state\":     cards[i].card_state,\n              \"limit\":          cards[i].credit_limit,\n              \"remain\":         cards[i].remain,\n              \"ledgerbalance\":  cards[i].ledgerbalance,\n              \"exdate\":         cards[i].exdate\n    \t\t};\n        prod_arr.push(card);\n  \t}\n  }\n  return prod_arr;\n}\n\nfunction compareLimits(a, b) {\n  var A = a.credit_limit;\n  var B = b.credit_limit;\n  \n  return +B - (+A);\n}\n\nfunction getFlagGold(cards) {\n  var prod_arr = [];\n  \n  if (!Array.isArray(cards)) return \"N\";\n  \n  var card = {};\n  var curMonth = compare(date.getMonth() + 1);\n  var cur_Year = date.getFullYear().toString().substr(2);\n  \n  for (var i=0; i<cards.length; i++) {\n        if (cards[i].isGold==\"Y\" && (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5) && ((cards[i].exdate.substr(0, 2) >= +curMonth && cards[i].exdate.substr(2) == +cur_Year)  || (cards[i].exdate.substr(2) > +cur_Year))) {\n        card = {\n              \"pan\":            cards[i].pan,\n              \"refcontract\":    cards[i].refcontract, \n              \"card_name\":      cards[i].card_name,\n              \"isGold\":         cards[i].isGold,\n              \"balance\":        cards[i].balance,\n              \"card_state\":     cards[i].card_state,\n              \"limit\":          cards[i].credit_limit,\n              \"remain\":         cards[i].remain,\n              \"ledgerbalance\":  cards[i].ledgerbalance,\n              \"exdate\":         cards[i].exdate\n    };\n        prod_arr.push(card);\n        }\n  }\n  if (prod_arr.length > 0) return \"Y\";\n  return \"N\";\n}\n\nfunction most_vip(prod_arr) {\n  var most = 0;\n  var most_el;\n\t\n  for (var z=0; z<prod_arr.length; z++) {\n  \tif (prod_arr[z].most_vip > most) {\n   \t\tmost_el = z;\n\t\t}\n\t}\n\treturn most_el;\n}\n\nfunction product_from_Vip_ARR(cards) {\n\tvar prod_arr = [], \n  \tcard = {},\n    prior_1 = [\"FORL\", \"FRE3\", \"EXI2\", \"PPF1\", \"REP1\", \"EXI1\", \"FRE1\", \"FOR1\", \"LOYD\", \"EXID\", \"VIPP\"],\n    prior_2 = [\"VIPE\"],\n    prior_3 = [\"MCWS\", \"MCWL\", \"WS55\", \"WS05\", \"WS0P\", \"WS5P\", \"MCWF\", \"WS00\", \"VIPW\"],\n    prior_4 = [\"INFI\", \"INFA\", \"INFL\", \"INPA\", \"INPI\", \"VIPI\"];\n\n\n\tfor (var i=0; i<cards.length; i++) {\n     if (cards[i].product_type == \"KUN\" && \n     /FORL|FRE3|EXI2|PPF1|REP1|EXI1|FRE1|FOR1|LOYD|EXID|VIPP|VIPE|MCWS|MCWL|WS55|WS05|WS0P|WS5P|MCWF|WS00|VIPW|INFI|INFA|INFL|INPA|INPI|VIPI/.test(cards[i].contract_type) && \n     +cards[i].currency==980 && \n     cards[i].bank==\"PB\" && \n     cards[i].isCard3rdFace==\"N\" && \n     cards[i].contract_state==\"a\" && \n     (cards[i].card_state==\"1\" || cards[i].card_state==\"5\") && \n     (+cards[i].pan.substr(0,1)==4 || +cards[i].pan.substr(0,1)==5) && \n     cards[i].pan.substr(0,9)!=\"545708221\" && \n     ((cards[i].exdate.substr(0, 2) >= +curMonth && cards[i].exdate.substr(2) == +curYear)  || (cards[i].exdate.substr(2) > +curYear)) && \n     cards[i].idekbOwn == cards[i].idEkbPan ) {\n\n        var most_vip;\n        if(prior_4.indexOf(cards[i].contract_type) != -1) {\n          most_vip = 4;\n        } else if(prior_3.indexOf(cards[i].contract_type) != -1) {\n          most_vip = 3;\n        } else if(prior_2.indexOf(cards[i].contract_type) != -1) {\n          most_vip = 2;\n        } else if(prior_1.indexOf(cards[i].contract_type) != -1) {\n          most_vip = 1;\n        }\n\n        card = {\n              \"pan\":                cards[i].pan,\n              \"refcontract\":        cards[i].refcontract, \n              \"card_name\":          cards[i].card_name,\n              \"isGold\":             cards[i].isGold,\n              \"contract_type\":      cards[i].contract_type,\n              \"most_vip\":           most_vip,\n              \"name_en\":            cards[i].card_name_en,\n              \"exdate\":             cards[i].exdate,\n              \"balance\":            cards[i].balance,\n              \"credit_limit\":       cards[i].credit_limit,\n               \"currency\":          cards[i].currency\n   \t\t\t};\n      \tprod_arr.push(card);\n\t\t}\n\t}\n\treturn prod_arr;\n}\n\nmsg.body.creditСards = msg.payload.prod_arr;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1890,
        "y": 380,
        "wires": [
            [
                "e235517f.b9c5d"
            ]
        ]
    },
    {
        "id": "9019b125.7925c",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "формируем ответ на cb_url",
        "func": "var data = msg.payload;\nmsg.payload = data.nrm_solution;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2860,
        "y": 140,
        "wires": [
            [
                "30a0dcc5.9764a4"
            ]
        ]
    },
    {
        "id": "5037af3e.e4538",
        "type": "redis-command",
        "z": "1e3801f3.ffb9ae",
        "server": "ccaa13e5.b3ad3",
        "command": "expire",
        "name": "Зададим время жизни в REDIS ",
        "topic": "0",
        "x": 4750,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "578fd1ac.b516c",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Время жизни",
        "func": "var interval = 86400*30; //время жизни показанной заявки в REDIS \n\nmsg.payload = [msg.client_id, interval];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 4780,
        "y": 680,
        "wires": [
            [
                "5037af3e.e4538"
            ]
        ]
    },
    {
        "id": "3c3acd72.4d05c2",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "Формируем хэш LIMITS",
        "func": "msg.payload = [\"LIMITS\", 10];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 410,
        "y": 1000,
        "wires": [
            [
                "b65ac9d5.59de88"
            ]
        ]
    },
    {
        "id": "b65ac9d5.59de88",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "expire",
        "name": "Зачистить ХЭШ",
        "topic": "0",
        "x": 680,
        "y": 1000,
        "wires": [
            [
                "dd4dfb97.cfdb28"
            ]
        ]
    },
    {
        "id": "ce5675cc.336df8",
        "type": "inject",
        "z": "1cc16612.5125da",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 160,
        "y": 1000,
        "wires": [
            [
                "3c3acd72.4d05c2"
            ]
        ]
    },
    {
        "id": "dd4dfb97.cfdb28",
        "type": "debug",
        "z": "1cc16612.5125da",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 870,
        "y": 1000,
        "wires": []
    },
    {
        "id": "44988db.d831474",
        "type": "comment",
        "z": "1cc16612.5125da",
        "name": "Зачистить ХЭШ информации",
        "info": "",
        "x": 200,
        "y": 940,
        "wires": []
    },
    {
        "id": "a1c2a15b.1ca12",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "Формируем хэш LIMITS",
        "func": "msg.payload = [\"LIMITS\"];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 410,
        "y": 1060,
        "wires": [
            [
                "ece07302.7a491"
            ]
        ]
    },
    {
        "id": "ece07302.7a491",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "hgetall",
        "name": "Проверить ХЭШ",
        "topic": "0",
        "x": 690,
        "y": 1060,
        "wires": [
            [
                "3c68e82a.2a6fd8"
            ]
        ]
    },
    {
        "id": "c43be312.6df3e",
        "type": "inject",
        "z": "1cc16612.5125da",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 160,
        "y": 1060,
        "wires": [
            [
                "a1c2a15b.1ca12"
            ]
        ]
    },
    {
        "id": "3c68e82a.2a6fd8",
        "type": "debug",
        "z": "1cc16612.5125da",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 870,
        "y": 1060,
        "wires": []
    },
    {
        "id": "e693bc87.fb61b",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "3. Проверка ЕКБ",
        "info": "",
        "x": 1500,
        "y": 220,
        "wires": []
    },
    {
        "id": "ed3aa6fe.6fa158",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "5.4 Установим время жизни 30 дней",
        "info": "",
        "x": 4830,
        "y": 640,
        "wires": []
    },
    {
        "id": "5990d0e2.8a5a2",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "5.2 Пропускаем разрешенных",
        "info": "",
        "x": 3550,
        "y": 540,
        "wires": []
    },
    {
        "id": "763d29.ef47b2d8",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "7. Запрос в ср-НРМ ШАГ 2 ",
        "info": "",
        "x": 1280,
        "y": 1220,
        "wires": []
    },
    {
        "id": "6d846486.78690c",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Формируем запрос на СР",
        "func": "msg.data = msg.payload;\n\nmsg.ops = [];\nmsg.ops.push({\n    \"conv_id\": \"209502\",\n    \"ref\": msg.client_id,\n    \"type\": \"create\",\n    \"obj\": \"task\",\n    \"data\": msg.data\n});\n\nmsg.payload = JSON.stringify({\n    \"ops\": msg.ops\n});\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1400,
        "y": 1260,
        "wires": [
            [
                "eb00da34.a08018"
            ]
        ]
    },
    {
        "id": "eb00da34.a08018",
        "type": "http request",
        "z": "1e3801f3.ffb9ae",
        "name": "Запрос в ср-НРМ ШАГ 2",
        "method": "POST",
        "ret": "obj",
        "paytoqs": false,
        "url": "https://cp.privatbank.ua/api/1/json/public/209502/cd2377df076fd7bec9a979d71cfd87bbd7c0603e",
        "tls": "",
        "proxy": "",
        "authType": "",
        "x": 1650,
        "y": 1260,
        "wires": [
            []
        ]
    },
    {
        "id": "3b825836.5ab068",
        "type": "http in",
        "z": "1e3801f3.ffb9ae",
        "name": "callback from cp-NRM ШАГ 1",
        "url": "/setNrmStep2",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 1920,
        "y": 1260,
        "wires": [
            [
                "4e93dc9.eab5824",
                "9942ffa7.c7c47"
            ]
        ]
    },
    {
        "id": "59af3522.59c85c",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "7.1. Получим ответ от ср-НРМ ШАГ 2",
        "info": "",
        "x": 1950,
        "y": 1200,
        "wires": []
    },
    {
        "id": "3127a775.c9e868",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "error",
        "property": "source",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "error",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 510,
        "y": 260,
        "wires": [
            [
                "36bd2ea0.dbf8e2"
            ]
        ]
    },
    {
        "id": "36bd2ea0.dbf8e2",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload = {\n    \"status\": \"error\",\n    \"description\": \"Неверный источник\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 630,
        "y": 260,
        "wires": [
            [
                "3b0b8795.d503b8"
            ]
        ]
    },
    {
        "id": "3b0b8795.d503b8",
        "type": "http response",
        "z": "1e3801f3.ffb9ae",
        "name": "Некорректные данные",
        "statusCode": "200",
        "headers": {},
        "x": 810,
        "y": 260,
        "wires": []
    },
    {
        "id": "3f679e9c.20bf42",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Поиск ",
        "func": "msg.payload = [msg.client_id];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 550,
        "y": 1040,
        "wires": [
            [
                "31ae57fe.8f02e8"
            ]
        ]
    },
    {
        "id": "31ae57fe.8f02e8",
        "type": "redis-command",
        "z": "1e3801f3.ffb9ae",
        "server": "ccaa13e5.b3ad3",
        "command": "get",
        "name": "в REDIS",
        "topic": "0",
        "x": 680,
        "y": 1040,
        "wires": [
            [
                "5b66ccac.029e74"
            ]
        ]
    },
    {
        "id": "5b66ccac.029e74",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Проверка рез.",
        "func": "if (msg.payload === null) {\n    msg.havePermission = \"false\";\n} else {\n    //разберем ответ от редиса {\"ref\":\"12243729REF\",\"limUP\":\"Y\",\"newlimit\":\"50000\",\"source\":\"3700\",\"startTime\":1572362519057, \"endTime\": 1572559140000, isWatched: \"Y\", isUped: \"N\"}\" показали и не изменили\n    //разберем ответ от редиса {\"ref\":\"12243729REF\",\"limUP\":\"Y\",\"newlimit\":\"50000\",\"source\":\"3700\",\"startTime\":1572362519057, \"endTime\": 1572559140000, isWatched: \"Y\", isUped: \"Y\"}\" показали и изменили\n\n    var payload = JSON.parse(msg.payload);\n    msg.REDIS = payload;\n    var time = new Date().getTime();\n    \n    if (msg.REDIS.limUP == \"Y\" && +msg.newlimit <= +msg.REDIS.newlimit && time <= msg.REDIS.endTime) {\n       msg.havePermission = \"true\"; \n    } else {\n        msg.havePermission = \"false\";\n    }\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 840,
        "y": 1040,
        "wires": [
            [
                "30da24b4.f43afc",
                "78a36226.c6dc6c"
            ]
        ]
    },
    {
        "id": "30da24b4.f43afc",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "Разрешили ",
        "property": "havePermission",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1030,
        "y": 1100,
        "wires": [
            [
                "60f0d849.4e8378",
                "65cc878c.fd0cd8"
            ]
        ]
    },
    {
        "id": "78a36226.c6dc6c",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "Нет разрешения",
        "property": "havePermission",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "false",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 1050,
        "y": 1040,
        "wires": [
            [
                "fac49836.3587a8"
            ]
        ]
    },
    {
        "id": "b944b1cd.cdf8b",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "for (var k in msg.payload) {\n    msg[k] = msg.payload[k];\n}\n\nif (typeof msg.pan == \"undefined\" || !/^[0-9]{16}$/.test(msg.pan)) {\n    msg.error = \"true\";\n} else if (typeof msg.refcontract == \"undefined\" || !/^SAMDN[0-9 A-Z]{14}/.test(msg.refcontract)) {\n    msg.error = \"true\";\n} else if (typeof msg.newlimit == \"undefined\") {\n    msg.error = \"true\";\n} else if (typeof msg.oldlim == \"undefined\") {\n    msg.error = \"true\";\n} else {\n    msg.error = \"false\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 290,
        "y": 1040,
        "wires": [
            [
                "20e49d7b.bea9e2"
            ]
        ]
    },
    {
        "id": "30bb0385.d6794c",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "6.1. Проверяем было ли разрешение ",
        "info": "",
        "x": 510,
        "y": 980,
        "wires": []
    },
    {
        "id": "ec3c63af.f5513",
        "type": "http response",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1340,
        "y": 1040,
        "wires": []
    },
    {
        "id": "fac49836.3587a8",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload = {\n    \"status\": \"error\",\n    \"description\": \"Нет разрешения ШАГ 1\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 1040,
        "wires": [
            [
                "ec3c63af.f5513"
            ]
        ]
    },
    {
        "id": "60f0d849.4e8378",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload = {\n    \"status\": \"ok\",\n    \"description\": \"Приняли заявку на увеличение лимита\"\n};\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 1100,
        "wires": [
            [
                "d251ad3d.5f15"
            ]
        ]
    },
    {
        "id": "d251ad3d.5f15",
        "type": "http response",
        "z": "1e3801f3.ffb9ae",
        "name": "Есть разрешение",
        "statusCode": "200",
        "headers": {},
        "x": 1370,
        "y": 1100,
        "wires": []
    },
    {
        "id": "4e93dc9.eab5824",
        "type": "http response",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 2140,
        "y": 1260,
        "wires": []
    },
    {
        "id": "9942ffa7.c7c47",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "разберем ответ НРМ",
        "func": "var data = msg.payload;\n\nmsg.statusUP = data.statusUP;\nmsg.NEW_LIM = data.NEW_LIM;\nmsg.mode_lim = data.mode_lim;\nmsg.client_id = data.client_id;\nmsg.pan = data.pan;\nmsg.refcontract = data.refcontract;\nmsg.limit = data.oldlim;\nmsg.newlimit = data.newlimit;\nmsg.src = data.src;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2180,
        "y": 1300,
        "wires": [
            [
                "29ffb125.d058be",
                "5a577270.832d9c"
            ]
        ]
    },
    {
        "id": "29ffb125.d058be",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "Повысили",
        "property": "statusUP",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2390,
        "y": 1360,
        "wires": [
            [
                "87dc817e.76ed2",
                "6c6f6ee1.ccf47"
            ]
        ]
    },
    {
        "id": "5a577270.832d9c",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "Ошибка",
        "property": "statusUP",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "error",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 2380,
        "y": 1300,
        "wires": [
            []
        ]
    },
    {
        "id": "fa6c20d5.8ec8f",
        "type": "redis-command",
        "z": "1e197245.dfdf2e",
        "server": "ccaa13e5.b3ad3",
        "command": "set",
        "name": "Запишем в REDIS ",
        "topic": "0",
        "x": 1470,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "ac9fdb16.1757d8",
        "type": "function",
        "z": "1e197245.dfdf2e",
        "name": "Формируем заявку",
        "func": "var body = msg.payload;\n\nmsg.payload = [\"SID\", body.SID];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1270,
        "y": 520,
        "wires": [
            [
                "fa6c20d5.8ec8f",
                "9c3bcded.45da8"
            ]
        ]
    },
    {
        "id": "c5c8d8b.91f2428",
        "type": "function",
        "z": "1e197245.dfdf2e",
        "name": "запрос sid",
        "func": "msg.payload = [\"SID\"];\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 60,
        "wires": [
            [
                "8620953.6072e68"
            ]
        ]
    },
    {
        "id": "8620953.6072e68",
        "type": "redis-command",
        "z": "1e197245.dfdf2e",
        "server": "ccaa13e5.b3ad3",
        "command": "get",
        "name": "getSID",
        "topic": "0",
        "x": 490,
        "y": 60,
        "wires": [
            [
                "ac8cee4d.d0405"
            ]
        ]
    },
    {
        "id": "ac8cee4d.d0405",
        "type": "function",
        "z": "1e197245.dfdf2e",
        "name": "Активная сессия",
        "func": "msg.value = msg.payload ;\n\nif (typeof msg.value === \"undefined\") global.set(\"body\").SID = \"190830csb26uzzfo9zee\"; \n\nmsg.headers = {\n    \"Content-Type\": \"application/json;charset=UTF-8\",\n    \"Accept\": \"application/json;charset=UTF-8\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 650,
        "y": 60,
        "wires": [
            [
                "bb2c889e.af0908"
            ]
        ]
    },
    {
        "id": "bd0ca75.c692358",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Запрос sid",
        "func": "msg.payload = [\"SID\"];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1210,
        "y": 260,
        "wires": [
            [
                "991f5c7c.0335d"
            ]
        ]
    },
    {
        "id": "991f5c7c.0335d",
        "type": "redis-command",
        "z": "1e3801f3.ffb9ae",
        "server": "ccaa13e5.b3ad3",
        "command": "get",
        "name": "getSID",
        "topic": "0",
        "x": 1350,
        "y": 260,
        "wires": [
            [
                "7ad7e10c.6871a"
            ]
        ]
    },
    {
        "id": "20e49d7b.bea9e2",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "property": "error",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "false",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 420,
        "y": 1040,
        "wires": [
            [
                "3f679e9c.20bf42"
            ],
            [
                "3cd65fb3.7d7a2"
            ]
        ]
    },
    {
        "id": "bf3428d3.664d28",
        "type": "http response",
        "z": "1e3801f3.ffb9ae",
        "name": "Не все параметры",
        "statusCode": "200",
        "headers": {},
        "x": 710,
        "y": 1100,
        "wires": []
    },
    {
        "id": "3cd65fb3.7d7a2",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload = {\n    \"status\": \"error\",\n    \"description\": \"Не переданы обязательные параметры\"\n};\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 550,
        "y": 1100,
        "wires": [
            [
                "bf3428d3.664d28"
            ]
        ]
    },
    {
        "id": "52044ab8.37f754",
        "type": "debug",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 2370,
        "y": 1240,
        "wires": []
    },
    {
        "id": "2a1b3b9d.0356b4",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "property": "inRedis",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "false",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 4170,
        "y": 580,
        "wires": [
            [
                "bbfdf57f.afc768"
            ],
            [
                "db66e44.6380e18"
            ]
        ]
    },
    {
        "id": "6f9afda9.008bc4",
        "type": "redis-command",
        "z": "1e3801f3.ffb9ae",
        "server": "ccaa13e5.b3ad3",
        "command": "get",
        "name": "",
        "topic": "0",
        "x": 3820,
        "y": 580,
        "wires": [
            [
                "75026d8a.2284a4"
            ]
        ]
    },
    {
        "id": "43941e56.c5ced",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload = [msg.client_id];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 3690,
        "y": 580,
        "wires": [
            [
                "6f9afda9.008bc4"
            ]
        ]
    },
    {
        "id": "db66e44.6380e18",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Формируем перезапись",
        "func": "var obj = JSON.parse(msg.payload);\n\nobj.ref = msg.nrm_ref, //реф заявки \nobj.limUP = msg.limUP, //разрешено ли увеличение\nobj.newlimit = msg.newlimit, //новый лимит\nobj.endTime = new Date().getTime() + (86400000*30) //время смерти заявки\n \n\nobj[msg.source] = {\n    \"startTime\": new Date().getTime(),  //время показа заявки в канале\n    \"endTime\": getEndDayTime(),         //время паузы \n    \"isWatched\": \"Y\",                   //флаг показа\n    \"isUped\": \"N\"                       //флаг увеличения после показа\n};\n\nmsg.payload = [msg.client_id, JSON.stringify(obj)];\n\n\nreturn msg;\n\n\n\nfunction getEndDayTime() {\n  var date = new Date();\n  return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 0).getTime();\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 4350,
        "y": 620,
        "wires": [
            [
                "a46c8a13.4c81c8"
            ]
        ]
    },
    {
        "id": "3644420a.d8fe8e",
        "type": "debug",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 4550,
        "y": 620,
        "wires": []
    },
    {
        "id": "75026d8a.2284a4",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Запись/Перезапись",
        "func": "if (msg.payload === null) {\n  msg.inRedis = \"false\";\n} else {\n    msg.inRedis = \"true\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 4000,
        "y": 580,
        "wires": [
            [
                "2a1b3b9d.0356b4"
            ]
        ]
    },
    {
        "id": "587de5ff.39679c",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "Формируем перезапись",
        "func": "var obj = JSON.parse(msg.payload);\n\nvar newObj = obj[msg.src] || {};\n\nnewObj.isUped = \"Y\";     //флаг увеличения после показа\n\nobj[msg.src] = newObj;\n\nmsg.payload = [msg.client_id, JSON.stringify(obj)];\n\n\nreturn msg;\n\n\n\nfunction getEndDayTime() {\n  var date = new Date();\n  return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 0).getTime();\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2890,
        "y": 1460,
        "wires": [
            [
                "16bd6b02.5c4e85"
            ]
        ]
    },
    {
        "id": "16bd6b02.5c4e85",
        "type": "redis-command",
        "z": "1e3801f3.ffb9ae",
        "server": "ccaa13e5.b3ad3",
        "command": "set",
        "name": "Запишем в REDIS ",
        "topic": "0",
        "x": 3130,
        "y": 1460,
        "wires": [
            []
        ]
    },
    {
        "id": "92d232d3.eb1",
        "type": "debug",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 3090,
        "y": 1420,
        "wires": []
    },
    {
        "id": "86f1a33e.0714d",
        "type": "redis-command",
        "z": "1e3801f3.ffb9ae",
        "server": "ccaa13e5.b3ad3",
        "command": "get",
        "name": "",
        "topic": "0",
        "x": 2680,
        "y": 1460,
        "wires": [
            [
                "587de5ff.39679c"
            ]
        ]
    },
    {
        "id": "6c6f6ee1.ccf47",
        "type": "function",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "func": "msg.payload = [msg.client_id];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 2530,
        "y": 1460,
        "wires": [
            [
                "86f1a33e.0714d"
            ]
        ]
    },
    {
        "id": "2033a858.42afd8",
        "type": "comment",
        "z": "1e3801f3.ffb9ae",
        "name": "11. Запись в REDIS - повысили",
        "info": "",
        "x": 2610,
        "y": 1420,
        "wires": []
    },
    {
        "id": "4cb47277.55ac9c",
        "type": "switch",
        "z": "1e3801f3.ffb9ae",
        "name": "toRedis",
        "property": "toRedis",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "false",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 520,
        "y": 200,
        "wires": [
            [
                "3fcebe4b.19c442",
                "47bf38df.92fd18"
            ],
            [
                "3fcebe4b.19c442",
                "bd0ca75.c692358"
            ]
        ]
    },
    {
        "id": "f18b69e3.0f26a8",
        "type": "debug",
        "z": "1e3801f3.ffb9ae",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1590,
        "y": 1200,
        "wires": []
    },
    {
        "id": "513aee26.b2756",
        "type": "comment",
        "z": "1cc16612.5125da",
        "name": "Проверим REDIS ",
        "info": "",
        "x": 170,
        "y": 1180,
        "wires": []
    },
    {
        "id": "91bb27dc.cbb4b8",
        "type": "inject",
        "z": "1cc16612.5125da",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 160,
        "y": 1240,
        "wires": [
            [
                "416d8504.96ebac"
            ]
        ]
    },
    {
        "id": "416d8504.96ebac",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "Запросим все ключи REDIS",
        "func": "msg.payload = [\"*\"];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 380,
        "y": 1240,
        "wires": [
            [
                "f3354847.d3d078"
            ]
        ]
    },
    {
        "id": "f3354847.d3d078",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "keys",
        "name": "Заберем все ключи",
        "topic": "0",
        "x": 620,
        "y": 1240,
        "wires": [
            [
                "b04c0604.78d898"
            ]
        ]
    },
    {
        "id": "b04c0604.78d898",
        "type": "debug",
        "z": "1cc16612.5125da",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 810,
        "y": 1240,
        "wires": []
    },
    {
        "id": "fa210b72.b6a838",
        "type": "inject",
        "z": "1cc16612.5125da",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 160,
        "y": 1280,
        "wires": [
            [
                "6a136041.927d1"
            ]
        ]
    },
    {
        "id": "6a136041.927d1",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "Запрос удаления",
        "func": "msg.payload = [\"7206221\"];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 350,
        "y": 1280,
        "wires": [
            [
                "7833efd0.8b65d"
            ]
        ]
    },
    {
        "id": "7833efd0.8b65d",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "del",
        "name": "Удалим ключ в REDIS ",
        "topic": "0",
        "x": 620,
        "y": 1280,
        "wires": [
            [
                "19be9818.227e78"
            ]
        ]
    },
    {
        "id": "19be9818.227e78",
        "type": "debug",
        "z": "1cc16612.5125da",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 810,
        "y": 1280,
        "wires": []
    },
    {
        "id": "a95c4791.f8a4d8",
        "type": "inject",
        "z": "1cc16612.5125da",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 160,
        "y": 1320,
        "wires": [
            [
                "998b2653.39b7e8"
            ]
        ]
    },
    {
        "id": "998b2653.39b7e8",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "Запросим ключ REDIS",
        "func": "msg.payload = [\"12243729\"];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 370,
        "y": 1320,
        "wires": [
            [
                "cbc05ff6.628c9"
            ]
        ]
    },
    {
        "id": "cbc05ff6.628c9",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "get",
        "name": "Заберем все ключи",
        "topic": "0",
        "x": 620,
        "y": 1320,
        "wires": [
            [
                "a92cbe32.fe66a"
            ]
        ]
    },
    {
        "id": "7bbf7054.6c825",
        "type": "debug",
        "z": "1cc16612.5125da",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "x": 930,
        "y": 1320,
        "wires": []
    },
    {
        "id": "a92cbe32.fe66a",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "",
        "func": "msg.payload = JSON.parse(msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 800,
        "y": 1320,
        "wires": [
            [
                "7bbf7054.6c825"
            ]
        ]
    },
    {
        "id": "41019927.e37aa8",
        "type": "inject",
        "z": "1cc16612.5125da",
        "name": "",
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "x": 160,
        "y": 1400,
        "wires": [
            [
                "5749537f.70b77c"
            ]
        ]
    },
    {
        "id": "5749537f.70b77c",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "",
        "func": "msg.nrm_ref = \"12243729REF\";\nmsg.limUP = \"Y\";\nmsg.newlimit = \"50000\";\nmsg.source = \"P24WEB\";\nmsg.client_id = \"12243729\";\nmsg.isWatched = \"Y\";\nmsg.isUped = \"N\";\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 310,
        "y": 1400,
        "wires": [
            [
                "ea3a400e.1c9af"
            ]
        ]
    },
    {
        "id": "ba700f58.b72c5",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "set",
        "name": "Запишем в REDIS ",
        "topic": "0",
        "x": 1350,
        "y": 1400,
        "wires": [
            []
        ]
    },
    {
        "id": "ea3a400e.1c9af",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "",
        "func": "msg.payload = [msg.client_id];\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 430,
        "y": 1400,
        "wires": [
            [
                "984c1990.74b198"
            ]
        ]
    },
    {
        "id": "984c1990.74b198",
        "type": "redis-command",
        "z": "1cc16612.5125da",
        "server": "ccaa13e5.b3ad3",
        "command": "get",
        "name": "",
        "topic": "0",
        "x": 580,
        "y": 1400,
        "wires": [
            [
                "ee779738.1577d8"
            ]
        ]
    },
    {
        "id": "ee779738.1577d8",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "Запись/Перезапись",
        "func": "if (msg.payload === null) {\n  msg.inRedis = \"false\";\n} else {\n    msg.inRedis = \"true\";\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 760,
        "y": 1400,
        "wires": [
            [
                "baefad99.ed407"
            ]
        ]
    },
    {
        "id": "baefad99.ed407",
        "type": "switch",
        "z": "1cc16612.5125da",
        "name": "",
        "property": "inRedis",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "false",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "true",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 930,
        "y": 1400,
        "wires": [
            [
                "59e17a1b.98f434"
            ],
            [
                "62aa7f03.e707a"
            ]
        ]
    },
    {
        "id": "59e17a1b.98f434",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "Формируем первую запись",
        "func": "var obj = {\n    \"ref\": msg.nrm_ref, //реф заявки \n    \"limUP\": msg.limUP, //разрешено ли увеличение\n    \"newlimit\": msg.newlimit, //новый лимит\n    \"endTime\": new Date().getTime() + (86400000*30) //время смерти заявки\n}; \n\nobj[msg.source] = {\n    \"startTime\": new Date().getTime(),  //время показа заявки в канале\n    \"endTime\": getEndDayTime(),         //время паузы \n    \"isWatched\": \"Y\",                   //флаг показа\n    \"isUped\": \"N\"                       //флаг увеличения после показа\n};\n\nmsg.payload = [msg.client_id, JSON.stringify(obj)];\n\n\nreturn msg;\n\n\n\nfunction getEndDayTime() {\n  var date = new Date();\n  return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 0).getTime();\n}",
        "outputs": 1,
        "noerr": 0,
        "x": 1120,
        "y": 1360,
        "wires": [
            [
                "ba700f58.b72c5"
            ]
        ]
    },
    {
        "id": "62aa7f03.e707a",
        "type": "function",
        "z": "1cc16612.5125da",
        "name": "Формируем перезапись",
        "func": "var obj = JSON.parse(msg.payload);\n\nobj.ref = msg.nrm_ref, //реф заявки \nobj.limUP = msg.limUP, //разрешено ли увеличение\nobj.newlimit = msg.newlimit, //новый лимит\nobj.endTime = new Date().getTime() + (86400000*30) //время смерти заявки\n \n\nobj[msg.source] = {\n    \"startTime\": new Date().getTime(),  //время показа заявки в канале\n    \"endTime\": getEndDayTime(),         //время паузы \n    \"isWatched\": \"Y\",                   //флаг показа\n    \"isUped\": \"N\"                       //флаг увеличения после показа\n};\n\nmsg.payload = [msg.client_id, JSON.stringify(obj)];\n\n\nreturn msg;\n\n\n\nfunction getEndDayTime() {\n  var date = new Date();\n  return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 0).getTime();\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "x": 1110,
        "y": 1440,
        "wires": [
            [
                "ba700f58.b72c5"
            ]
        ]
    },
    {
        "id": "b82e1450.9d2fe8",
        "type": "http in",
        "z": "3e6d7003.49c1e",
        "name": "callback for tests",
        "url": "/cbURL",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 1000,
        "y": 440,
        "wires": [
            [
                "3b51f442.7ff64c",
                "9b857c32.5a35a"
            ]
        ]
    },
    {
        "id": "3b51f442.7ff64c",
        "type": "debug",
        "z": "3e6d7003.49c1e",
        "name": "",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "x": 1170,
        "y": 440,
        "wires": []
    },
    {
        "id": "9b857c32.5a35a",
        "type": "http response",
        "z": "3e6d7003.49c1e",
        "name": "",
        "statusCode": "200",
        "headers": {},
        "x": 1180,
        "y": 400,
        "wires": []
    },
    {
        "id": "3ead813d.b4047e",
        "type": "comment",
        "z": "3e6d7003.49c1e",
        "name": "Ловим ответ ШАГ_1",
        "info": "",
        "x": 1010,
        "y": 400,
        "wires": []
    }
]
